{"version":3,"file":"index.cjs","sources":["../../../../packages/php-wasm/util/src/lib/sleep.ts","../../../../packages/php-wasm/util/src/lib/semaphore.ts","../../../../packages/php-wasm/util/src/lib/php-wasm-error.ts","../../../../packages/php-wasm/util/src/lib/paths.ts","../../../../packages/php-wasm/util/src/lib/event-emitter-polyfill.ts","../../../../packages/php-wasm/util/src/lib/split-shell-command.ts","../../../../packages/php-wasm/util/src/lib/writable-polyfill.ts","../../../../packages/php-wasm/util/src/lib/create-spawn-handler.ts","../../../../packages/php-wasm/util/src/lib/random-string.ts","../../../../packages/php-wasm/util/src/lib/random-filename.ts","../../../../packages/php-wasm/util/src/lib/php-vars.ts","../../../../packages/php-wasm/util/src/lib/sprintf.ts","../../../../packages/php-wasm/util/src/lib/promised.ts","../../../../packages/php-wasm/util/src/lib/index.ts"],"sourcesContent":["export const SleepFinished = Symbol('SleepFinished');\n\nexport function sleep(ms: number): Promise<typeof SleepFinished> {\n\treturn new Promise((resolve) => {\n\t\tsetTimeout(() => resolve(SleepFinished), ms);\n\t});\n}\n","import { SleepFinished, sleep } from './sleep';\n\nexport interface SemaphoreOptions {\n\t/**\n\t * The maximum number of concurrent locks.\n\t */\n\tconcurrency: number;\n\t/**\n\t * The maximum time to wait for a lock to become available.\n\t */\n\ttimeout?: number;\n}\n\nexport class AcquireTimeoutError extends Error {\n\tconstructor() {\n\t\tsuper('Acquiring lock timed out');\n\t}\n}\n\nexport default class Semaphore {\n\tprivate _running = 0;\n\tprivate concurrency: number;\n\tprivate timeout?: number;\n\tprivate queue: (() => void)[];\n\n\tconstructor({ concurrency, timeout }: SemaphoreOptions) {\n\t\tthis.concurrency = concurrency;\n\t\tthis.timeout = timeout;\n\t\tthis.queue = [];\n\t}\n\n\tget remaining(): number {\n\t\treturn this.concurrency - this.running;\n\t}\n\n\tget running(): number {\n\t\treturn this._running;\n\t}\n\n\tasync acquire(): Promise<() => void> {\n\t\twhile (true) {\n\t\t\tif (this._running >= this.concurrency) {\n\t\t\t\t// Concurrency exhausted â€“ wait until a lock is released:\n\t\t\t\tconst acquired = new Promise<void>((resolve) => {\n\t\t\t\t\tthis.queue.push(resolve);\n\t\t\t\t});\n\t\t\t\tif (this.timeout !== undefined) {\n\t\t\t\t\tawait Promise.race([acquired, sleep(this.timeout)]).then(\n\t\t\t\t\t\t(value) => {\n\t\t\t\t\t\t\tif (value === SleepFinished) {\n\t\t\t\t\t\t\t\tthrow new AcquireTimeoutError();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tawait acquired;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Acquire the lock:\n\t\t\t\tthis._running++;\n\t\t\t\tlet released = false;\n\t\t\t\treturn () => {\n\t\t\t\t\tif (released) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\treleased = true;\n\t\t\t\t\tthis._running--;\n\t\t\t\t\t// Release the lock:\n\t\t\t\t\tif (this.queue.length > 0) {\n\t\t\t\t\t\tthis.queue.shift()!();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run<T>(fn: () => T | Promise<T>): Promise<T> {\n\t\tconst release = await this.acquire();\n\t\ttry {\n\t\t\treturn await fn();\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n}\n","export class PhpWasmError extends Error {\n\tuserFriendlyMessage?: string;\n\tconstructor(message: string, userFriendlyMessage?: string) {\n\t\tsuper(message);\n\t\tthis.userFriendlyMessage = userFriendlyMessage ?? message;\n\t}\n}\n","/**\n * The functions in this module are mostly copied from the generated\n * Emscripten PHP module. This enables features like filesystem journaling,\n * which use some low-level Emscripten APIs and need access to the\n * same path helpers.\n */\n\n/**\n * Joins paths together.\n *\n * For example:\n *\n * > joinPaths('wordpress', 'wp-content')\n * 'wordpress/wp-content'\n *\n * Use this for all PHP paths and **do not** use path.join().\n * This is important because Emscripten paths are **always**\n * POSIX-style paths. Imagine joining paths on Windows:\n *\n * > path.join('wordpress', 'wp-content')\n * '\\\\wordpress\\\\wp-content'  // invalid in PHP.wasm\n *\n * See the path.join issue for more details:\n *\n * https://github.com/WordPress/playground-tools/issues/11#issuecomment-1579074763\n *\n * @param paths Paths segments to join\n * @returns A joined path\n */\nexport function joinPaths(...paths: string[]) {\n\tfunction hasTrailingSlash(p: string) {\n\t\treturn p.substring(p.length - 1) === '/';\n\t}\n\n\tlet path = paths.join('/');\n\tconst isAbsolute = path[0] === '/';\n\tconst trailingSlash = hasTrailingSlash(path);\n\tpath = normalizePath(path);\n\tif (!path && !isAbsolute) {\n\t\tpath = '.';\n\t}\n\tif (path && trailingSlash && !hasTrailingSlash(path)) {\n\t\tpath += '/';\n\t}\n\treturn path;\n}\n\n/**\n * Returns the directory name of a path.\n *\n * @param path\n * @returns\n */\nexport function dirname(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn '';\n\t} else if (lastSlash === 0) {\n\t\treturn '/';\n\t}\n\treturn path.substr(0, lastSlash);\n}\n\n/**\n * Returns the last portion of a path.\n *\n * @param path - The path to extract the basename from.\n * @returns The basename of the path.\n */\nexport function basename(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn path;\n\t}\n\treturn path.substr(lastSlash + 1);\n}\n\n/**\n * Normalizes a path.\n *\n * For example:\n *\n * > normalizePath('wordpress/wp-content/../')\n * 'wordpress'\n *\n * @param path\n * @returns\n */\nexport function normalizePath(path: string) {\n\tconst isAbsolute = path[0] === '/';\n\tpath = normalizePathsArray(\n\t\tpath.split('/').filter((p: any) => !!p),\n\t\t!isAbsolute\n\t).join('/');\n\treturn (isAbsolute ? '/' : '') + path.replace(/\\/$/, '');\n}\n\n/**\n * Normalizes paths.\n *\n * For example:\n *\n * > normalizePathsArray(['wordpress', 'wp-content', '..', '', '.',\n * 'wp-includes']) ['wordpress', 'wp-includes']\n *\n * @param parts parts of the path to normalize\n * @param allowAboveRoot allow paths above the root\n * @returns normalized paths\n */\nexport function normalizePathsArray(parts: string[], allowAboveRoot: boolean) {\n\tlet up = 0;\n\tfor (let i = parts.length - 1; i >= 0; i--) {\n\t\tconst last = parts[i];\n\t\tif (last === '.') {\n\t\t\tparts.splice(i, 1);\n\t\t} else if (last === '..') {\n\t\t\tparts.splice(i, 1);\n\t\t\tup++;\n\t\t} else if (up) {\n\t\t\tparts.splice(i, 1);\n\t\t\tup--;\n\t\t}\n\t}\n\tif (allowAboveRoot) {\n\t\tfor (; up; up--) {\n\t\t\tparts.unshift('..');\n\t\t}\n\t}\n\treturn parts;\n}\n\n/**\n * Checks if the given parent path is an ancestor of the given child path.\n *\n * @param parent The parent path to check.\n * @param child The child path to verify against the parent.\n * @returns Whether the `parent` path is an ancestor of the `child` path.\n */\nexport function isParentOf(parent: string, child: string) {\n\tif (parent === '/') {\n\t\treturn true;\n\t}\n\tparent = normalizePath(parent);\n\tchild = normalizePath(child);\n\treturn child.startsWith(parent + '/') || child === parent;\n}\n\n/**\n * Guarantees a path is absolute by prepending `/` if needed.\n *\n * Useful when working with user-provided paths that might be relative,\n * or when you need to normalize edge cases like empty strings.\n *\n * For example:\n *\n * > ensureAbsolutePath('wp-content/uploads')\n * '/wp-content/uploads'\n *\n * > ensureAbsolutePath('/already/absolute')\n * '/already/absolute'\n *\n * > ensureAbsolutePath('')\n * '/'\n *\n * @param path - The path to make absolute.\n * @returns An absolute, normalized path starting with `/`.\n */\nexport function ensureAbsolutePath(path: string) {\n\treturn joinPaths('/', normalizePath(path || '/'));\n}\n","/**\n * Polyfills Node.js EventEmitter API. The main goal is to enable\n * using a child_process.spawn()-like API in both Node.js and the browser.\n *\n * @see https://nodejs.org/api/events.html#events_class_eventemitter\n */\ntype Listener = (...args: any[]) => any;\n\nexport class EventEmitterPolyfill {\n\tlisteners: Record<string, Listener[]> = {};\n\temit(eventName: string, data?: any) {\n\t\tif (this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName].forEach(function (listener) {\n\t\t\t\tlistener(data);\n\t\t\t});\n\t\t}\n\t}\n\ton(eventName: string, listener: Listener) {\n\t\tif (!this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName] = [];\n\t\t}\n\t\tthis.listeners[eventName].push(listener);\n\t}\n\tonce(eventName: string, listener: Listener) {\n\t\tconst wrappedListener = (...args: any[]) => {\n\t\t\tthis.off(eventName, wrappedListener);\n\t\t\tlistener(...args);\n\t\t};\n\t\tthis.on(eventName, wrappedListener);\n\t}\n\toff(eventName: string, listener: Listener) {\n\t\tif (this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName] = this.listeners[eventName].filter(\n\t\t\t\t(l) => l !== listener\n\t\t\t);\n\t\t}\n\t}\n}\n","/**\n * Naive shell command parser.\n * Ensures that commands like `wp option set blogname \"My blog name\"` are split\n * into `['wp', 'option', 'set', 'blogname', 'My blog name']` instead of\n * `['wp', 'option', 'set', 'blogname', 'My', 'blog', 'name']`.\n *\n * @param command\n * @returns\n */\nexport function splitShellCommand(command: string) {\n\tconst MODE_UNQUOTED = 0;\n\tconst MODE_IN_QUOTE = 1;\n\n\tlet mode = MODE_UNQUOTED;\n\tlet quote = '';\n\n\tconst parts: string[] = [];\n\tlet currentPart = '';\n\tfor (let i = 0; i < command.length; i++) {\n\t\tconst char = command[i];\n\t\tif (char === '\\\\') {\n\t\t\t// Escaped quotes are treated as normal characters\n\t\t\t// This is a very naive approach to escaping, but it's good enough for\n\t\t\t// now. @TODO: Iterate on this later, perhaps using bun shell. @see https://github.com/WordPress/wordpress-playground/issues/1062\n\t\t\tif (command[i + 1] === '\"' || command[i + 1] === \"'\") {\n\t\t\t\ti++;\n\t\t\t}\n\t\t\tcurrentPart += command[i];\n\t\t} else if (mode === MODE_UNQUOTED) {\n\t\t\tif (char === '\"' || char === \"'\") {\n\t\t\t\tmode = MODE_IN_QUOTE;\n\t\t\t\tquote = char;\n\t\t\t} else if (char.match(/\\s/)) {\n\t\t\t\tif (currentPart.trim().length) {\n\t\t\t\t\tparts.push(currentPart.trim());\n\t\t\t\t}\n\t\t\t\tcurrentPart = char;\n\t\t\t} else if (parts.length && !currentPart) {\n\t\t\t\t// We just closed a quote to continue the same\n\t\t\t\t// argument with different escaping style, e.g.:\n\t\t\t\t// php -r 'require '\\''vendor/autoload.php'\\''\n\t\t\t\tcurrentPart = parts.pop()! + char;\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t} else if (mode === MODE_IN_QUOTE) {\n\t\t\tif (char === quote) {\n\t\t\t\tmode = MODE_UNQUOTED;\n\t\t\t\tquote = '';\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t}\n\t}\n\tif (currentPart) {\n\t\tparts.push(currentPart.trim());\n\t}\n\treturn parts;\n}\n","/**\n * Polyfills Node.js WritableStream API. The main goal is to enable\n * using a child_process.spawn()-like API in both Node.js and the browser.\n *\n * @see https://nodejs.org/api/stream.html#stream_writable_end_chunk_encoding_callback\n */\nimport { EventEmitterPolyfill } from './event-emitter-polyfill';\n\nexport interface WritableOptions {\n\thighWaterMark?: number;\n\tdecodeStrings?: boolean;\n\tdefaultEncoding?: BufferEncoding;\n\twrite: (chunk: any, encoding: BufferEncoding, cb: WriteCallback) => void;\n}\n\nexport type WriteCallback = (error?: Error | null) => void;\n\nexport class WritablePolyfill extends EventEmitterPolyfill {\n\tprivate buffer: Array<{\n\t\tchunk: any;\n\t\tencoding: BufferEncoding;\n\t\tcb: WriteCallback;\n\t}> = [];\n\tprivate writing = false;\n\tpublic ended = false;\n\tprivate length = 0;\n\tprivate highWaterMark: number;\n\tprivate decodeStrings: boolean;\n\tprivate defaultEncoding: BufferEncoding;\n\tprivate defer: (fn: () => void) => void;\n\tprivate _write: (\n\t\tchunk: any,\n\t\tencoding: BufferEncoding,\n\t\tcb: WriteCallback\n\t) => void;\n\n\tconstructor(opts: WritableOptions) {\n\t\tsuper();\n\t\tif (!opts.write) {\n\t\t\tthrow new Error('WritablePolyfill requires write option');\n\t\t}\n\t\tthis._write = opts.write;\n\t\tthis.highWaterMark = opts.highWaterMark ?? 16 * 1024;\n\t\tthis.decodeStrings = opts.decodeStrings ?? true;\n\t\tthis.defaultEncoding = opts.defaultEncoding ?? 'utf8';\n\t\t// queueMicrotask keeps browser support; fallback for older environments.\n\t\tthis.defer =\n\t\t\ttypeof queueMicrotask === 'function'\n\t\t\t\t? queueMicrotask\n\t\t\t\t: (fn) => setTimeout(fn, 0);\n\t}\n\n\twrite(\n\t\tchunk: any,\n\t\tencoding: BufferEncoding | WriteCallback = this.defaultEncoding,\n\t\tcb: WriteCallback = () => {}\n\t): boolean {\n\t\tif (typeof encoding === 'function') {\n\t\t\tcb = encoding as WriteCallback;\n\t\t\tencoding = this.defaultEncoding;\n\t\t}\n\n\t\tif (this.ended) {\n\t\t\tconst err = new Error('write after end');\n\t\t\t// We can't call this.defer() directly. If this.defer is\n\t\t\t// `queueMicrotask`, a `this.defer()` call will pass the\n\t\t\t// WritablePolyfill instance as `this` argument and cause\n\t\t\t// the browser to throw an error similar to \"Invalid\n\t\t\t// invocation\".\n\t\t\tconst defer = this.defer;\n\t\t\tdefer(() => cb(err));\n\t\t\tthis.emit('error', err);\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.decodeStrings && typeof chunk === 'string') {\n\t\t\tif (\n\t\t\t\ttypeof Buffer !== 'undefined' &&\n\t\t\t\ttypeof (Buffer as any).from === 'function'\n\t\t\t) {\n\t\t\t\tchunk = Buffer.from(chunk, encoding as BufferEncoding);\n\t\t\t} else if (typeof TextEncoder !== 'undefined') {\n\t\t\t\tchunk = new TextEncoder().encode(chunk);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'String chunks are not supported in this environment: Buffer and TextEncoder are unavailable.'\n\t\t\t\t);\n\t\t\t}\n\t\t\tencoding = 'buffer' as BufferEncoding;\n\t\t}\n\n\t\tthis.length += chunk.length ?? 1;\n\t\tconst needDrain = this.length >= this.highWaterMark;\n\n\t\tthis.buffer.push({ chunk, encoding: encoding as BufferEncoding, cb });\n\n\t\tif (!this.writing) this._clearBuffer();\n\n\t\treturn !needDrain;\n\t}\n\n\tend(\n\t\tchunk?: any,\n\t\tencoding?: BufferEncoding | WriteCallback,\n\t\tcb?: WriteCallback\n\t): void {\n\t\tif (typeof chunk === 'function') {\n\t\t\tcb = chunk;\n\t\t\tchunk = undefined;\n\t\t} else if (typeof encoding === 'function') {\n\t\t\tcb = encoding as WriteCallback;\n\t\t\tencoding = undefined;\n\t\t}\n\n\t\tif (chunk !== undefined)\n\t\t\tthis.write(chunk, encoding as BufferEncoding, () => {});\n\t\tthis.ended = true;\n\t\tif (!this.writing) this._clearBuffer();\n\t\tif (cb) this.defer(cb);\n\t}\n\n\t// Stubs kept for API parity; add logic if you depend on corking.\n\tcork(): void {}\n\tuncork(): void {}\n\n\tsetDefaultEncoding(enc: BufferEncoding): this {\n\t\tthis.defaultEncoding = enc;\n\t\treturn this;\n\t}\n\n\tprivate _clearBuffer(): void {\n\t\tconst entry = this.buffer.shift();\n\t\tif (!entry) {\n\t\t\tif (this.ended) this.emit('finish');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.writing = true;\n\t\tthis._write(entry.chunk, entry.encoding, (err?: Error | null) => {\n\t\t\tthis.writing = false;\n\t\t\tthis.length -= entry.chunk.length ?? 1;\n\t\t\tif (err) this.emit('error', err);\n\t\t\tentry.cb(err);\n\n\t\t\tif (this.buffer.length) {\n\t\t\t\tthis._clearBuffer();\n\t\t\t} else {\n\t\t\t\tif (this.length < this.highWaterMark) this.emit('drain');\n\t\t\t\tif (this.ended) this.emit('finish');\n\t\t\t}\n\t\t});\n\t}\n}\n","import { EventEmitterPolyfill } from './event-emitter-polyfill';\nimport { splitShellCommand } from './split-shell-command';\nimport { WritablePolyfill, type WriteCallback } from './writable-polyfill';\n\ntype Listener = (...args: any[]) => any;\n\nexport interface ProcessOptions {\n\tcwd?: string;\n\tenv?: Record<string, string>;\n}\n\n/**\n * Usage:\n * ```ts\n * php.setSpawnHandler(\n *   createSpawnHandler(function (command, processApi) {\n *     console.log(processApi.flushStdin());\n *     processApi.stdout('/\\n/tmp\\n/home');\n *\t   processApi.exit(0);\n *   })\n * );\n * ```\n * @param program\n * @returns\n */\nexport function createSpawnHandler(\n\tprogram: (\n\t\tcommand: string[],\n\t\tprocessApi: ProcessApi,\n\t\toptions: ProcessOptions\n\t) => void | Promise<void>\n): any {\n\treturn function (\n\t\tcommand: string | string[],\n\t\targsArray: string[] = [],\n\t\toptions: ProcessOptions = {}\n\t) {\n\t\tconst childProcess = new ChildProcess();\n\t\tconst processApi = new ProcessApi(childProcess);\n\t\t// Give PHP a chance to register listeners\n\t\tsetTimeout(async () => {\n\t\t\tlet commandArray = [];\n\t\t\tif (argsArray.length) {\n\t\t\t\tcommandArray = [command as string, ...argsArray];\n\t\t\t} else if (typeof command === 'string') {\n\t\t\t\tcommandArray = splitShellCommand(command);\n\t\t\t} else if (Array.isArray(command)) {\n\t\t\t\tcommandArray = command;\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid command ', command);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tconst promise = program(commandArray, processApi, options);\n\t\t\t\tif (\n\t\t\t\t\ttypeof promise !== 'object' ||\n\t\t\t\t\tpromise === null ||\n\t\t\t\t\t!('then' in promise)\n\t\t\t\t) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`The program callback passed to createSpawnHandler() did not return a promise. It indicates there's a bug in your code. ` +\n\t\t\t\t\t\t\t`The callback must return a promise. PHP cannot interact with program that synchronously exists at the end of the proc_open() ` +\n\t\t\t\t\t\t\t`call. All the streams would be closed already. Make sure to put an \"await new Promise(resolve => setTimeout(resolve, 1))` +\n\t\t\t\t\t\t\t`before calling processApi.exit(0) in your callback to let PHP catch up with the stdout data.`\n\t\t\t\t\t);\n\t\t\t\t} else if (processApi.exited) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`The program callback passed to createSpawnHandler() exited synchronously. It indicates there's a bug in your code. ` +\n\t\t\t\t\t\t\t`The callback must return a promise. PHP cannot interact with program that synchronously exists at the end of the proc_open() ` +\n\t\t\t\t\t\t\t`call. All the streams would be closed already. Make sure to put an \"await new Promise(resolve => setTimeout(resolve, 1))` +\n\t\t\t\t\t\t\t`before calling processApi.exit(0) in your callback to let PHP catch up with the stdout data.`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tchildProcess.emit('spawn', true);\n\t\t\t\tawait promise;\n\t\t\t} catch (e) {\n\t\t\t\tchildProcess.emit('error', e);\n\t\t\t\tif (\n\t\t\t\t\ttypeof e === 'object' &&\n\t\t\t\t\te !== null &&\n\t\t\t\t\t'message' in e &&\n\t\t\t\t\ttypeof e.message === 'string'\n\t\t\t\t) {\n\t\t\t\t\tprocessApi.stderr(e.message);\n\t\t\t\t}\n\t\t\t\tprocessApi.exit(1);\n\t\t\t}\n\t\t});\n\t\treturn childProcess;\n\t};\n}\n\nexport class ProcessApi extends EventEmitterPolyfill {\n\tpublic exited = false;\n\t/**\n\t * Keeps track of the data that was written to stdin before the\n\t * first listener was registered.\n\t */\n\tprivate stdinBuffer: Uint8Array[] | null = [];\n\tpublic childProcess: ChildProcess;\n\tconstructor(childProcess: ChildProcess) {\n\t\tsuper();\n\t\tthis.childProcess = childProcess;\n\t\tchildProcess.on('stdin', (data: Uint8Array) => {\n\t\t\tif (this.stdinBuffer) {\n\t\t\t\t// Need to clone the data buffer as it's reused by PHP\n\t\t\t\t// and the next data chunk will overwrite the previous one.\n\t\t\t\tthis.stdinBuffer.push(data.slice());\n\t\t\t} else {\n\t\t\t\tthis.emit('stdin', data);\n\t\t\t}\n\t\t});\n\t}\n\tstdinEnd() {\n\t\tif (!this.childProcess.stdin.ended) {\n\t\t\tthis.childProcess.stdin.end();\n\t\t}\n\t}\n\tstdout(data: string | ArrayBuffer) {\n\t\tthis.childProcess.stdout.write(data);\n\t}\n\tstdoutEnd() {\n\t\tif (!this.childProcess.stdout.ended) {\n\t\t\tthis.childProcess.stdout.end();\n\t\t}\n\t}\n\tstderr(data: string | ArrayBuffer) {\n\t\tthis.childProcess.stderr.write(data);\n\t}\n\tstderrEnd() {\n\t\tif (!this.childProcess.stderr.ended) {\n\t\t\tthis.childProcess.stderr.end();\n\t\t}\n\t}\n\tnotifySpawn() {\n\t\tthis.childProcess.emit('spawn', true);\n\t}\n\texit(code: number) {\n\t\tif (!this.exited) {\n\t\t\tthis.exited = true;\n\t\t\tthis.stdinEnd();\n\t\t\tthis.stdoutEnd();\n\t\t\tthis.stderrEnd();\n\t\t\tthis.childProcess.emit('exit', code);\n\t\t}\n\t}\n\toverride on(eventName: string, listener: Listener) {\n\t\tsuper.on(eventName, listener);\n\t\t/**\n\t\t * If it's the first stdin listener, flush all the data we've\n\t\t * buffered so far.\n\t\t */\n\t\tif (eventName === 'stdin' && this.stdinBuffer) {\n\t\t\tfor (let i = 0; i < this.stdinBuffer.length; i++) {\n\t\t\t\tthis.emit('stdin', this.stdinBuffer[i]);\n\t\t\t}\n\t\t\tthis.stdinBuffer = null;\n\t\t}\n\t}\n}\n\nlet lastPid = 9743;\nexport class ChildProcess extends EventEmitterPolyfill {\n\tstdout: WritablePolyfill;\n\tstderr: WritablePolyfill;\n\tstdin: WritablePolyfill;\n\tpid: number;\n\tconstructor(pid = lastPid++) {\n\t\tsuper();\n\t\tthis.pid = pid;\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\n\t\tconst self = this;\n\t\tthis.stdout = new WritablePolyfill({\n\t\t\twrite(data: any, encoding: BufferEncoding, cb: WriteCallback) {\n\t\t\t\tself.stdout.emit('data', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t\tthis.stderr = new WritablePolyfill({\n\t\t\twrite: (data: any, encoding: BufferEncoding, cb: WriteCallback) => {\n\t\t\t\tself.stderr.emit('data', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t\tthis.stdin = new WritablePolyfill({\n\t\t\twrite: (data: any, encoding: BufferEncoding, cb: WriteCallback) => {\n\t\t\t\tself.emit('stdin', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t}\n}\n","export function randomString(\n\tlength = 36,\n\tspecialChars = '!@#$%^&*()_+=-[]/.,<>?'\n) {\n\tconst chars =\n\t\t'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' +\n\t\tspecialChars;\n\tlet result = '';\n\tfor (let i = length; i > 0; --i)\n\t\tresult += chars[Math.floor(Math.random() * chars.length)];\n\treturn result;\n}\n","import { randomString } from './random-string';\n\nexport function randomFilename() {\n\treturn randomString(36, '-_');\n}\n","export function phpVar(value: unknown): string {\n\treturn `json_decode(base64_decode('${stringToBase64(\n\t\tJSON.stringify(value)\n\t)}'), true)`;\n}\n\nexport function phpVars<T extends Record<string, unknown>>(\n\tvars: T\n): Record<keyof T, string> {\n\tconst result: Record<string, string> = {};\n\tfor (const key in vars) {\n\t\tresult[key] = phpVar(vars[key]);\n\t}\n\treturn result as Record<keyof T, string>;\n}\n\nfunction stringToBase64(str: string) {\n\treturn bytesToBase64(new TextEncoder().encode(str));\n}\n\nfunction bytesToBase64(bytes: Uint8Array) {\n\tconst binString = String.fromCodePoint(...bytes);\n\treturn btoa(binString);\n}\n","/**\n * Formats a string like sprintf().\n *\n * This function:\n * - Supports basic format specifiers: %s, %d, %f, %x, %%\n * - Supports bigint values\n *\n * The purpose of this function is for use in optional php-wasm tracing.\n * If we use printf-style formatting for trace messages, we let the trace\n * function decide whether to format and do not have to pay for formatting\n * unless tracing is enabled.\n */\nexport function sprintf(format: string, ...args: any[]): string {\n\tlet result = '';\n\tlet argIndex = 0;\n\n\tfor (let i = 0; i < format.length; i++) {\n\t\tif (format[i] === '%' && i + 1 < format.length) {\n\t\t\ti++;\n\t\t\tconst specifier = format[i];\n\n\t\t\tswitch (specifier) {\n\t\t\t\tcase 's': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tlet str;\n\t\t\t\t\tif (typeof arg === 'object') {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// If an object doesn't provide its own toString(),\n\t\t\t\t\t\t\t// try to represent it as JSON.\n\t\t\t\t\t\t\tstr = JSON.stringify(\n\t\t\t\t\t\t\t\targ,\n\t\t\t\t\t\t\t\t// Represent bigint values as strings in JSON.stringify().\n\t\t\t\t\t\t\t\t(key, value) => {\n\t\t\t\t\t\t\t\t\tif (typeof value === 'bigint') {\n\t\t\t\t\t\t\t\t\t\treturn `0x${value.toString(16)}`;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn value;\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Ignore error and use default representation.\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tstr = String(arg);\n\t\t\t\t\t}\n\n\t\t\t\t\tresult += str;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'd': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += arg.toString();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Math.floor(Number(arg));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'f': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += Number(arg);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Number(arg);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'x': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += arg.toString(16);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Math.floor(Number(arg)).toString(16);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase '%': {\n\t\t\t\t\tresult += '%';\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tresult += '%' + specifier;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tresult += format[i];\n\t\t}\n\t}\n\n\treturn result;\n}\n","// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\ntype PromisedMethod<T extends (...args: any[]) => any> = (\n\t...args: Parameters<T>\n) => Promise<ReturnType<T>>;\n\nexport type Promised<T> = {\n\t[P in keyof T]: T[P] extends (...args: any[]) => any\n\t\t? PromisedMethod<T[P]>\n\t\t: T[P];\n};\n\n/**\n * Wraps a synchronous interface as a promised interface.\n *\n * This function tries to avoid wrapping methods inherited from\n * built-in JS object types (e.g., `Object`, `Array`, `Function`, etc.).\n *\n * The initial use case for this function is for unit testing\n * file locking in php-wasm. Php-wasm for JSPI expects the file lock manager\n * to be a promised interface used via comlink,\n * but the interface itself is synchronous.\n *\n * @param obj\n * @returns A promised interface that wraps the synchronous interface.\n */\nexport function wrapSynchronousInterfaceAsPromised<T extends object>(\n\tobj: T\n): Promised<T> {\n\tconst keysAlreadySeen = new Set<string | symbol>();\n\tconst keysToMakePromised = new Set<string | symbol>();\n\tconst looksLikeBuiltInObject =\n\t\t// NOTE: We don't generally add custom things to the global scope,\n\t\t// so let's use this as a heuristic to determine if an object is a built-in object type.\n\t\t(obj: object) =>\n\t\t\t(globalThis as any)[obj.constructor.name] !== obj.constructor;\n\n\tlet proto: object = obj;\n\twhile (proto !== null && !looksLikeBuiltInObject(proto)) {\n\t\tconst allKeys = [\n\t\t\t...Object.getOwnPropertyNames(proto),\n\t\t\t...Object.getOwnPropertySymbols(proto),\n\t\t];\n\t\tfor (const key of allKeys) {\n\t\t\tif (\n\t\t\t\t// Track keys already seen so an inherited method property\n\t\t\t\t// masked by a descendant property of the same name is not considered.\n\t\t\t\t!keysAlreadySeen.has(key) &&\n\t\t\t\t!keysToMakePromised.has(key) &&\n\t\t\t\ttypeof (proto as any)[key] === 'function'\n\t\t\t) {\n\t\t\t\tkeysToMakePromised.add(key);\n\t\t\t}\n\t\t\tkeysAlreadySeen.add(key);\n\t\t}\n\t\tproto = Object.getPrototypeOf(proto);\n\t}\n\n\t// NOTE: We could use Proxy here instead,\n\t// but providing a regular object is ultimately simpler.\n\tconst promisifiedObj = Object.create(obj);\n\tfor (const key of keysToMakePromised) {\n\t\tpromisifiedObj[key] = function (...args: any[]) {\n\t\t\treturn Promise.resolve((obj as any)[key](...args));\n\t\t};\n\t}\n\treturn promisifiedObj;\n}\n","import Semaphore, { AcquireTimeoutError } from './semaphore';\nexport { Semaphore, AcquireTimeoutError };\nexport { PhpWasmError } from './php-wasm-error';\nexport type { SemaphoreOptions } from './semaphore';\nexport {\n\tdirname,\n\tjoinPaths,\n\tbasename,\n\tnormalizePath,\n\tisParentOf,\n\tensureAbsolutePath,\n} from './paths';\nexport { createSpawnHandler } from './create-spawn-handler';\nexport { randomString } from './random-string';\nexport { randomFilename } from './random-filename';\nexport { splitShellCommand } from './split-shell-command';\nexport { WritablePolyfill, type WritableOptions } from './writable-polyfill';\nexport { EventEmitterPolyfill } from './event-emitter-polyfill';\nexport * from './php-vars';\n\nexport * from './sprintf';\n\nexport function concatUint8Arrays(arrays: Uint8Array[]): Uint8Array {\n\tlet totalLength = 0;\n\tarrays.forEach((a) => (totalLength += a.length));\n\tconst result = new Uint8Array(totalLength);\n\tlet offset = 0;\n\tarrays.forEach((a) => {\n\t\tresult.set(a, offset);\n\t\toffset += a.length;\n\t});\n\treturn result;\n}\n\nexport function concatArrayBuffers(buffers: ArrayBuffer[]): ArrayBuffer {\n\treturn concatUint8Arrays(buffers.map((b) => new Uint8Array(b)))\n\t\t.buffer as ArrayBuffer;\n}\n\nexport * from './promised';\n"],"names":["SleepFinished","sleep","ms","resolve","AcquireTimeoutError","Semaphore","concurrency","timeout","acquired","value","released","fn","release","PhpWasmError","message","userFriendlyMessage","joinPaths","paths","hasTrailingSlash","p","path","isAbsolute","trailingSlash","normalizePath","dirname","lastSlash","basename","normalizePathsArray","parts","allowAboveRoot","up","i","last","isParentOf","parent","child","ensureAbsolutePath","EventEmitterPolyfill","eventName","data","listener","wrappedListener","args","l","splitShellCommand","command","mode","quote","currentPart","char","WritablePolyfill","opts","chunk","encoding","cb","err","defer","needDrain","enc","entry","createSpawnHandler","program","argsArray","options","childProcess","ChildProcess","processApi","ProcessApi","commandArray","promise","e","code","lastPid","pid","self","randomString","length","specialChars","chars","result","randomFilename","phpVar","stringToBase64","phpVars","vars","key","str","bytesToBase64","bytes","binString","sprintf","format","argIndex","specifier","arg","wrapSynchronousInterfaceAsPromised","obj","keysAlreadySeen","keysToMakePromised","looksLikeBuiltInObject","proto","allKeys","promisifiedObj","concatUint8Arrays","arrays","totalLength","a","offset","concatArrayBuffers","buffers","b"],"mappings":"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"}