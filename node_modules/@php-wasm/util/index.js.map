{"version":3,"file":"index.js","sources":["../../../../packages/php-wasm/util/src/lib/sleep.ts","../../../../packages/php-wasm/util/src/lib/semaphore.ts","../../../../packages/php-wasm/util/src/lib/php-wasm-error.ts","../../../../packages/php-wasm/util/src/lib/paths.ts","../../../../packages/php-wasm/util/src/lib/event-emitter-polyfill.ts","../../../../packages/php-wasm/util/src/lib/split-shell-command.ts","../../../../packages/php-wasm/util/src/lib/writable-polyfill.ts","../../../../packages/php-wasm/util/src/lib/create-spawn-handler.ts","../../../../packages/php-wasm/util/src/lib/random-string.ts","../../../../packages/php-wasm/util/src/lib/random-filename.ts","../../../../packages/php-wasm/util/src/lib/php-vars.ts","../../../../packages/php-wasm/util/src/lib/sprintf.ts","../../../../packages/php-wasm/util/src/lib/promised.ts","../../../../packages/php-wasm/util/src/lib/index.ts"],"sourcesContent":["export const SleepFinished = Symbol('SleepFinished');\n\nexport function sleep(ms: number): Promise<typeof SleepFinished> {\n\treturn new Promise((resolve) => {\n\t\tsetTimeout(() => resolve(SleepFinished), ms);\n\t});\n}\n","import { SleepFinished, sleep } from './sleep';\n\nexport interface SemaphoreOptions {\n\t/**\n\t * The maximum number of concurrent locks.\n\t */\n\tconcurrency: number;\n\t/**\n\t * The maximum time to wait for a lock to become available.\n\t */\n\ttimeout?: number;\n}\n\nexport class AcquireTimeoutError extends Error {\n\tconstructor() {\n\t\tsuper('Acquiring lock timed out');\n\t}\n}\n\nexport default class Semaphore {\n\tprivate _running = 0;\n\tprivate concurrency: number;\n\tprivate timeout?: number;\n\tprivate queue: (() => void)[];\n\n\tconstructor({ concurrency, timeout }: SemaphoreOptions) {\n\t\tthis.concurrency = concurrency;\n\t\tthis.timeout = timeout;\n\t\tthis.queue = [];\n\t}\n\n\tget remaining(): number {\n\t\treturn this.concurrency - this.running;\n\t}\n\n\tget running(): number {\n\t\treturn this._running;\n\t}\n\n\tasync acquire(): Promise<() => void> {\n\t\twhile (true) {\n\t\t\tif (this._running >= this.concurrency) {\n\t\t\t\t// Concurrency exhausted â€“ wait until a lock is released:\n\t\t\t\tconst acquired = new Promise<void>((resolve) => {\n\t\t\t\t\tthis.queue.push(resolve);\n\t\t\t\t});\n\t\t\t\tif (this.timeout !== undefined) {\n\t\t\t\t\tawait Promise.race([acquired, sleep(this.timeout)]).then(\n\t\t\t\t\t\t(value) => {\n\t\t\t\t\t\t\tif (value === SleepFinished) {\n\t\t\t\t\t\t\t\tthrow new AcquireTimeoutError();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\tawait acquired;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Acquire the lock:\n\t\t\t\tthis._running++;\n\t\t\t\tlet released = false;\n\t\t\t\treturn () => {\n\t\t\t\t\tif (released) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\treleased = true;\n\t\t\t\t\tthis._running--;\n\t\t\t\t\t// Release the lock:\n\t\t\t\t\tif (this.queue.length > 0) {\n\t\t\t\t\t\tthis.queue.shift()!();\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n\n\tasync run<T>(fn: () => T | Promise<T>): Promise<T> {\n\t\tconst release = await this.acquire();\n\t\ttry {\n\t\t\treturn await fn();\n\t\t} finally {\n\t\t\trelease();\n\t\t}\n\t}\n}\n","export class PhpWasmError extends Error {\n\tuserFriendlyMessage?: string;\n\tconstructor(message: string, userFriendlyMessage?: string) {\n\t\tsuper(message);\n\t\tthis.userFriendlyMessage = userFriendlyMessage ?? message;\n\t}\n}\n","/**\n * The functions in this module are mostly copied from the generated\n * Emscripten PHP module. This enables features like filesystem journaling,\n * which use some low-level Emscripten APIs and need access to the\n * same path helpers.\n */\n\n/**\n * Joins paths together.\n *\n * For example:\n *\n * > joinPaths('wordpress', 'wp-content')\n * 'wordpress/wp-content'\n *\n * Use this for all PHP paths and **do not** use path.join().\n * This is important because Emscripten paths are **always**\n * POSIX-style paths. Imagine joining paths on Windows:\n *\n * > path.join('wordpress', 'wp-content')\n * '\\\\wordpress\\\\wp-content'  // invalid in PHP.wasm\n *\n * See the path.join issue for more details:\n *\n * https://github.com/WordPress/playground-tools/issues/11#issuecomment-1579074763\n *\n * @param paths Paths segments to join\n * @returns A joined path\n */\nexport function joinPaths(...paths: string[]) {\n\tfunction hasTrailingSlash(p: string) {\n\t\treturn p.substring(p.length - 1) === '/';\n\t}\n\n\tlet path = paths.join('/');\n\tconst isAbsolute = path[0] === '/';\n\tconst trailingSlash = hasTrailingSlash(path);\n\tpath = normalizePath(path);\n\tif (!path && !isAbsolute) {\n\t\tpath = '.';\n\t}\n\tif (path && trailingSlash && !hasTrailingSlash(path)) {\n\t\tpath += '/';\n\t}\n\treturn path;\n}\n\n/**\n * Returns the directory name of a path.\n *\n * @param path\n * @returns\n */\nexport function dirname(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn '';\n\t} else if (lastSlash === 0) {\n\t\treturn '/';\n\t}\n\treturn path.substr(0, lastSlash);\n}\n\n/**\n * Returns the last portion of a path.\n *\n * @param path - The path to extract the basename from.\n * @returns The basename of the path.\n */\nexport function basename(path: string) {\n\tif (path === '/') {\n\t\treturn '/';\n\t}\n\n\tpath = normalizePath(path);\n\n\tconst lastSlash = path.lastIndexOf('/');\n\tif (lastSlash === -1) {\n\t\treturn path;\n\t}\n\treturn path.substr(lastSlash + 1);\n}\n\n/**\n * Normalizes a path.\n *\n * For example:\n *\n * > normalizePath('wordpress/wp-content/../')\n * 'wordpress'\n *\n * @param path\n * @returns\n */\nexport function normalizePath(path: string) {\n\tconst isAbsolute = path[0] === '/';\n\tpath = normalizePathsArray(\n\t\tpath.split('/').filter((p: any) => !!p),\n\t\t!isAbsolute\n\t).join('/');\n\treturn (isAbsolute ? '/' : '') + path.replace(/\\/$/, '');\n}\n\n/**\n * Normalizes paths.\n *\n * For example:\n *\n * > normalizePathsArray(['wordpress', 'wp-content', '..', '', '.',\n * 'wp-includes']) ['wordpress', 'wp-includes']\n *\n * @param parts parts of the path to normalize\n * @param allowAboveRoot allow paths above the root\n * @returns normalized paths\n */\nexport function normalizePathsArray(parts: string[], allowAboveRoot: boolean) {\n\tlet up = 0;\n\tfor (let i = parts.length - 1; i >= 0; i--) {\n\t\tconst last = parts[i];\n\t\tif (last === '.') {\n\t\t\tparts.splice(i, 1);\n\t\t} else if (last === '..') {\n\t\t\tparts.splice(i, 1);\n\t\t\tup++;\n\t\t} else if (up) {\n\t\t\tparts.splice(i, 1);\n\t\t\tup--;\n\t\t}\n\t}\n\tif (allowAboveRoot) {\n\t\tfor (; up; up--) {\n\t\t\tparts.unshift('..');\n\t\t}\n\t}\n\treturn parts;\n}\n\n/**\n * Checks if the given parent path is an ancestor of the given child path.\n *\n * @param parent The parent path to check.\n * @param child The child path to verify against the parent.\n * @returns Whether the `parent` path is an ancestor of the `child` path.\n */\nexport function isParentOf(parent: string, child: string) {\n\tif (parent === '/') {\n\t\treturn true;\n\t}\n\tparent = normalizePath(parent);\n\tchild = normalizePath(child);\n\treturn child.startsWith(parent + '/') || child === parent;\n}\n\n/**\n * Guarantees a path is absolute by prepending `/` if needed.\n *\n * Useful when working with user-provided paths that might be relative,\n * or when you need to normalize edge cases like empty strings.\n *\n * For example:\n *\n * > ensureAbsolutePath('wp-content/uploads')\n * '/wp-content/uploads'\n *\n * > ensureAbsolutePath('/already/absolute')\n * '/already/absolute'\n *\n * > ensureAbsolutePath('')\n * '/'\n *\n * @param path - The path to make absolute.\n * @returns An absolute, normalized path starting with `/`.\n */\nexport function ensureAbsolutePath(path: string) {\n\treturn joinPaths('/', normalizePath(path || '/'));\n}\n","/**\n * Polyfills Node.js EventEmitter API. The main goal is to enable\n * using a child_process.spawn()-like API in both Node.js and the browser.\n *\n * @see https://nodejs.org/api/events.html#events_class_eventemitter\n */\ntype Listener = (...args: any[]) => any;\n\nexport class EventEmitterPolyfill {\n\tlisteners: Record<string, Listener[]> = {};\n\temit(eventName: string, data?: any) {\n\t\tif (this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName].forEach(function (listener) {\n\t\t\t\tlistener(data);\n\t\t\t});\n\t\t}\n\t}\n\ton(eventName: string, listener: Listener) {\n\t\tif (!this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName] = [];\n\t\t}\n\t\tthis.listeners[eventName].push(listener);\n\t}\n\tonce(eventName: string, listener: Listener) {\n\t\tconst wrappedListener = (...args: any[]) => {\n\t\t\tthis.off(eventName, wrappedListener);\n\t\t\tlistener(...args);\n\t\t};\n\t\tthis.on(eventName, wrappedListener);\n\t}\n\toff(eventName: string, listener: Listener) {\n\t\tif (this.listeners[eventName]) {\n\t\t\tthis.listeners[eventName] = this.listeners[eventName].filter(\n\t\t\t\t(l) => l !== listener\n\t\t\t);\n\t\t}\n\t}\n}\n","/**\n * Naive shell command parser.\n * Ensures that commands like `wp option set blogname \"My blog name\"` are split\n * into `['wp', 'option', 'set', 'blogname', 'My blog name']` instead of\n * `['wp', 'option', 'set', 'blogname', 'My', 'blog', 'name']`.\n *\n * @param command\n * @returns\n */\nexport function splitShellCommand(command: string) {\n\tconst MODE_UNQUOTED = 0;\n\tconst MODE_IN_QUOTE = 1;\n\n\tlet mode = MODE_UNQUOTED;\n\tlet quote = '';\n\n\tconst parts: string[] = [];\n\tlet currentPart = '';\n\tfor (let i = 0; i < command.length; i++) {\n\t\tconst char = command[i];\n\t\tif (char === '\\\\') {\n\t\t\t// Escaped quotes are treated as normal characters\n\t\t\t// This is a very naive approach to escaping, but it's good enough for\n\t\t\t// now. @TODO: Iterate on this later, perhaps using bun shell. @see https://github.com/WordPress/wordpress-playground/issues/1062\n\t\t\tif (command[i + 1] === '\"' || command[i + 1] === \"'\") {\n\t\t\t\ti++;\n\t\t\t}\n\t\t\tcurrentPart += command[i];\n\t\t} else if (mode === MODE_UNQUOTED) {\n\t\t\tif (char === '\"' || char === \"'\") {\n\t\t\t\tmode = MODE_IN_QUOTE;\n\t\t\t\tquote = char;\n\t\t\t} else if (char.match(/\\s/)) {\n\t\t\t\tif (currentPart.trim().length) {\n\t\t\t\t\tparts.push(currentPart.trim());\n\t\t\t\t}\n\t\t\t\tcurrentPart = char;\n\t\t\t} else if (parts.length && !currentPart) {\n\t\t\t\t// We just closed a quote to continue the same\n\t\t\t\t// argument with different escaping style, e.g.:\n\t\t\t\t// php -r 'require '\\''vendor/autoload.php'\\''\n\t\t\t\tcurrentPart = parts.pop()! + char;\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t} else if (mode === MODE_IN_QUOTE) {\n\t\t\tif (char === quote) {\n\t\t\t\tmode = MODE_UNQUOTED;\n\t\t\t\tquote = '';\n\t\t\t} else {\n\t\t\t\tcurrentPart += char;\n\t\t\t}\n\t\t}\n\t}\n\tif (currentPart) {\n\t\tparts.push(currentPart.trim());\n\t}\n\treturn parts;\n}\n","/**\n * Polyfills Node.js WritableStream API. The main goal is to enable\n * using a child_process.spawn()-like API in both Node.js and the browser.\n *\n * @see https://nodejs.org/api/stream.html#stream_writable_end_chunk_encoding_callback\n */\nimport { EventEmitterPolyfill } from './event-emitter-polyfill';\n\nexport interface WritableOptions {\n\thighWaterMark?: number;\n\tdecodeStrings?: boolean;\n\tdefaultEncoding?: BufferEncoding;\n\twrite: (chunk: any, encoding: BufferEncoding, cb: WriteCallback) => void;\n}\n\nexport type WriteCallback = (error?: Error | null) => void;\n\nexport class WritablePolyfill extends EventEmitterPolyfill {\n\tprivate buffer: Array<{\n\t\tchunk: any;\n\t\tencoding: BufferEncoding;\n\t\tcb: WriteCallback;\n\t}> = [];\n\tprivate writing = false;\n\tpublic ended = false;\n\tprivate length = 0;\n\tprivate highWaterMark: number;\n\tprivate decodeStrings: boolean;\n\tprivate defaultEncoding: BufferEncoding;\n\tprivate defer: (fn: () => void) => void;\n\tprivate _write: (\n\t\tchunk: any,\n\t\tencoding: BufferEncoding,\n\t\tcb: WriteCallback\n\t) => void;\n\n\tconstructor(opts: WritableOptions) {\n\t\tsuper();\n\t\tif (!opts.write) {\n\t\t\tthrow new Error('WritablePolyfill requires write option');\n\t\t}\n\t\tthis._write = opts.write;\n\t\tthis.highWaterMark = opts.highWaterMark ?? 16 * 1024;\n\t\tthis.decodeStrings = opts.decodeStrings ?? true;\n\t\tthis.defaultEncoding = opts.defaultEncoding ?? 'utf8';\n\t\t// queueMicrotask keeps browser support; fallback for older environments.\n\t\tthis.defer =\n\t\t\ttypeof queueMicrotask === 'function'\n\t\t\t\t? queueMicrotask\n\t\t\t\t: (fn) => setTimeout(fn, 0);\n\t}\n\n\twrite(\n\t\tchunk: any,\n\t\tencoding: BufferEncoding | WriteCallback = this.defaultEncoding,\n\t\tcb: WriteCallback = () => {}\n\t): boolean {\n\t\tif (typeof encoding === 'function') {\n\t\t\tcb = encoding as WriteCallback;\n\t\t\tencoding = this.defaultEncoding;\n\t\t}\n\n\t\tif (this.ended) {\n\t\t\tconst err = new Error('write after end');\n\t\t\t// We can't call this.defer() directly. If this.defer is\n\t\t\t// `queueMicrotask`, a `this.defer()` call will pass the\n\t\t\t// WritablePolyfill instance as `this` argument and cause\n\t\t\t// the browser to throw an error similar to \"Invalid\n\t\t\t// invocation\".\n\t\t\tconst defer = this.defer;\n\t\t\tdefer(() => cb(err));\n\t\t\tthis.emit('error', err);\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.decodeStrings && typeof chunk === 'string') {\n\t\t\tif (\n\t\t\t\ttypeof Buffer !== 'undefined' &&\n\t\t\t\ttypeof (Buffer as any).from === 'function'\n\t\t\t) {\n\t\t\t\tchunk = Buffer.from(chunk, encoding as BufferEncoding);\n\t\t\t} else if (typeof TextEncoder !== 'undefined') {\n\t\t\t\tchunk = new TextEncoder().encode(chunk);\n\t\t\t} else {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t'String chunks are not supported in this environment: Buffer and TextEncoder are unavailable.'\n\t\t\t\t);\n\t\t\t}\n\t\t\tencoding = 'buffer' as BufferEncoding;\n\t\t}\n\n\t\tthis.length += chunk.length ?? 1;\n\t\tconst needDrain = this.length >= this.highWaterMark;\n\n\t\tthis.buffer.push({ chunk, encoding: encoding as BufferEncoding, cb });\n\n\t\tif (!this.writing) this._clearBuffer();\n\n\t\treturn !needDrain;\n\t}\n\n\tend(\n\t\tchunk?: any,\n\t\tencoding?: BufferEncoding | WriteCallback,\n\t\tcb?: WriteCallback\n\t): void {\n\t\tif (typeof chunk === 'function') {\n\t\t\tcb = chunk;\n\t\t\tchunk = undefined;\n\t\t} else if (typeof encoding === 'function') {\n\t\t\tcb = encoding as WriteCallback;\n\t\t\tencoding = undefined;\n\t\t}\n\n\t\tif (chunk !== undefined)\n\t\t\tthis.write(chunk, encoding as BufferEncoding, () => {});\n\t\tthis.ended = true;\n\t\tif (!this.writing) this._clearBuffer();\n\t\tif (cb) this.defer(cb);\n\t}\n\n\t// Stubs kept for API parity; add logic if you depend on corking.\n\tcork(): void {}\n\tuncork(): void {}\n\n\tsetDefaultEncoding(enc: BufferEncoding): this {\n\t\tthis.defaultEncoding = enc;\n\t\treturn this;\n\t}\n\n\tprivate _clearBuffer(): void {\n\t\tconst entry = this.buffer.shift();\n\t\tif (!entry) {\n\t\t\tif (this.ended) this.emit('finish');\n\t\t\treturn;\n\t\t}\n\n\t\tthis.writing = true;\n\t\tthis._write(entry.chunk, entry.encoding, (err?: Error | null) => {\n\t\t\tthis.writing = false;\n\t\t\tthis.length -= entry.chunk.length ?? 1;\n\t\t\tif (err) this.emit('error', err);\n\t\t\tentry.cb(err);\n\n\t\t\tif (this.buffer.length) {\n\t\t\t\tthis._clearBuffer();\n\t\t\t} else {\n\t\t\t\tif (this.length < this.highWaterMark) this.emit('drain');\n\t\t\t\tif (this.ended) this.emit('finish');\n\t\t\t}\n\t\t});\n\t}\n}\n","import { EventEmitterPolyfill } from './event-emitter-polyfill';\nimport { splitShellCommand } from './split-shell-command';\nimport { WritablePolyfill, type WriteCallback } from './writable-polyfill';\n\ntype Listener = (...args: any[]) => any;\n\nexport interface ProcessOptions {\n\tcwd?: string;\n\tenv?: Record<string, string>;\n}\n\n/**\n * Usage:\n * ```ts\n * php.setSpawnHandler(\n *   createSpawnHandler(function (command, processApi) {\n *     console.log(processApi.flushStdin());\n *     processApi.stdout('/\\n/tmp\\n/home');\n *\t   processApi.exit(0);\n *   })\n * );\n * ```\n * @param program\n * @returns\n */\nexport function createSpawnHandler(\n\tprogram: (\n\t\tcommand: string[],\n\t\tprocessApi: ProcessApi,\n\t\toptions: ProcessOptions\n\t) => void | Promise<void>\n): any {\n\treturn function (\n\t\tcommand: string | string[],\n\t\targsArray: string[] = [],\n\t\toptions: ProcessOptions = {}\n\t) {\n\t\tconst childProcess = new ChildProcess();\n\t\tconst processApi = new ProcessApi(childProcess);\n\t\t// Give PHP a chance to register listeners\n\t\tsetTimeout(async () => {\n\t\t\tlet commandArray = [];\n\t\t\tif (argsArray.length) {\n\t\t\t\tcommandArray = [command as string, ...argsArray];\n\t\t\t} else if (typeof command === 'string') {\n\t\t\t\tcommandArray = splitShellCommand(command);\n\t\t\t} else if (Array.isArray(command)) {\n\t\t\t\tcommandArray = command;\n\t\t\t} else {\n\t\t\t\tthrow new Error('Invalid command ', command);\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tconst promise = program(commandArray, processApi, options);\n\t\t\t\tif (\n\t\t\t\t\ttypeof promise !== 'object' ||\n\t\t\t\t\tpromise === null ||\n\t\t\t\t\t!('then' in promise)\n\t\t\t\t) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`The program callback passed to createSpawnHandler() did not return a promise. It indicates there's a bug in your code. ` +\n\t\t\t\t\t\t\t`The callback must return a promise. PHP cannot interact with program that synchronously exists at the end of the proc_open() ` +\n\t\t\t\t\t\t\t`call. All the streams would be closed already. Make sure to put an \"await new Promise(resolve => setTimeout(resolve, 1))` +\n\t\t\t\t\t\t\t`before calling processApi.exit(0) in your callback to let PHP catch up with the stdout data.`\n\t\t\t\t\t);\n\t\t\t\t} else if (processApi.exited) {\n\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t`The program callback passed to createSpawnHandler() exited synchronously. It indicates there's a bug in your code. ` +\n\t\t\t\t\t\t\t`The callback must return a promise. PHP cannot interact with program that synchronously exists at the end of the proc_open() ` +\n\t\t\t\t\t\t\t`call. All the streams would be closed already. Make sure to put an \"await new Promise(resolve => setTimeout(resolve, 1))` +\n\t\t\t\t\t\t\t`before calling processApi.exit(0) in your callback to let PHP catch up with the stdout data.`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t\tchildProcess.emit('spawn', true);\n\t\t\t\tawait promise;\n\t\t\t} catch (e) {\n\t\t\t\tchildProcess.emit('error', e);\n\t\t\t\tif (\n\t\t\t\t\ttypeof e === 'object' &&\n\t\t\t\t\te !== null &&\n\t\t\t\t\t'message' in e &&\n\t\t\t\t\ttypeof e.message === 'string'\n\t\t\t\t) {\n\t\t\t\t\tprocessApi.stderr(e.message);\n\t\t\t\t}\n\t\t\t\tprocessApi.exit(1);\n\t\t\t}\n\t\t});\n\t\treturn childProcess;\n\t};\n}\n\nexport class ProcessApi extends EventEmitterPolyfill {\n\tpublic exited = false;\n\t/**\n\t * Keeps track of the data that was written to stdin before the\n\t * first listener was registered.\n\t */\n\tprivate stdinBuffer: Uint8Array[] | null = [];\n\tpublic childProcess: ChildProcess;\n\tconstructor(childProcess: ChildProcess) {\n\t\tsuper();\n\t\tthis.childProcess = childProcess;\n\t\tchildProcess.on('stdin', (data: Uint8Array) => {\n\t\t\tif (this.stdinBuffer) {\n\t\t\t\t// Need to clone the data buffer as it's reused by PHP\n\t\t\t\t// and the next data chunk will overwrite the previous one.\n\t\t\t\tthis.stdinBuffer.push(data.slice());\n\t\t\t} else {\n\t\t\t\tthis.emit('stdin', data);\n\t\t\t}\n\t\t});\n\t}\n\tstdinEnd() {\n\t\tif (!this.childProcess.stdin.ended) {\n\t\t\tthis.childProcess.stdin.end();\n\t\t}\n\t}\n\tstdout(data: string | ArrayBuffer) {\n\t\tthis.childProcess.stdout.write(data);\n\t}\n\tstdoutEnd() {\n\t\tif (!this.childProcess.stdout.ended) {\n\t\t\tthis.childProcess.stdout.end();\n\t\t}\n\t}\n\tstderr(data: string | ArrayBuffer) {\n\t\tthis.childProcess.stderr.write(data);\n\t}\n\tstderrEnd() {\n\t\tif (!this.childProcess.stderr.ended) {\n\t\t\tthis.childProcess.stderr.end();\n\t\t}\n\t}\n\tnotifySpawn() {\n\t\tthis.childProcess.emit('spawn', true);\n\t}\n\texit(code: number) {\n\t\tif (!this.exited) {\n\t\t\tthis.exited = true;\n\t\t\tthis.stdinEnd();\n\t\t\tthis.stdoutEnd();\n\t\t\tthis.stderrEnd();\n\t\t\tthis.childProcess.emit('exit', code);\n\t\t}\n\t}\n\toverride on(eventName: string, listener: Listener) {\n\t\tsuper.on(eventName, listener);\n\t\t/**\n\t\t * If it's the first stdin listener, flush all the data we've\n\t\t * buffered so far.\n\t\t */\n\t\tif (eventName === 'stdin' && this.stdinBuffer) {\n\t\t\tfor (let i = 0; i < this.stdinBuffer.length; i++) {\n\t\t\t\tthis.emit('stdin', this.stdinBuffer[i]);\n\t\t\t}\n\t\t\tthis.stdinBuffer = null;\n\t\t}\n\t}\n}\n\nlet lastPid = 9743;\nexport class ChildProcess extends EventEmitterPolyfill {\n\tstdout: WritablePolyfill;\n\tstderr: WritablePolyfill;\n\tstdin: WritablePolyfill;\n\tpid: number;\n\tconstructor(pid = lastPid++) {\n\t\tsuper();\n\t\tthis.pid = pid;\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\n\t\tconst self = this;\n\t\tthis.stdout = new WritablePolyfill({\n\t\t\twrite(data: any, encoding: BufferEncoding, cb: WriteCallback) {\n\t\t\t\tself.stdout.emit('data', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t\tthis.stderr = new WritablePolyfill({\n\t\t\twrite: (data: any, encoding: BufferEncoding, cb: WriteCallback) => {\n\t\t\t\tself.stderr.emit('data', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t\tthis.stdin = new WritablePolyfill({\n\t\t\twrite: (data: any, encoding: BufferEncoding, cb: WriteCallback) => {\n\t\t\t\tself.emit('stdin', data);\n\t\t\t\tcb();\n\t\t\t},\n\t\t});\n\t}\n}\n","export function randomString(\n\tlength = 36,\n\tspecialChars = '!@#$%^&*()_+=-[]/.,<>?'\n) {\n\tconst chars =\n\t\t'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' +\n\t\tspecialChars;\n\tlet result = '';\n\tfor (let i = length; i > 0; --i)\n\t\tresult += chars[Math.floor(Math.random() * chars.length)];\n\treturn result;\n}\n","import { randomString } from './random-string';\n\nexport function randomFilename() {\n\treturn randomString(36, '-_');\n}\n","export function phpVar(value: unknown): string {\n\treturn `json_decode(base64_decode('${stringToBase64(\n\t\tJSON.stringify(value)\n\t)}'), true)`;\n}\n\nexport function phpVars<T extends Record<string, unknown>>(\n\tvars: T\n): Record<keyof T, string> {\n\tconst result: Record<string, string> = {};\n\tfor (const key in vars) {\n\t\tresult[key] = phpVar(vars[key]);\n\t}\n\treturn result as Record<keyof T, string>;\n}\n\nfunction stringToBase64(str: string) {\n\treturn bytesToBase64(new TextEncoder().encode(str));\n}\n\nfunction bytesToBase64(bytes: Uint8Array) {\n\tconst binString = String.fromCodePoint(...bytes);\n\treturn btoa(binString);\n}\n","/**\n * Formats a string like sprintf().\n *\n * This function:\n * - Supports basic format specifiers: %s, %d, %f, %x, %%\n * - Supports bigint values\n *\n * The purpose of this function is for use in optional php-wasm tracing.\n * If we use printf-style formatting for trace messages, we let the trace\n * function decide whether to format and do not have to pay for formatting\n * unless tracing is enabled.\n */\nexport function sprintf(format: string, ...args: any[]): string {\n\tlet result = '';\n\tlet argIndex = 0;\n\n\tfor (let i = 0; i < format.length; i++) {\n\t\tif (format[i] === '%' && i + 1 < format.length) {\n\t\t\ti++;\n\t\t\tconst specifier = format[i];\n\n\t\t\tswitch (specifier) {\n\t\t\t\tcase 's': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tlet str;\n\t\t\t\t\tif (typeof arg === 'object') {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t// If an object doesn't provide its own toString(),\n\t\t\t\t\t\t\t// try to represent it as JSON.\n\t\t\t\t\t\t\tstr = JSON.stringify(\n\t\t\t\t\t\t\t\targ,\n\t\t\t\t\t\t\t\t// Represent bigint values as strings in JSON.stringify().\n\t\t\t\t\t\t\t\t(key, value) => {\n\t\t\t\t\t\t\t\t\tif (typeof value === 'bigint') {\n\t\t\t\t\t\t\t\t\t\treturn `0x${value.toString(16)}`;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\treturn value;\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t2\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\t// Ignore error and use default representation.\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tstr = String(arg);\n\t\t\t\t\t}\n\n\t\t\t\t\tresult += str;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'd': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += arg.toString();\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Math.floor(Number(arg));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'f': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += Number(arg);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Number(arg);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase 'x': {\n\t\t\t\t\tconst arg = args[argIndex++];\n\t\t\t\t\tif (typeof arg === 'bigint') {\n\t\t\t\t\t\tresult += arg.toString(16);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult += Math.floor(Number(arg)).toString(16);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase '%': {\n\t\t\t\t\tresult += '%';\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: {\n\t\t\t\t\tresult += '%' + specifier;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tresult += format[i];\n\t\t}\n\t}\n\n\treturn result;\n}\n","// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\ntype PromisedMethod<T extends (...args: any[]) => any> = (\n\t...args: Parameters<T>\n) => Promise<ReturnType<T>>;\n\nexport type Promised<T> = {\n\t[P in keyof T]: T[P] extends (...args: any[]) => any\n\t\t? PromisedMethod<T[P]>\n\t\t: T[P];\n};\n\n/**\n * Wraps a synchronous interface as a promised interface.\n *\n * This function tries to avoid wrapping methods inherited from\n * built-in JS object types (e.g., `Object`, `Array`, `Function`, etc.).\n *\n * The initial use case for this function is for unit testing\n * file locking in php-wasm. Php-wasm for JSPI expects the file lock manager\n * to be a promised interface used via comlink,\n * but the interface itself is synchronous.\n *\n * @param obj\n * @returns A promised interface that wraps the synchronous interface.\n */\nexport function wrapSynchronousInterfaceAsPromised<T extends object>(\n\tobj: T\n): Promised<T> {\n\tconst keysAlreadySeen = new Set<string | symbol>();\n\tconst keysToMakePromised = new Set<string | symbol>();\n\tconst looksLikeBuiltInObject =\n\t\t// NOTE: We don't generally add custom things to the global scope,\n\t\t// so let's use this as a heuristic to determine if an object is a built-in object type.\n\t\t(obj: object) =>\n\t\t\t(globalThis as any)[obj.constructor.name] !== obj.constructor;\n\n\tlet proto: object = obj;\n\twhile (proto !== null && !looksLikeBuiltInObject(proto)) {\n\t\tconst allKeys = [\n\t\t\t...Object.getOwnPropertyNames(proto),\n\t\t\t...Object.getOwnPropertySymbols(proto),\n\t\t];\n\t\tfor (const key of allKeys) {\n\t\t\tif (\n\t\t\t\t// Track keys already seen so an inherited method property\n\t\t\t\t// masked by a descendant property of the same name is not considered.\n\t\t\t\t!keysAlreadySeen.has(key) &&\n\t\t\t\t!keysToMakePromised.has(key) &&\n\t\t\t\ttypeof (proto as any)[key] === 'function'\n\t\t\t) {\n\t\t\t\tkeysToMakePromised.add(key);\n\t\t\t}\n\t\t\tkeysAlreadySeen.add(key);\n\t\t}\n\t\tproto = Object.getPrototypeOf(proto);\n\t}\n\n\t// NOTE: We could use Proxy here instead,\n\t// but providing a regular object is ultimately simpler.\n\tconst promisifiedObj = Object.create(obj);\n\tfor (const key of keysToMakePromised) {\n\t\tpromisifiedObj[key] = function (...args: any[]) {\n\t\t\treturn Promise.resolve((obj as any)[key](...args));\n\t\t};\n\t}\n\treturn promisifiedObj;\n}\n","import Semaphore, { AcquireTimeoutError } from './semaphore';\nexport { Semaphore, AcquireTimeoutError };\nexport { PhpWasmError } from './php-wasm-error';\nexport type { SemaphoreOptions } from './semaphore';\nexport {\n\tdirname,\n\tjoinPaths,\n\tbasename,\n\tnormalizePath,\n\tisParentOf,\n\tensureAbsolutePath,\n} from './paths';\nexport { createSpawnHandler } from './create-spawn-handler';\nexport { randomString } from './random-string';\nexport { randomFilename } from './random-filename';\nexport { splitShellCommand } from './split-shell-command';\nexport { WritablePolyfill, type WritableOptions } from './writable-polyfill';\nexport { EventEmitterPolyfill } from './event-emitter-polyfill';\nexport * from './php-vars';\n\nexport * from './sprintf';\n\nexport function concatUint8Arrays(arrays: Uint8Array[]): Uint8Array {\n\tlet totalLength = 0;\n\tarrays.forEach((a) => (totalLength += a.length));\n\tconst result = new Uint8Array(totalLength);\n\tlet offset = 0;\n\tarrays.forEach((a) => {\n\t\tresult.set(a, offset);\n\t\toffset += a.length;\n\t});\n\treturn result;\n}\n\nexport function concatArrayBuffers(buffers: ArrayBuffer[]): ArrayBuffer {\n\treturn concatUint8Arrays(buffers.map((b) => new Uint8Array(b)))\n\t\t.buffer as ArrayBuffer;\n}\n\nexport * from './promised';\n"],"names":["SleepFinished","sleep","ms","resolve","AcquireTimeoutError","Semaphore","concurrency","timeout","acquired","value","released","fn","release","PhpWasmError","message","userFriendlyMessage","joinPaths","paths","hasTrailingSlash","p","path","isAbsolute","trailingSlash","normalizePath","dirname","lastSlash","basename","normalizePathsArray","parts","allowAboveRoot","up","i","last","isParentOf","parent","child","ensureAbsolutePath","EventEmitterPolyfill","eventName","data","listener","wrappedListener","args","l","splitShellCommand","command","mode","quote","currentPart","char","WritablePolyfill","opts","chunk","encoding","cb","err","defer","needDrain","enc","entry","createSpawnHandler","program","argsArray","options","childProcess","ChildProcess","processApi","ProcessApi","commandArray","promise","e","code","lastPid","pid","self","randomString","length","specialChars","chars","result","randomFilename","phpVar","stringToBase64","phpVars","vars","key","str","bytesToBase64","bytes","binString","sprintf","format","argIndex","specifier","arg","wrapSynchronousInterfaceAsPromised","obj","keysAlreadySeen","keysToMakePromised","looksLikeBuiltInObject","proto","allKeys","promisifiedObj","concatUint8Arrays","arrays","totalLength","a","offset","concatArrayBuffers","buffers","b"],"mappings":"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"}