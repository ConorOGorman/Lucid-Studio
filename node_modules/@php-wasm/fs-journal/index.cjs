"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const u=require("@php-wasm/universal"),d=require("@php-wasm/util"),c=require("@php-wasm/logger");function T(t,n,e=()=>{}){function o(){n=R(n);const r=t[u.__private__dont__use].FS,l=y(r,a=>{if(a.path.startsWith(n))e(a);else if(a.operation==="RENAME"&&a.toPath.startsWith(n))for(const f of E(t,a.path,a.toPath))e(f)}),s={};for(const[a]of Object.entries(l))s[a]=r[a];function p(){for(const[a,f]of Object.entries(l))r[a]=function(..._){return f(..._),s[a].apply(this,_)}}function h(){for(const[a,f]of Object.entries(s))t[u.__private__dont__use].FS[a]=f}t[u.__private__dont__use].journal={bind:p,unbind:h},p()}t.addEventListener("runtime.initialized",o),t[u.__private__dont__use]&&o();function i(){t[u.__private__dont__use].journal.unbind(),delete t[u.__private__dont__use].journal}return t.addEventListener("runtime.beforeExit",i),function(){return t.removeEventListener("runtime.initialized",o),t.removeEventListener("runtime.beforeExit",i),t[u.__private__dont__use].journal.unbind()}}const y=(t,n=()=>{})=>({write(e){n({operation:"WRITE",path:e.path,nodeType:"file"})},truncate(e){let o;typeof e=="string"?o=t.lookupPath(e,{follow:!0}).node:o=e,n({operation:"WRITE",path:t.getPath(o),nodeType:"file"})},unlink(e){n({operation:"DELETE",path:e,nodeType:"file"})},mknod(e,o){t.isFile(o)&&n({operation:"CREATE",path:e,nodeType:"file"})},mkdir(e){n({operation:"CREATE",path:e,nodeType:"directory"})},rmdir(e){n({operation:"DELETE",path:e,nodeType:"directory"})},rename(e,o){try{const i=t.lookupPath(e,{follow:!0}),r=t.lookupPath(o,{parent:!0}).path;n({operation:"RENAME",nodeType:t.isDir(i.node.mode)?"directory":"file",path:i.path,toPath:d.joinPaths(r,d.basename(o))})}catch{}}});function m(t,n){t[u.__private__dont__use].journal.unbind();try{for(const e of n)e.operation==="CREATE"?e.nodeType==="file"?t.writeFile(e.path," "):t.mkdir(e.path):e.operation==="DELETE"?e.nodeType==="file"?t.unlink(e.path):t.rmdir(e.path):e.operation==="WRITE"?t.writeFile(e.path,e.data):e.operation==="RENAME"&&t.mv(e.path,e.toPath)}finally{t[u.__private__dont__use].journal.bind()}}function*E(t,n,e){if(t.isDir(n)){yield{operation:"CREATE",path:e,nodeType:"directory"};for(const o of t.listFiles(n))yield*E(t,d.joinPaths(n,o),d.joinPaths(e,o))}else yield{operation:"CREATE",path:e,nodeType:"file"},yield{operation:"WRITE",nodeType:"file",path:e}}function R(t){return t.replace(/\/$/,"").replace(/\/\/+/g,"/")}function b(t){let n=t;for(;;){const e={};for(let o=n.length-1;o>=0;o--)for(let i=o-1;i>=0;i--){const r=g(n[o],n[i]);if(r==="none")continue;const l=n[o],s=n[i];if(l.operation==="RENAME"&&s.operation==="RENAME"){c.logger.warn("[FS Journal] Normalizing a double rename is not yet supported:",{current:l,last:s});continue}(s.operation==="CREATE"||s.operation==="WRITE")&&(l.operation==="RENAME"?r==="same_node"?(e[i]=[],e[o]=[{...s,path:l.toPath},...e[o]||[]]):r==="descendant"&&(e[i]=[],e[o]=[{...s,path:d.joinPaths(l.toPath,s.path.substring(l.path.length))},...e[o]||[]]):l.operation==="WRITE"&&r==="same_node"?e[i]=[]:l.operation==="DELETE"&&r==="same_node"&&(e[i]=[],s.operation==="CREATE"&&(e[o]=[])))}if(Object.keys(e).length===0)return n;n=n.flatMap((o,i)=>i in e?e[i]:[o])}}function g(t,n){const e=t.path,o=t.operation!=="WRITE"&&t.nodeType==="directory",i=n.operation!=="WRITE"&&n.nodeType==="directory",r=n.operation==="RENAME"?n.toPath:n.path;return r===e?"same_node":i&&e.startsWith(r+"/")?"ancestor":o&&r.startsWith(e+"/")?"descendant":"none"}async function v(t,n){const o=n.filter(i=>i.operation==="WRITE").map(i=>F(t,i));return await Promise.all(o),n}const j=new d.Semaphore({concurrency:15});async function F(t,n){const e=await j.acquire();try{n.data=await t.readFileAsBuffer(n.path)}catch(o){c.logger.warn(`Journal failed to hydrate a file on flush: the path ${n.path} no longer exists`),c.logger.error(o)}e()}exports.hydrateUpdateFileOps=v;exports.journalFSEvents=T;exports.normalizeFilesystemOperations=b;exports.replayFSJournal=m;
//# sourceMappingURL=index.cjs.map
