"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("@php-wasm/scopes"),w=25e3;let S=0;function b(e,t,...s){const r=p();return e.postMessage({...t,requestId:r},...s),r}function p(){return++S}function f(e,t,s=w){return new Promise((r,i)=>{const o=c=>{c.data.type==="response"&&c.data.requestId===t&&(e.removeEventListener("message",o),clearTimeout(a),r(c.data.response))},a=setTimeout(()=>{i(new Error("Request timed out")),e.removeEventListener("message",o)},s);e.addEventListener("message",o)})}function E(e,t){return{type:"response",requestId:e,response:t}}async function C(e){let t=new URL(e.request.url);if(!d.isURLScoped(t))try{const n=new URL(e.request.referrer);t=d.setURLScope(t,d.getURLScope(n))}catch{}const s=e.request.headers.get("content-type"),r=e.request.method==="POST"?new Uint8Array(await e.request.clone().arrayBuffer()):void 0,i={};for(const n of e.request.headers.entries())i[n[0]]=n[1];let o;try{const n={method:"request",args:[{body:r,url:t.toString(),method:e.request.method,headers:{...i,Host:t.host,"User-agent":self.navigator.userAgent,"Content-type":s}}]},y=d.getURLScope(t);if(y===null)throw new Error(`The URL ${t.toString()} is not scoped. This should not happen.`);const R=await g(n,y);if(o=await f(self,R),delete o.headers["x-frame-options"],o.headers["content-security-policy"]){const h=o.headers["content-security-policy"].map(u=>m("frame-ancestors",u)).filter(u=>u.trim().length>0);h.length>0?o.headers["content-security-policy"]=h:delete o.headers["content-security-policy"]}}catch(n){throw console.error(n,{url:t.toString()}),n}if(o.httpStatusCode>=300&&o.httpStatusCode<=399&&o.headers.location)return Response.redirect(new URL(o.headers.location[0],t.toString()),o.httpStatusCode);const c=[101,103,204,205,304].includes(o.httpStatusCode)?null:o.bytes;return new Response(c,{headers:o.headers,status:o.httpStatusCode})}async function g(e,t){const s=p();for(const r of await self.clients.matchAll({includeUncontrolled:!0}))r.postMessage({...e,scope:t,requestId:s});return s}async function l(e,t){let s;return["GET","HEAD"].includes(e.method)||"body"in t?s=void 0:!e.bodyUsed&&e.body?s=e.body:s=await e.blob(),new Request(t.url||e.url,{body:s,method:e.method,headers:e.headers,referrer:e.referrer,referrerPolicy:e.referrerPolicy,mode:e.mode==="navigate"?"same-origin":e.mode,credentials:e.credentials,cache:e.cache,redirect:e.redirect,integrity:e.integrity,...s&&{duplex:"half"},...t})}async function U(e){if(!e.body)return[e,e];const[t,s]=e.body.tee();return[await l(e,{body:t,duplex:"half"}),await l(e,{body:s,duplex:"half"})]}function L(e){const t={};return e.headers.forEach((s,r)=>{t[r]=s}),t}function m(e,t){const s=/^[\u{9}\u{A}\u{C}\u{D}\u{20}]+/u,r=/[\u{9}\u{A}\u{C}\u{D}\u{20}]+$/u,i=/[\u{9}\u{A}\u{C}\u{D}\u{20}]/u;return t.split(";").filter(o=>{const a=o.replace(s,"").replace(r,""),[c]=a.split(i,1);return c.toLowerCase()!==e.toLowerCase()}).join(";")}exports.awaitReply=f;exports.broadcastMessageExpectReply=g;exports.cloneRequest=l;exports.convertFetchEventToPHPRequest=C;exports.getNextRequestId=p;exports.getRequestHeaders=L;exports.postMessageExpectReply=b;exports.removeContentSecurityPolicyDirective=m;exports.responseTo=E;exports.teeRequest=U;
