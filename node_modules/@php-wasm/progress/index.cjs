"use strict";var y=r=>{throw TypeError(r)};var E=(r,e,s)=>e.has(r)||y("Cannot "+s);var o=(r,e,s)=>(E(r,e,"read from private field"),s?s.call(r):e.get(r)),c=(r,e,s)=>e.has(r)?y("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(r):e.set(r,s),p=(r,e,s,t)=>(E(r,e,"write to private field"),t?t.call(r,s):e.set(r,s),s),_=(r,e,s)=>(E(r,e,"access private method"),s);var P=(r,e,s,t)=>({set _(i){p(r,e,i,s)},get _(){return o(r,e,t)}});Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});require("@php-wasm/node-polyfills");const I=require("@php-wasm/logger"),R=5*1024*1024;var h,l,v,O;class k extends EventTarget{constructor(){super(...arguments);c(this,v);c(this,h,{});c(this,l,{})}expectAssets(s){for(const[t,i]of Object.entries(s)){const n="http://example.com/",a=new URL(t,n).pathname.split("/").pop();a in o(this,h)||(o(this,h)[a]=i),a in o(this,l)||(o(this,l)[a]=0)}}async monitorFetch(s){const t=await s;return C(t,n=>{_(this,v,O).call(this,t.url,n.detail.loaded,n.detail.total)})}}h=new WeakMap,l=new WeakMap,v=new WeakSet,O=function(s,t,i){const n=new URL(s,"http://example.com").pathname.split("/").pop();i?n in o(this,h)||(o(this,h)[n]=i,o(this,l)[n]=t):i=o(this,h)[n],n in o(this,l)||I.logger.warn(`Registered a download #progress of an unregistered file "${n}". This may cause a sudden **decrease** in the #progress percentage as the length number of bytes increases during the download.`),o(this,l)[n]=t,this.dispatchEvent(new CustomEvent("progress",{detail:{loaded:T(o(this,l)),total:T(o(this,h))}}))};function T(r){return Object.values(r).reduce((e,s)=>e+s,0)}function C(r,e){const s=r.headers.get("content-length")||"",t=parseInt(s,10)||R;return new Response(M(r.body,t,e),{status:r.status,statusText:r.statusText,headers:r.headers})}function M(r,e,s){function t(i,n){s(new CustomEvent("progress",{detail:{loaded:i,total:n}}))}return new ReadableStream({async start(i){if(!r){i.close();return}const n=r.getReader();let d=0;for(;;)try{const{done:a,value:m}=await n.read();if(m&&(d+=m.byteLength),a){t(d,d),i.close();break}else t(d,e),i.enqueue(m)}catch(a){I.logger.error({e:a}),i.error(a);break}}})}var g,f,u,L;class S extends EventTarget{constructor(){super(...arguments);c(this,u);c(this,g);c(this,f);p(this,g,{}),p(this,f,0),this.progress=0,this.mode="REAL_TIME",this.caption=""}partialObserver(s,t=""){const i=++P(this,f)._;return o(this,g)[i]=0,n=>{const{loaded:d,total:a}=(n==null?void 0:n.detail)||{};o(this,g)[i]=d/a*s,_(this,u,L).call(this,this.totalProgress,"REAL_TIME",t)}}slowlyIncrementBy(s){const t=++P(this,f)._;o(this,g)[t]=s,_(this,u,L).call(this,this.totalProgress,"SLOWLY_INCREMENT")}get totalProgress(){return Object.values(o(this,g)).reduce((s,t)=>s+t,0)}}g=new WeakMap,f=new WeakMap,u=new WeakSet,L=function(s,t,i){this.dispatchEvent(new CustomEvent("progress",{detail:{progress:s,mode:t,caption:i}}))};const b=1e-5;class w extends EventTarget{constructor({weight:e=1,caption:s="",fillTime:t=4}={}){super(),this._selfWeight=1,this._selfDone=!1,this._selfProgress=0,this._selfCaption="",this._isFilling=!1,this._subTrackers=[],this._weight=e,this._selfCaption=s,this._fillTime=t}stage(e,s=""){if(e||(e=this._selfWeight),this._selfWeight-e<-b)throw new Error(`Cannot add a stage with weight ${e} as the total weight of registered stages would exceed 1.`);this._selfWeight-=e;const t=new w({caption:s,weight:e,fillTime:this._fillTime});return this._subTrackers.push(t),t.addEventListener("progress",()=>this.notifyProgress()),t.addEventListener("done",()=>{this.done&&this.notifyDone()}),t}fillSlowly({stopBeforeFinishing:e=!0}={}){if(this._isFilling)return;this._isFilling=!0;const t=this._fillTime/100;this._fillInterval=setInterval(()=>{this.set(this._selfProgress+1),e&&this._selfProgress>=99&&clearInterval(this._fillInterval)},t)}set(e){this._selfProgress=Math.min(e,100),this.notifyProgress(),this._selfProgress+b>=100&&this.finish()}finish(){this._fillInterval&&clearInterval(this._fillInterval),this._selfDone=!0,this._selfProgress=100,this._isFilling=!1,this._fillInterval=void 0,this.notifyProgress(),this.notifyDone()}get caption(){for(let e=this._subTrackers.length-1;e>=0;e--)if(!this._subTrackers[e].done){const s=this._subTrackers[e].caption;if(s)return s}return this._selfCaption}setCaption(e){this._selfCaption=e,this.notifyProgress()}get done(){return this.progress+b>=100}get progress(){if(this._selfDone)return 100;const e=this._subTrackers.reduce((s,t)=>s+t.progress*t.weight,this._selfProgress*this._selfWeight);return Math.round(e*1e4)/1e4}get weight(){return this._weight}get observer(){return this._progressObserver||(this._progressObserver=e=>{this.set(e)}),this._progressObserver}get loadingListener(){return this._loadingListener||(this._loadingListener=e=>{this.set(e.detail.loaded/e.detail.total*100)}),this._loadingListener}pipe(e){e.setProgress({progress:this.progress,caption:this.caption}),this.addEventListener("progress",s=>{e.setProgress({progress:s.detail.progress,caption:s.detail.caption})}),this.addEventListener("done",()=>{e.setLoaded()})}addEventListener(e,s){super.addEventListener(e,s)}removeEventListener(e,s){super.removeEventListener(e,s)}notifyProgress(){const e=this;this.dispatchEvent(new CustomEvent("progress",{detail:{get progress(){return e.progress},get caption(){return e.caption}}}))}notifyDone(){this.dispatchEvent(new CustomEvent("done"))}}exports.EmscriptenDownloadMonitor=k;exports.ProgressObserver=S;exports.ProgressTracker=w;exports.cloneResponseMonitorProgress=C;exports.cloneStreamMonitorProgress=M;
//# sourceMappingURL=index.cjs.map
