import a from "fs";
import S from "path";
import { XMLParser as k, XMLBuilder as A } from "fast-xml-parser";
import * as v from "jsonc-parser";
async function V(l, c, s) {
  const p = s === "win32" ? (
    // On Windows, creating a 'dir' symlink can require elevated permissions.
    // In this case, let's make junction points because they function like
    // symlinks and do not require elevated permissions.
    "junction"
  ) : "dir";
  a.symlinkSync(l, c, p);
}
async function J(l) {
  try {
    a.lstatSync(l).isSymbolicLink() && a.unlinkSync(l);
  } catch {
  }
}
function M(l, c) {
  return c.filter((s) => {
    const p = S.resolve(s.hostPath), h = S.join(l, S.sep);
    return (
      // If auto-mounting from the current directory,
      // the entire project directory can be mapped.
      p === l || p.startsWith(h)
    );
  });
}
const x = {
  ignoreAttributes: !1,
  attributeNamePrefix: "",
  preserveOrder: !0,
  cdataPropName: "__cdata",
  commentPropName: "__xmlComment",
  allowBooleanAttributes: !0,
  trimValues: !0
}, T = {
  ignoreAttributes: x.ignoreAttributes,
  attributeNamePrefix: x.attributeNamePrefix,
  preserveOrder: x.preserveOrder,
  cdataPropName: x.cdataPropName,
  commentPropName: x.commentPropName,
  suppressBooleanAttributes: !x.allowBooleanAttributes,
  format: !0,
  indentBy: "	"
}, j = {
  allowEmptyContent: !0,
  allowTrailingComma: !0
};
function O(l, c) {
  var E, b, I, F, L, $;
  const { name: s, host: p, port: h, mappings: f, ideKey: t } = c, u = new k(x), g = (() => {
    try {
      return u.parse(l, !0);
    } catch {
      throw new Error("PhpStorm configuration file is not valid XML.");
    }
  })(), m = {
    server: [{}],
    ":@": {
      name: s,
      // NOTE: PhpStorm quirk: Xdebug only works when the full URL (including port)
      // is provided in `host`. The separate `port` field is ignored or misinterpreted,
      // so we rely solely on host: "host:port".
      host: `${p}:${h}`,
      use_path_mappings: "true"
    }
  };
  f && f.length && (m.server[0].path_mappings = f.map((e) => ({
    mapping: [],
    ":@": {
      "local-root": `$PROJECT_DIR$/${N(
        S.relative(c.projectDir, e.hostPath)
      )}`,
      "remote-root": e.vfsPath
    }
  })));
  let n = g == null ? void 0 : g.find((e) => !!(e != null && e.project));
  if (n) {
    const e = (E = n[":@"]) == null ? void 0 : E.version;
    if (e === void 0)
      throw new Error(
        'PhpStorm IDE integration only supports <project version="4"> in workspace.xml, but the <project> configuration has no version number.'
      );
    if (e !== "4")
      throw new Error(
        `PhpStorm IDE integration only supports <project version="4"> in workspace.xml, but we found a <project> configuration with version "${e}".`
      );
  }
  n === void 0 && (n = {
    project: [],
    ":@": { version: "4" }
  }, g.push(n));
  let o = (b = n.project) == null ? void 0 : b.find(
    (e) => {
      var P;
      return !!(e != null && e.component) && ((P = e == null ? void 0 : e[":@"]) == null ? void 0 : P.name) === "PhpServers";
    }
  );
  o === void 0 && (o = {
    component: [],
    ":@": { name: "PhpServers" }
  }, n.project === void 0 && (n.project = []), n.project.push(o));
  let i = (I = o.component) == null ? void 0 : I.find(
    (e) => !!(e != null && e.servers)
  );
  i === void 0 && (i = { servers: [] }, o.component === void 0 && (o.component = []), o.component.push(i));
  const y = (F = i.servers) == null ? void 0 : F.findIndex(
    (e) => {
      var P;
      return !!(e != null && e.server) && ((P = e == null ? void 0 : e[":@"]) == null ? void 0 : P.name) === s;
    }
  );
  (y === void 0 || y < 0) && (i.servers === void 0 && (i.servers = []), i.servers.push(m));
  let d = (L = n.project) == null ? void 0 : L.find(
    (e) => {
      var P;
      return !!(e != null && e.component) && ((P = e == null ? void 0 : e[":@"]) == null ? void 0 : P.name) === "RunManager";
    }
  );
  if (d === void 0 && (d = {
    component: [],
    ":@": { name: "RunManager" }
  }, n.project === void 0 && (n.project = []), n.project.push(d)), ((($ = d.component) == null ? void 0 : $.findIndex(
    (e) => {
      var P;
      return !!(e != null && e.configuration) && ((P = e == null ? void 0 : e[":@"]) == null ? void 0 : P.name) === s;
    }
  )) ?? -1) < 0) {
    const e = {
      configuration: [
        {
          method: [],
          ":@": { v: "2" }
        }
      ],
      ":@": {
        name: s,
        type: "PhpRemoteDebugRunConfigurationType",
        factoryName: "PHP Remote Debug",
        filter_connections: "FILTER",
        server_name: s,
        session_id: t
      }
    };
    d.component === void 0 && (d.component = []), d.component.push(e);
  }
  const C = new A(T).build(g);
  try {
    u.parse(C, !0);
  } catch {
    throw new Error(
      "The resulting PhpStorm configuration file is not valid XML."
    );
  }
  return C;
}
function _(l, c) {
  var m, n;
  const { name: s, mappings: p } = c, h = [];
  let f = l, t = v.parseTree(f, h, j);
  if (t === void 0 || h.length)
    throw new Error("VS Code configuration file is not valid JSON.");
  let u = v.findNodeAtLocation(t, ["configurations"]);
  if (u === void 0 || u.children === void 0) {
    const o = v.modify(f, ["configurations"], [], {});
    f = v.applyEdits(f, o), t = v.parseTree(f, [], j), u = v.findNodeAtLocation(t, [
      "configurations"
    ]);
  }
  const g = (m = u == null ? void 0 : u.children) == null ? void 0 : m.findIndex(
    (o) => {
      var i;
      return ((i = v.findNodeAtLocation(o, ["name"])) == null ? void 0 : i.value) === s;
    }
  );
  if (g === void 0 || g < 0) {
    const o = {
      name: s,
      type: "php",
      request: "launch",
      port: 9003
    };
    p && p.length && (o.pathMappings = p.reduce((d, r) => (d[r.vfsPath] = `\${workspaceFolder}/${N(
      S.relative(c.workspaceDir, r.hostPath)
    )}`, d), {}));
    const i = ((n = u == null ? void 0 : u.children) == null ? void 0 : n.length) || 0, y = v.modify(
      f,
      ["configurations", i],
      o,
      {
        formattingOptions: {
          insertSpaces: !0,
          tabSize: 4,
          eol: `
`
        }
      }
    );
    f = D(f, y);
  }
  return f;
}
async function q({
  name: l,
  ides: c,
  host: s,
  port: p,
  cwd: h,
  mounts: f,
  ideKey: t = "PHPWASMCLI"
}) {
  const u = f ? M(h, f) : [], g = {};
  if (c.includes("phpstorm")) {
    const m = ".idea/workspace.xml", n = S.join(
      h,
      m
    );
    if (!a.existsSync(n)) {
      if (a.existsSync(S.dirname(n)))
        a.writeFileSync(
          n,
          `<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
</project>`
        );
      else if (c.length == 1)
        throw new Error(
          "PhpStorm IDE integration requested, but no '.idea' directory was found in the current working directory."
        );
    }
    if (a.existsSync(n)) {
      const o = a.readFileSync(n, "utf8"), i = O(o, {
        name: l,
        host: s,
        port: p,
        projectDir: h,
        mappings: u,
        ideKey: t
      });
      a.writeFileSync(n, i), g.phpstorm = m;
    }
  }
  if (c.includes("vscode")) {
    const m = ".vscode/launch.json", n = S.join(
      h,
      m
    );
    if (!a.existsSync(n)) {
      if (a.existsSync(S.dirname(n)))
        a.writeFileSync(
          n,
          `{
    "configurations": []
}`
        );
      else if (c.length == 1)
        throw new Error(
          "VS Code IDE integration requested, but no '.vscode' directory was found in the current working directory."
        );
    }
    if (a.existsSync(n)) {
      const o = a.readFileSync(n, "utf-8"), i = _(o, {
        name: l,
        workspaceDir: h,
        mappings: u
      });
      i !== o && (a.writeFileSync(n, i), g.vscode = m);
    }
  }
  return g;
}
async function H(l, c) {
  var h, f, t, u;
  const s = S.join(c, ".idea/workspace.xml");
  if (a.existsSync(s)) {
    const g = a.readFileSync(s, "utf8"), m = new k(x), n = (() => {
      try {
        return m.parse(g, !0);
      } catch {
        throw new Error(
          "PhpStorm configuration file is not valid XML."
        );
      }
    })(), o = n.find(
      (r) => !!(r != null && r.project)
    ), i = (h = o == null ? void 0 : o.project) == null ? void 0 : h.find(
      (r) => {
        var w;
        return !!(r != null && r.component) && ((w = r == null ? void 0 : r[":@"]) == null ? void 0 : w.name) === "PhpServers";
      }
    ), y = (f = i == null ? void 0 : i.component) == null ? void 0 : f.find(
      (r) => !!(r != null && r.servers)
    ), d = (t = y == null ? void 0 : y.servers) == null ? void 0 : t.findIndex(
      (r) => {
        var w;
        return !!(r != null && r.server) && ((w = r == null ? void 0 : r[":@"]) == null ? void 0 : w.name) === l;
      }
    );
    if (d !== void 0 && d >= 0) {
      y.servers.splice(d, 1);
      const w = new A(T).build(n);
      try {
        m.parse(w, !0);
      } catch {
        throw new Error(
          "The resulting PhpStorm configuration file is not valid XML."
        );
      }
      w === `<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
	<component name="PhpServers">
		<servers></servers>
	</component>
</project>` ? a.unlinkSync(s) : a.writeFileSync(s, w);
    }
  }
  const p = S.join(c, ".vscode/launch.json");
  if (a.existsSync(p)) {
    const g = [], m = a.readFileSync(p, "utf-8"), n = v.parseTree(m, g, j);
    if (n === void 0 || g.length)
      throw new Error("VS Code configuration file is not valid JSON.");
    const o = v.findNodeAtLocation(n, [
      "configurations"
    ]), i = (u = o == null ? void 0 : o.children) == null ? void 0 : u.findIndex(
      (y) => {
        var d;
        return ((d = v.findNodeAtLocation(y, ["name"])) == null ? void 0 : d.value) === l;
      }
    );
    if (i !== void 0 && i >= 0) {
      const y = v.modify(
        m,
        ["configurations", i],
        void 0,
        {
          formattingOptions: {
            insertSpaces: !0,
            tabSize: 4,
            eol: `
`
          }
        }
      ), d = D(m, y);
      d === `{
    "configurations": []
}` ? a.unlinkSync(p) : a.writeFileSync(p, d);
    }
  }
}
function D(l, c) {
  const s = [], p = v.applyEdits(l, c);
  if (s.length = 0, v.parseTree(p, s, j), s.length) {
    const h = s.map((t) => ({
      message: v.printParseErrorCode(t.error),
      offset: t.offset,
      length: t.length,
      fragment: p.slice(
        Math.max(0, t.offset - 20),
        Math.min(p.length, t.offset + t.length + 10)
      )
    })).map(
      (t) => `${t.message} at ${t.offset}:${t.length} (${t.fragment})`
    ), f = c.map(
      (t) => `At ${t.offset}:${t.length} - (${t.content})`
    );
    throw new Error(
      `VS Code configuration file (.vscode/launch.json) is not valid a JSONC after CLI modifications. This is likely a CLI bug. Please report it at https://github.com/WordPress/wordpress-playground/issues and include the contents of your ".vscode/launch.json" file. 

 Applied edits: ${f.join(
        `
`
      )}

 The errors are: ${h.join(`
`)}`
    );
  }
  return p;
}
function N(l) {
  return l.replaceAll(S.sep, S.posix.sep);
}
export {
  q as addXdebugIDEConfig,
  H as clearXdebugIDEConfig,
  V as createTempDirSymlink,
  J as removeTempDirSymlink,
  O as updatePhpStormConfig,
  _ as updateVSCodeConfig
};
//# sourceMappingURL=index.js.map
