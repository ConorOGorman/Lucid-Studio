"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const p=require("fs"),S=require("path"),j=require("fast-xml-parser"),A=require("jsonc-parser");function X(o){const a=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});if(o){for(const t in o)if(t!=="default"){const c=Object.getOwnPropertyDescriptor(o,t);Object.defineProperty(a,t,c.get?c:{enumerable:!0,get:()=>o[t]})}}return a.default=o,Object.freeze(a)}const v=X(A);async function _(o,a,t){const c=t==="win32"?"junction":"dir";p.symlinkSync(o,a,c)}async function B(o){try{p.lstatSync(o).isSymbolicLink()&&p.unlinkSync(o)}catch{}}function R(o,a){return a.filter(t=>{const c=S.resolve(t.hostPath),h=S.join(o,S.sep);return c===o||c.startsWith(h)})}const x={ignoreAttributes:!1,attributeNamePrefix:"",preserveOrder:!0,cdataPropName:"__cdata",commentPropName:"__xmlComment",allowBooleanAttributes:!0,trimValues:!0},T={ignoreAttributes:x.ignoreAttributes,attributeNamePrefix:x.attributeNamePrefix,preserveOrder:x.preserveOrder,cdataPropName:x.cdataPropName,commentPropName:x.commentPropName,suppressBooleanAttributes:!x.allowBooleanAttributes,format:!0,indentBy:"	"},C={allowEmptyContent:!0,allowTrailingComma:!0};function k(o,a){var E,I,D,F,L,O;const{name:t,host:c,port:h,mappings:f,ideKey:r}=a,u=new j.XMLParser(x),g=(()=>{try{return u.parse(o,!0)}catch{throw new Error("PhpStorm configuration file is not valid XML.")}})(),m={server:[{}],":@":{name:t,host:`${c}:${h}`,use_path_mappings:"true"}};f&&f.length&&(m.server[0].path_mappings=f.map(e=>({mapping:[],":@":{"local-root":`$PROJECT_DIR$/${$(S.relative(a.projectDir,e.hostPath))}`,"remote-root":e.vfsPath}})));let n=g==null?void 0:g.find(e=>!!(e!=null&&e.project));if(n){const e=(E=n[":@"])==null?void 0:E.version;if(e===void 0)throw new Error('PhpStorm IDE integration only supports <project version="4"> in workspace.xml, but the <project> configuration has no version number.');if(e!=="4")throw new Error(`PhpStorm IDE integration only supports <project version="4"> in workspace.xml, but we found a <project> configuration with version "${e}".`)}n===void 0&&(n={project:[],":@":{version:"4"}},g.push(n));let i=(I=n.project)==null?void 0:I.find(e=>{var P;return!!(e!=null&&e.component)&&((P=e==null?void 0:e[":@"])==null?void 0:P.name)==="PhpServers"});i===void 0&&(i={component:[],":@":{name:"PhpServers"}},n.project===void 0&&(n.project=[]),n.project.push(i));let l=(D=i.component)==null?void 0:D.find(e=>!!(e!=null&&e.servers));l===void 0&&(l={servers:[]},i.component===void 0&&(i.component=[]),i.component.push(l));const y=(F=l.servers)==null?void 0:F.findIndex(e=>{var P;return!!(e!=null&&e.server)&&((P=e==null?void 0:e[":@"])==null?void 0:P.name)===t});(y===void 0||y<0)&&(l.servers===void 0&&(l.servers=[]),l.servers.push(m));let d=(L=n.project)==null?void 0:L.find(e=>{var P;return!!(e!=null&&e.component)&&((P=e==null?void 0:e[":@"])==null?void 0:P.name)==="RunManager"});if(d===void 0&&(d={component:[],":@":{name:"RunManager"}},n.project===void 0&&(n.project=[]),n.project.push(d)),(((O=d.component)==null?void 0:O.findIndex(e=>{var P;return!!(e!=null&&e.configuration)&&((P=e==null?void 0:e[":@"])==null?void 0:P.name)===t}))??-1)<0){const e={configuration:[{method:[],":@":{v:"2"}}],":@":{name:t,type:"PhpRemoteDebugRunConfigurationType",factoryName:"PHP Remote Debug",filter_connections:"FILTER",server_name:t,session_id:r}};d.component===void 0&&(d.component=[]),d.component.push(e)}const b=new j.XMLBuilder(T).build(g);try{u.parse(b,!0)}catch{throw new Error("The resulting PhpStorm configuration file is not valid XML.")}return b}function M(o,a){var m,n;const{name:t,mappings:c}=a,h=[];let f=o,r=v.parseTree(f,h,C);if(r===void 0||h.length)throw new Error("VS Code configuration file is not valid JSON.");let u=v.findNodeAtLocation(r,["configurations"]);if(u===void 0||u.children===void 0){const i=v.modify(f,["configurations"],[],{});f=v.applyEdits(f,i),r=v.parseTree(f,[],C),u=v.findNodeAtLocation(r,["configurations"])}const g=(m=u==null?void 0:u.children)==null?void 0:m.findIndex(i=>{var l;return((l=v.findNodeAtLocation(i,["name"]))==null?void 0:l.value)===t});if(g===void 0||g<0){const i={name:t,type:"php",request:"launch",port:9003};c&&c.length&&(i.pathMappings=c.reduce((d,s)=>(d[s.vfsPath]=`\${workspaceFolder}/${$(S.relative(a.workspaceDir,s.hostPath))}`,d),{}));const l=((n=u==null?void 0:u.children)==null?void 0:n.length)||0,y=v.modify(f,["configurations",l],i,{formattingOptions:{insertSpaces:!0,tabSize:4,eol:`
`}});f=N(f,y)}return f}async function V({name:o,ides:a,host:t,port:c,cwd:h,mounts:f,ideKey:r="PHPWASMCLI"}){const u=f?R(h,f):[],g={};if(a.includes("phpstorm")){const m=".idea/workspace.xml",n=S.join(h,m);if(!p.existsSync(n)){if(p.existsSync(S.dirname(n)))p.writeFileSync(n,`<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
</project>`);else if(a.length==1)throw new Error("PhpStorm IDE integration requested, but no '.idea' directory was found in the current working directory.")}if(p.existsSync(n)){const i=p.readFileSync(n,"utf8"),l=k(i,{name:o,host:t,port:c,projectDir:h,mappings:u,ideKey:r});p.writeFileSync(n,l),g.phpstorm=m}}if(a.includes("vscode")){const m=".vscode/launch.json",n=S.join(h,m);if(!p.existsSync(n)){if(p.existsSync(S.dirname(n)))p.writeFileSync(n,`{
    "configurations": []
}`);else if(a.length==1)throw new Error("VS Code IDE integration requested, but no '.vscode' directory was found in the current working directory.")}if(p.existsSync(n)){const i=p.readFileSync(n,"utf-8"),l=M(i,{name:o,workspaceDir:h,mappings:u});l!==i&&(p.writeFileSync(n,l),g.vscode=m)}}return g}async function q(o,a){var h,f,r,u;const t=S.join(a,".idea/workspace.xml");if(p.existsSync(t)){const g=p.readFileSync(t,"utf8"),m=new j.XMLParser(x),n=(()=>{try{return m.parse(g,!0)}catch{throw new Error("PhpStorm configuration file is not valid XML.")}})(),i=n.find(s=>!!(s!=null&&s.project)),l=(h=i==null?void 0:i.project)==null?void 0:h.find(s=>{var w;return!!(s!=null&&s.component)&&((w=s==null?void 0:s[":@"])==null?void 0:w.name)==="PhpServers"}),y=(f=l==null?void 0:l.component)==null?void 0:f.find(s=>!!(s!=null&&s.servers)),d=(r=y==null?void 0:y.servers)==null?void 0:r.findIndex(s=>{var w;return!!(s!=null&&s.server)&&((w=s==null?void 0:s[":@"])==null?void 0:w.name)===o});if(d!==void 0&&d>=0){y.servers.splice(d,1);const w=new j.XMLBuilder(T).build(n);try{m.parse(w,!0)}catch{throw new Error("The resulting PhpStorm configuration file is not valid XML.")}w===`<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
	<component name="PhpServers">
		<servers></servers>
	</component>
</project>`?p.unlinkSync(t):p.writeFileSync(t,w)}}const c=S.join(a,".vscode/launch.json");if(p.existsSync(c)){const g=[],m=p.readFileSync(c,"utf-8"),n=v.parseTree(m,g,C);if(n===void 0||g.length)throw new Error("VS Code configuration file is not valid JSON.");const i=v.findNodeAtLocation(n,["configurations"]),l=(u=i==null?void 0:i.children)==null?void 0:u.findIndex(y=>{var d;return((d=v.findNodeAtLocation(y,["name"]))==null?void 0:d.value)===o});if(l!==void 0&&l>=0){const y=v.modify(m,["configurations",l],void 0,{formattingOptions:{insertSpaces:!0,tabSize:4,eol:`
`}}),d=N(m,y);d===`{
    "configurations": []
}`?p.unlinkSync(c):p.writeFileSync(c,d)}}}function N(o,a){const t=[],c=v.applyEdits(o,a);if(t.length=0,v.parseTree(c,t,C),t.length){const h=t.map(r=>({message:v.printParseErrorCode(r.error),offset:r.offset,length:r.length,fragment:c.slice(Math.max(0,r.offset-20),Math.min(c.length,r.offset+r.length+10))})).map(r=>`${r.message} at ${r.offset}:${r.length} (${r.fragment})`),f=a.map(r=>`At ${r.offset}:${r.length} - (${r.content})`);throw new Error(`VS Code configuration file (.vscode/launch.json) is not valid a JSONC after CLI modifications. This is likely a CLI bug. Please report it at https://github.com/WordPress/wordpress-playground/issues and include the contents of your ".vscode/launch.json" file. 

 Applied edits: ${f.join(`
`)}

 The errors are: ${h.join(`
`)}`)}return c}function $(o){return o.replaceAll(S.sep,S.posix.sep)}exports.addXdebugIDEConfig=V;exports.clearXdebugIDEConfig=q;exports.createTempDirSymlink=_;exports.removeTempDirSymlink=B;exports.updatePhpStormConfig=k;exports.updateVSCodeConfig=M;
//# sourceMappingURL=index.cjs.map
