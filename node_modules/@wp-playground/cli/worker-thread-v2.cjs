"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const x=require("@php-wasm/logger"),g=require("@php-wasm/node"),M=require("@php-wasm/progress"),p=require("@php-wasm/universal"),$=require("@php-wasm/util"),S=require("@wp-playground/blueprints"),_=require("@wp-playground/wordpress"),B=require("fs"),W=require("path"),F=require("tls"),I=require("worker_threads"),E=require("wasm-feature-detect"),H=require("./run-cli-D8BNUM1f.cjs");async function b(s,e){for(const r of e)try{s.mkdir(r.vfsPath),await s.mount(r.vfsPath,g.createNodeFsMountHandler(r.hostPath))}catch{i.stderr(`\x1B[31m\x1B[1mError mounting path ${r.hostPath} at ${r.vfsPath}\x1B[0m
`),process.exit(1)}}function L(s,e,...r){console.log(performance.now().toFixed(6).padStart(15,"0"),s.toString().padStart(16,"0"),$.sprintf(e,...r))}Object.defineProperty(process.stdout,"isTTY",{value:!0});Object.defineProperty(process.stderr,"isTTY",{value:!0});const i={lastWriteWasProgress:!1,progress(s){H.shouldRenderProgress(process.stdout)&&(process.stdout.isTTY?(i.lastWriteWasProgress||process.stdout.write(`
`),process.stdout.write("\r\x1B[K"+s),i.lastWriteWasProgress=!0):console.log(s))},stdout(s){process.stdout.write(`


`),i.lastWriteWasProgress&&(i.lastWriteWasProgress=!1),process.stdout.write(s)},stderr(s){process.stdout.write(`


`),i.lastWriteWasProgress&&(i.lastWriteWasProgress=!1),process.stderr.write(s)}};class R extends p.PHPWorker{constructor(e){super(void 0,e),this.booted=!1,this.blueprintTargetResolved=!1,this.phpInstancesThatNeedMountsAfterTargetResolved=new Set}async useFileLockManager(e){await E.jspi()?this.fileLockManager=p.consumeAPI(e):this.fileLockManager=await p.consumeAPISync(e)}async bootAndSetUpInitialWorker(e){const r={WP_DEBUG:!0,WP_DEBUG_LOG:!0,WP_DEBUG_DISPLAY:!1},u={...e,createFiles:{"/internal/shared/ca-bundle.crt":F.rootCertificates.join(`
`)},constants:r,phpIniEntries:{"openssl.cafile":"/internal/shared/ca-bundle.crt"},onPHPInstanceCreated:async n=>{await b(n,e.mountsBeforeWpInstall||[]),this.blueprintTargetResolved?await b(n,e.mountsAfterWpInstall||[]):(this.phpInstancesThatNeedMountsAfterTargetResolved.add(n),n.addEventListener("runtime.beforeExit",()=>{this.phpInstancesThatNeedMountsAfterTargetResolved.delete(n)}))},spawnHandler:()=>p.sandboxedSpawnHandlerFactory(()=>T(e,this.fileLockManager))};await this.bootRequestHandler(u);const w=this.__internal_getPHP();if(e.mode==="mount-only"){await b(w,e.mountsAfterWpInstall||[]);return}await this.runBlueprintV2({...e,mountsAfterWpInstall:e.mountsAfterWpInstall||[]})}async bootWorker(e){await this.bootRequestHandler({...e,onPHPInstanceCreated:async r=>{await b(r,e.mountsBeforeWpInstall||[]),await b(r,e.mountsAfterWpInstall||[]),r.isDir("/wordpress/wp-content")||r.mkdir("/wordpress/wp-content"),r.isDir("/wordpress/wp-content/database")||r.mkdir("/wordpress/wp-content/database"),r.isFile("/wordpress/wp-content/database/.htaccess")||r.writeFile("/wordpress/wp-content/database/.htaccess","deny from all"),r.isFile("/wordpress/wp-content/database/index.php")||r.writeFile("/wordpress/wp-content/database/index.php","deny from all")},spawnHandler:()=>p.sandboxedSpawnHandlerFactory(()=>T(e,this.fileLockManager))})}async runBlueprintV2(e){const r=this.__internal_getRequestHandler(),{php:u,reap:w}=await r.instanceManager.acquirePHPInstance({considerPrimary:!1}),n=this.__internal_getPHP();let h=()=>{};if(typeof e.blueprint=="string"){const o=W.resolve(process.cwd(),e.blueprint);B.existsSync(o)&&(n.mkdir("/internal/shared/cwd"),h=await n.mount("/internal/shared/cwd",g.createNodeFsMountHandler(W.dirname(o))),e.blueprint=W.join("/internal/shared/cwd",W.basename(e.blueprint)))}try{const l=["mode","db-engine","db-host","db-user","db-pass","db-name","db-path","truncate-new-site-directory","allow"].filter(t=>t in e).map(t=>`--${t}=${e[t]}`);l.push(`--site-url=${e.siteUrl}`);const c=await S.runBlueprintV2({php:u,blueprint:e.blueprint,blueprintOverrides:{additionalSteps:e["additional-blueprint-steps"],wordpressVersion:e.wp},cliArgs:l,onMessage:async t=>{switch(t.type){case"blueprint.target_resolved":{if(!this.blueprintTargetResolved){this.blueprintTargetResolved=!0;for(const a of this.phpInstancesThatNeedMountsAfterTargetResolved)this.phpInstancesThatNeedMountsAfterTargetResolved.delete(a),await b(a,e.mountsAfterWpInstall||[])}break}case"blueprint.progress":{const a=`${t.caption.trim()} â€“ ${t.progress.toFixed(2)}%`;i.progress(a);break}case"blueprint.error":{const a="\x1B[31m",f="\x1B[1m",P="\x1B[0m";e.debug&&t.details?i.stderr(`${a}${f}Fatal error:${P} Uncaught ${t.details.exception}: ${t.details.message}
  at ${t.details.file}:${t.details.line}
`+(t.details.trace?t.details.trace+`
`:"")):i.stderr(`${a}${f}Error:${P} ${t.message}
`);break}}}});if(e.debug&&(c.stdout.pipeTo(new WritableStream({write(t){process.stdout.write(t)}})),c.stderr.pipeTo(new WritableStream({write(t){process.stderr.write(t)}}))),await c.finished,await c.exitCode!==0){const t=await p.PHPResponse.fromStreamedResponse(c);throw new p.PHPExecutionFailureError(`PHP.run() failed with exit code ${t.exitCode}. ${t.errors} ${t.text}`,t,"request")}}catch(o){let l="";try{l=u.readFileAsText(x.errorLogPath)}catch{}throw o.phpLogs=l,o}finally{w(),h()}}async bootRequestHandler({siteUrl:e,allow:r,phpVersion:u,createFiles:w,constants:n,phpIniEntries:h,firstProcessId:o,processIdSpaceLength:l,trace:c,nativeInternalDirPath:t,withIntl:a,withXdebug:f,onPHPInstanceCreated:P,spawnHandler:y}){if(this.booted)throw new Error("Playground already booted");this.booted=!0;let d=o;const q=o+l-1;try{const m=await _.bootRequestHandler({siteUrl:e,createPhpRuntime:async()=>{const A=d;return d<q?d++:d=o,await g.loadNodeRuntime(u,{emscriptenOptions:{fileLockManager:this.fileLockManager,processId:A,trace:c?L:void 0,ENV:{DOCROOT:"/wordpress"},phpWasmInitOptions:{nativeInternalDirPath:t}},followSymlinks:r?.includes("follow-symlinks"),withIntl:a,withXdebug:f})},maxPhpInstances:1,onPHPInstanceCreated:P,sapiName:"cli",createFiles:w,constants:n,phpIniEntries:h,cookieStore:!1,spawnHandler:y});this.__internal_setRequestHandler(m);const v=await m.getPrimaryPhp();await this.setPrimaryPHP(v),C()}catch(m){throw O(m),m}}async dispose(){await this[Symbol.asyncDispose]()}}async function T({siteUrl:s,allow:e,phpVersion:r,createFiles:u,constants:w,phpIniEntries:n,firstProcessId:h,processIdSpaceLength:o,trace:l,nativeInternalDirPath:c,withXdebug:t,mountsBeforeWpInstall:a,mountsAfterWpInstall:f},P){const y=await H.spawnWorkerThread("v2"),d=p.consumeAPI(y.phpPort);return d.useFileLockManager(P),await d.bootWorker({siteUrl:s,allow:e,phpVersion:r,createFiles:u,constants:w,phpIniEntries:n,firstProcessId:h,processIdSpaceLength:o,trace:l,nativeInternalDirPath:c,withXdebug:t,mountsBeforeWpInstall:a,mountsAfterWpInstall:f}),{php:d,reap:()=>{try{d.dispose()}catch{}try{y.worker.terminate()}catch{}}}}process.on("unhandledRejection",s=>{x.logger.error("Unhandled rejection:",s)});const k=new I.MessageChannel,[C,O]=p.exposeAPI(new R(new M.EmscriptenDownloadMonitor),void 0,k.port1);I.parentPort?.postMessage({command:"worker-script-initialized",phpPort:k.port2},[k.port2]);exports.PlaygroundCliBlueprintV2Worker=R;
//# sourceMappingURL=worker-thread-v2.cjs.map
