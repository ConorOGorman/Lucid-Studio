"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const W=require("@php-wasm/node"),R=require("@php-wasm/progress"),s=require("@php-wasm/universal"),S=require("@php-wasm/util"),_=require("@wp-playground/common"),w=require("@wp-playground/wordpress"),v=require("tls"),M=require("wasm-feature-detect"),I=require("worker_threads"),o=require("./run-cli-D8BNUM1f.cjs"),A=require("@php-wasm/logger");function L(r,e,...t){console.log(performance.now().toFixed(6).padStart(15,"0"),r.toString().padStart(16,"0"),S.sprintf(e,...t))}class k extends s.PHPWorker{constructor(e){super(void 0,e),this.booted=!1}async useFileLockManager(e){await M.jspi()?this.fileLockManager=s.consumeAPI(e):this.fileLockManager=await s.consumeAPISync(e)}async bootAndSetUpInitialWorker(e){const{siteUrl:t,mountsBeforeWpInstall:a,mountsAfterWpInstall:n,wordpressInstallMode:b,wordPressZip:c,sqliteIntegrationPluginZip:d,dataSqlPath:q,internalCookieStore:H}=e;if(this.booted)throw new Error("Playground already booted");this.booted=!0;try{const i={WP_DEBUG:!0,WP_DEBUG_LOG:!0,WP_DEBUG_DISPLAY:!1};let u=!1;const p=await w.bootWordPressAndRequestHandler({siteUrl:t,createPhpRuntime:m(e,this.fileLockManager),wordpressInstallMode:b,wordPressZip:c!==void 0?new File([c],"wordpress.zip"):void 0,sqliteIntegrationPluginZip:d!==void 0?new File([d],"sqlite-integration-plugin.zip"):void 0,sapiName:"cli",createFiles:{"/internal/shared/ca-bundle.crt":v.rootCertificates.join(`
`)},constants:i,phpIniEntries:{"openssl.cafile":"/internal/shared/ca-bundle.crt",allow_url_fopen:"1",disable_functions:""},cookieStore:H?void 0:!1,dataSqlPath:q,spawnHandler:()=>s.sandboxedSpawnHandlerFactory(()=>y(e,this.fileLockManager)),async onPHPInstanceCreated(P){await o.mountResources(P,a),u&&await o.mountResources(P,n)}});this.__internal_setRequestHandler(p),u=!0;const h=await p.getPrimaryPhp();await this.setPrimaryPHP(h),await o.mountResources(h,n),f()}catch(i){throw g(i),i}}async hello(){return"hello"}async bootWorker(e){await this.bootRequestHandler(e)}async bootRequestHandler(e){if(this.booted)throw new Error("Playground already booted");this.booted=!0;try{const t=await w.bootRequestHandler({siteUrl:e.siteUrl,createPhpRuntime:m(e,this.fileLockManager),onPHPInstanceCreated:async n=>{await o.mountResources(n,e.mountsBeforeWpInstall),await o.mountResources(n,e.mountsAfterWpInstall)},sapiName:"cli",cookieStore:!1,spawnHandler:()=>s.sandboxedSpawnHandlerFactory(()=>y(e,this.fileLockManager))});this.__internal_setRequestHandler(t);const a=await t.getPrimaryPhp();await this.setPrimaryPHP(a),f()}catch(t){throw g(t),t}}async dispose(){await this[Symbol.asyncDispose]()}}function m(r,e){let t=r.firstProcessId;const a=r.firstProcessId+r.processIdSpaceLength-1;return async()=>{const n=t;return t<a?t++:t=r.firstProcessId,await W.loadNodeRuntime(r.phpVersion||_.RecommendedPHPVersion,{emscriptenOptions:{fileLockManager:e,processId:n,trace:r.trace?L:void 0,phpWasmInitOptions:{nativeInternalDirPath:r.nativeInternalDirPath}},followSymlinks:r.followSymlinks,withIntl:r.withIntl,withXdebug:r.withXdebug})}}async function y(r,e){const t=await o.spawnWorkerThread("v1"),a=s.consumeAPI(t.phpPort);return a.useFileLockManager(e),await a.bootWorker(r),{php:a,reap:()=>{try{a.dispose()}catch{}try{t.worker.terminate()}catch{}}}}process.on("unhandledRejection",r=>{A.logger.error("Unhandled rejection:",r)});const l=new I.MessageChannel,[f,g]=s.exposeAPI(new k(new R.EmscriptenDownloadMonitor),void 0,l.port1);I.parentPort?.postMessage({command:"worker-script-initialized",phpPort:l.port2},[l.port2]);exports.PlaygroundCliBlueprintV1Worker=k;
//# sourceMappingURL=worker-thread-v1.cjs.map
