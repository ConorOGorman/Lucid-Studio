{"version":3,"file":"run-cli-D8BNUM1f.cjs","sources":["../../../../packages/playground/cli/src/mounts.ts","../../../../packages/playground/cli/src/start-server.ts","../../../../packages/playground/cli/src/load-balancer.ts","../../../../packages/playground/cli/src/is-valid-wordpress-slug.ts","../../../../packages/playground/cli/src/resolve-blueprint.ts","../../../../packages/playground/cli/src/utils/progress.ts","../../../../packages/playground/cli/src/blueprints-v2/blueprints-v2-handler.ts","../../../../packages/playground/cli/src/blueprints-v1/download.ts","../../../../packages/playground/cli/src/blueprints-v1/blueprints-v1-handler.ts","../../../../packages/playground/cli/src/temp-dir.ts","../../../../packages/playground/cli/src/run-cli.ts"],"sourcesContent":["import { createNodeFsMountHandler } from '@php-wasm/node';\nimport type { PHP } from '@php-wasm/universal';\nimport fs, { existsSync } from 'fs';\nimport path, { basename, join } from 'path';\nimport type { RunCLIArgs } from './run-cli';\nimport type { Mount } from '@php-wasm/cli-util';\n\n/**\n * Parse an array of mount argument strings where the host path and VFS path\n * are separated by a colon.\n *\n * Example:\n *     parseMountWithDelimiterArguments( [ '/host/path:/vfs/path', '/host/path:/vfs/path' ] )\n *     // returns:\n *     [\n *         { hostPath: '/host/path', vfsPath: '/vfs/path' },\n *         { hostPath: '/host/path', vfsPath: '/vfs/path' }\n *     ]\n *\n * @param mounts - An array of mount argument strings separated by a colon.\n * @returns An array of Mount objects.\n */\nexport function parseMountWithDelimiterArguments(mounts: string[]): Mount[] {\n\tconst parsedMounts = [];\n\tfor (const mount of mounts) {\n\t\tconst mountParts = mount.split(':');\n\t\tif (mountParts.length !== 2) {\n\t\t\tthrow new Error(`Invalid mount format: ${mount}.\n\t\t\t\tExpected format: /host/path:/vfs/path.\n\t\t\t\tIf your path contains a colon, e.g. C:\\\\myplugin, use the --mount-dir option instead.\n\t\t\t\tExample: --mount-dir C:\\\\my-plugin /wordpress/wp-content/plugins/my-plugin`);\n\t\t}\n\t\tconst [hostPath, vfsPath] = mountParts;\n\t\tif (!existsSync(hostPath)) {\n\t\t\tthrow new Error(`Host path does not exist: ${hostPath}`);\n\t\t}\n\t\tparsedMounts.push({ hostPath, vfsPath });\n\t}\n\treturn parsedMounts;\n}\n\n/**\n * Parse an array of mount argument strings where each odd array element is a host path\n * and each even element is the VFS path.\n * e.g. [ '/host/path', '/vfs/path', '/host/path2', '/vfs/path2' ]\n *\n * The result will be an array of Mount objects for each host path the\n * following element is it's VFS path.\n * e.g. [\n *   { hostPath: '/host/path', vfsPath: '/vfs/path' },\n *   { hostPath: '/host/path2', vfsPath: '/vfs/path2' }\n * ]\n *\n * @param mounts - An array of paths\n * @returns An array of Mount objects.\n */\nexport function parseMountDirArguments(mounts: string[]): Mount[] {\n\tif (mounts.length % 2 !== 0) {\n\t\tthrow new Error('Invalid mount format. Expected: /host/path /vfs/path');\n\t}\n\n\tconst parsedMounts = [];\n\tfor (let i = 0; i < mounts.length; i += 2) {\n\t\tconst source = mounts[i];\n\t\tconst vfsPath = mounts[i + 1];\n\t\tif (!existsSync(source)) {\n\t\t\tthrow new Error(`Host path does not exist: ${source}`);\n\t\t}\n\t\tparsedMounts.push({\n\t\t\thostPath: path.resolve(process.cwd(), source),\n\t\t\tvfsPath,\n\t\t});\n\t}\n\treturn parsedMounts;\n}\n\nexport async function mountResources(php: PHP, mounts: Mount[]) {\n\tfor (const mount of mounts) {\n\t\tawait php.mount(\n\t\t\tmount.vfsPath,\n\t\t\tcreateNodeFsMountHandler(mount.hostPath)\n\t\t);\n\t}\n}\n\nconst ACTIVATE_FIRST_THEME_STEP = {\n\tstep: 'runPHP',\n\tcode: {\n\t\tfilename: 'activate-theme.php',\n\t\t// @TODO: Remove DOCROOT check after moving totally to Blueprints v2.\n\t\tcontent: `<?php\n\t\t\t$docroot = getenv('DOCROOT') ? getenv('DOCROOT') : '/wordpress';\n\t\t\trequire_once \"$docroot/wp-load.php\";\n\t\t\t$theme = wp_get_theme();\n\t\t\tif (!$theme->exists()) {\n\t\t\t\t$themes = wp_get_themes();\n\t\t\t\tif (count($themes) > 0) {\n\t\t\t\t\t$themeName = array_keys($themes)[0];\n\t\t\t\t\tswitch_theme($themeName);\n\t\t\t\t}\n\t\t\t}\n\t\t`,\n\t},\n};\n\n/**\n * Auto-mounts resolution logic:\n */\nexport function expandAutoMounts(args: RunCLIArgs): RunCLIArgs {\n\tconst path = args.autoMount!;\n\n\tconst mount = [...(args.mount || [])];\n\tconst mountBeforeInstall = [...(args['mount-before-install'] || [])];\n\n\tconst newArgs = {\n\t\t...args,\n\t\tmount,\n\t\t'mount-before-install': mountBeforeInstall,\n\t\t'additional-blueprint-steps': [\n\t\t\t...((args as any)['additional-blueprint-steps'] || []),\n\t\t],\n\t};\n\n\tif (isPluginFilename(path)) {\n\t\tconst pluginName = basename(path);\n\t\tmount.push({\n\t\t\thostPath: path,\n\t\t\tvfsPath: `/wordpress/wp-content/plugins/${pluginName}`,\n\t\t});\n\t\tnewArgs['additional-blueprint-steps'].push({\n\t\t\tstep: 'activatePlugin',\n\t\t\tpluginPath: `/wordpress/wp-content/plugins/${basename(path)}`,\n\t\t});\n\t} else if (isThemeDirectory(path)) {\n\t\tconst themeName = basename(path);\n\t\tmount.push({\n\t\t\thostPath: path,\n\t\t\tvfsPath: `/wordpress/wp-content/themes/${themeName}`,\n\t\t});\n\t\tnewArgs['additional-blueprint-steps'].push(\n\t\t\targs['experimental-blueprints-v2-runner']\n\t\t\t\t? {\n\t\t\t\t\t\tstep: 'activateTheme',\n\t\t\t\t\t\tthemeDirectoryName: themeName,\n\t\t\t\t\t}\n\t\t\t\t: {\n\t\t\t\t\t\tstep: 'activateTheme',\n\t\t\t\t\t\tthemeFolderName: themeName,\n\t\t\t\t\t}\n\t\t);\n\t} else if (containsWpContentDirectories(path)) {\n\t\t/**\n\t\t * Mount each wp-content file and directory individually.\n\t\t */\n\t\tconst files = fs.readdirSync(path);\n\t\tfor (const file of files) {\n\t\t\t/**\n\t\t\t * WordPress already ships with the wp-content/index.php file\n\t\t\t * and Playground does not support overriding existing VFS files\n\t\t\t * with mounts.\n\t\t\t */\n\t\t\tif (file === 'index.php') {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tmount.push({\n\t\t\t\thostPath: `${path}/${file}`,\n\t\t\t\tvfsPath: `/wordpress/wp-content/${file}`,\n\t\t\t});\n\t\t}\n\t\tnewArgs['additional-blueprint-steps'].push(ACTIVATE_FIRST_THEME_STEP);\n\t} else if (containsFullWordPressInstallation(path)) {\n\t\tmountBeforeInstall.push({ hostPath: path, vfsPath: '/wordpress' });\n\t\t// @TODO: If overriding another mode, throw an error or print a warning.\n\t\tnewArgs.mode = 'apply-to-existing-site';\n\t\tnewArgs['additional-blueprint-steps'].push(ACTIVATE_FIRST_THEME_STEP);\n\t\tif (!newArgs.wordpressInstallMode) {\n\t\t\tnewArgs.wordpressInstallMode =\n\t\t\t\t'install-from-existing-files-if-needed';\n\t\t}\n\t} else {\n\t\t/**\n\t\t * By default, mount the current working directory as the Playground root.\n\t\t * This allows users to run and PHP or HTML files using the Playground CLI.\n\t\t */\n\t\tmount.push({ hostPath: path, vfsPath: '/wordpress' });\n\t\t// @TODO: If overriding another mode, throw an error or print a warning.\n\t\tnewArgs.mode = 'mount-only';\n\t}\n\n\treturn newArgs as RunCLIArgs;\n}\n\nexport function containsFullWordPressInstallation(path: string): boolean {\n\tconst files = fs.readdirSync(path);\n\treturn (\n\t\tfiles.includes('wp-admin') &&\n\t\tfiles.includes('wp-includes') &&\n\t\tfiles.includes('wp-content')\n\t);\n}\n\nexport function containsWpContentDirectories(path: string): boolean {\n\tconst files = fs.readdirSync(path);\n\treturn (\n\t\tfiles.includes('themes') ||\n\t\tfiles.includes('plugins') ||\n\t\tfiles.includes('mu-plugins') ||\n\t\tfiles.includes('uploads')\n\t);\n}\n\nexport function isThemeDirectory(path: string): boolean {\n\tconst files = fs.readdirSync(path);\n\tif (!files.includes('style.css')) {\n\t\treturn false;\n\t}\n\tconst styleCssContent = fs.readFileSync(join(path, 'style.css'), 'utf8');\n\tconst themeNameRegex = /^(?:[ \\t]*<\\?php)?[ \\t/*#@]*Theme Name:(.*)$/im;\n\treturn !!themeNameRegex.exec(styleCssContent);\n}\n\nexport function isPluginFilename(path: string): boolean {\n\tconst files = fs.readdirSync(path);\n\tconst pluginNameRegex = /^(?:[ \\t]*<\\?php)?[ \\t/*#@]*Plugin Name:(.*)$/im;\n\tconst pluginNameMatch = files\n\t\t.filter((file) => file.endsWith('.php'))\n\t\t.find((file) => {\n\t\t\tconst fileContent = fs.readFileSync(join(path, file), 'utf8');\n\t\t\treturn !!pluginNameRegex.exec(fileContent);\n\t\t});\n\treturn !!pluginNameMatch;\n}\n","import { type PHPRequest, PHPResponse } from '@php-wasm/universal';\nimport type { Request } from 'express';\nimport express from 'express';\nimport type { IncomingMessage, Server, ServerResponse } from 'http';\nimport type { AddressInfo } from 'net';\nimport type { RunCLIServer } from './run-cli';\nimport { logger } from '@php-wasm/logger';\n\nexport interface ServerOptions {\n\tport: number;\n\tonBind: (server: Server, port: number) => Promise<RunCLIServer | void>;\n\thandleRequest: (request: PHPRequest) => Promise<PHPResponse>;\n}\n\nexport async function startServer(\n\toptions: ServerOptions\n): Promise<RunCLIServer | void> {\n\tconst app = express();\n\n\tconst server = await new Promise<\n\t\tServer<typeof IncomingMessage, typeof ServerResponse>\n\t>((resolve, reject) => {\n\t\tconst server = app.listen(options.port, () => {\n\t\t\tconst address = server.address();\n\t\t\tif (address === null || typeof address === 'string') {\n\t\t\t\treject(new Error('Server address is not available'));\n\t\t\t} else {\n\t\t\t\tresolve(server);\n\t\t\t}\n\t\t});\n\t});\n\n\tapp.use('/', async (req, res) => {\n\t\tlet phpResponse: PHPResponse;\n\t\ttry {\n\t\t\tphpResponse = await options.handleRequest({\n\t\t\t\turl: req.url,\n\t\t\t\theaders: parseHeaders(req),\n\t\t\t\tmethod: req.method as any,\n\t\t\t\tbody: await bufferRequestBody(req),\n\t\t\t});\n\t\t} catch (error) {\n\t\t\tlogger.error(error);\n\t\t\tphpResponse = PHPResponse.forHttpCode(500);\n\t\t}\n\n\t\tres.statusCode = phpResponse.httpStatusCode;\n\t\tfor (const key in phpResponse.headers) {\n\t\t\tres.setHeader(key, phpResponse.headers[key]);\n\t\t}\n\t\tres.end(phpResponse.bytes);\n\t});\n\n\tconst address = server.address();\n\tconst port = (address! as AddressInfo).port;\n\treturn await options.onBind(server, port);\n}\n\nconst bufferRequestBody = async (req: Request): Promise<Uint8Array> =>\n\tawait new Promise((resolve) => {\n\t\tconst body: Uint8Array[] = [];\n\t\treq.on('data', (chunk) => {\n\t\t\tbody.push(chunk);\n\t\t});\n\t\treq.on('end', () => {\n\t\t\tresolve(new Uint8Array(Buffer.concat(body)));\n\t\t});\n\t});\n\nconst parseHeaders = (req: Request): Record<string, string> => {\n\tconst requestHeaders: Record<string, string> = {};\n\tif (req.rawHeaders && req.rawHeaders.length) {\n\t\tfor (let i = 0; i < req.rawHeaders.length; i += 2) {\n\t\t\trequestHeaders[req.rawHeaders[i].toLowerCase()] =\n\t\t\t\treq.rawHeaders[i + 1];\n\t\t}\n\t}\n\treturn requestHeaders;\n};\n","import type { PHPRequest, PHPResponse, RemoteAPI } from '@php-wasm/universal';\nimport type { PlaygroundCliBlueprintV1Worker as PlaygroundCliWorkerV1 } from './blueprints-v1/worker-thread-v1';\nimport type { PlaygroundCliBlueprintV2Worker as PlaygroundCliWorkerV2 } from './blueprints-v2/worker-thread-v2';\n\ntype PlaygroundCliWorker = PlaygroundCliWorkerV1 | PlaygroundCliWorkerV2;\n\n// TODO: Let's merge worker management into PHPProcessManager\n// when we can have multiple workers in both CLI and web.\n// ¡ATTENTION!:Please don't expand upon this as an independent abstraction.\n\n// TODO: Could we just spawn a worker using the factory function to PHPProcessManager?\ntype WorkerLoad = {\n\tworker: RemoteAPI<PlaygroundCliWorker>;\n\tactiveRequests: Set<Promise<PHPResponse>>;\n};\nexport class LoadBalancer {\n\tworkerLoads: WorkerLoad[] = [];\n\n\tconstructor(\n\t\t// NOTE: We require a worker to start so that a load balancer\n\t\t// may not exist without being able to service requests.\n\t\t// Playground CLI initialization, as of 2025-06-11, requires that\n\t\t// an initial worker is booted alone and initialized via Blueprint\n\t\t// before additional workers are created based on the initialized worker.\n\t\tinitialWorker: RemoteAPI<PlaygroundCliWorker>\n\t) {\n\t\tthis.addWorker(initialWorker);\n\t}\n\n\taddWorker(worker: RemoteAPI<PlaygroundCliWorker>) {\n\t\tthis.workerLoads.push({\n\t\t\tworker,\n\t\t\tactiveRequests: new Set(),\n\t\t});\n\t}\n\tasync removeWorker(worker: RemoteAPI<PlaygroundCliWorker>) {\n\t\tconst workerIndex = this.workerLoads.findIndex(\n\t\t\t(workerLoad) => workerLoad.worker === worker\n\t\t);\n\t\tif (workerIndex === -1) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst [removedWorker] = this.workerLoads.splice(workerIndex, 1);\n\n\t\t// A worker can only be considered fully removed once all\n\t\t// its active requests have settled.\n\t\tawait Promise.allSettled(removedWorker.activeRequests);\n\t}\n\n\tasync handleRequest(request: PHPRequest) {\n\t\tlet smallestWorkerLoad = this.workerLoads[0];\n\n\t\t// TODO: Is there any way for us to track CPU load so we could avoid\n\t\t//       picking a worker that is under heavy load despite few requests?\n\t\t// Possibly this: https://nodejs.org/api/worker_threads.html#workerperformance\n\t\t// Though we probably don't need to worry about it.\n\t\tfor (let i = 1; i < this.workerLoads.length; i++) {\n\t\t\tconst workerLoad = this.workerLoads[i];\n\t\t\tif (\n\t\t\t\tworkerLoad.activeRequests.size <\n\t\t\t\tsmallestWorkerLoad.activeRequests.size\n\t\t\t) {\n\t\t\t\tsmallestWorkerLoad = workerLoad;\n\t\t\t}\n\t\t}\n\n\t\t// TODO: Add trace facility to Playground CLI to observe internals like request routing.\n\n\t\tconst promiseForResponse = smallestWorkerLoad.worker.request(request);\n\t\tsmallestWorkerLoad.activeRequests.add(promiseForResponse);\n\n\t\t// Add URL to promise for use while debugging\n\t\t(promiseForResponse as any).url = request.url;\n\n\t\treturn promiseForResponse.finally(() => {\n\t\t\tsmallestWorkerLoad.activeRequests.delete(promiseForResponse);\n\t\t});\n\t}\n}\n","/**\n * Checks if the given version string is a valid WordPress version.\n *\n * The Regex is based on the releases on https://wordpress.org/download/releases/#betas\n * The version string can be one of the following formats:\n * - \"latest\"\n * - \"trunk\"\n * - \"trunk\" (legacy alias: \"nightly\")\n * - \"x.y\" (x and y are integers) e.g. \"6.2\"\n * - \"x.y.z\" (x, y and z are integers) e.g. \"6.2.1\"\n * - \"x.y.z-betaN\" (N is an integer) e.g. \"6.2.1-beta1\"\n * - \"x.y.z-RCN\" (N is an integer) e.g. \"6.2-RC1\"\n *\n * @param version The version string to check.\n * @returns A boolean value indicating whether the version string is a valid WordPress version.\n */\nexport function isValidWordPressSlug(version: string): boolean {\n\tconst versionPattern =\n\t\t/^latest$|^trunk$|^nightly$|^(?:(\\d+)\\.(\\d+)(?:\\.(\\d+))?)((?:-beta(?:\\d+)?)|(?:-RC(?:\\d+)?))?$/;\n\treturn versionPattern.test(version);\n}\n","import fs from 'fs';\nimport path from 'path';\nimport {\n\tZipFilesystem,\n\tNodeJsFilesystem,\n\tOverlayFilesystem,\n\tInMemoryFilesystem,\n} from '@wp-playground/storage';\nimport { resolveRemoteBlueprint } from '@wp-playground/blueprints';\n\ntype ResolveBlueprintOptions = {\n\tsourceString: string | undefined;\n\tblueprintMayReadAdjacentFiles: boolean;\n};\n\n/**\n * Resolves a blueprint from a URL or a local path.\n *\n * @TODO: Extract the common Blueprint resolution logic between CLI and\n *        the website into a single, isomorphic resolveBlueprint() function.\n *        Still retain the CLI-specific bits in the CLI package.\n *\n * @param sourceString - The source string to resolve the blueprint from.\n * @param blueprintMayReadAdjacentFiles - Whether the blueprint may read adjacent files.\n * @returns The resolved blueprint.\n */\nexport async function resolveBlueprint({\n\tsourceString,\n\tblueprintMayReadAdjacentFiles,\n}: ResolveBlueprintOptions) {\n\tif (!sourceString) {\n\t\treturn undefined;\n\t}\n\n\tif (\n\t\tsourceString.startsWith('http://') ||\n\t\tsourceString.startsWith('https://')\n\t) {\n\t\treturn await resolveRemoteBlueprint(sourceString);\n\t}\n\n\t// If the sourceString does not refer to a remote blueprint, try to\n\t// resolve it from a local filesystem.\n\n\tlet blueprintPath = path.resolve(process.cwd(), sourceString);\n\tif (!fs.existsSync(blueprintPath)) {\n\t\tthrow new Error(`Blueprint file does not exist: ${blueprintPath}`);\n\t}\n\n\tconst stat = fs.statSync(blueprintPath);\n\tif (stat.isDirectory()) {\n\t\tblueprintPath = path.join(blueprintPath, 'blueprint.json');\n\t}\n\n\tif (!stat.isFile() && stat.isSymbolicLink()) {\n\t\tthrow new Error(\n\t\t\t`Blueprint path is neither a file nor a directory: ${blueprintPath}`\n\t\t);\n\t}\n\n\tconst extension = path.extname(blueprintPath);\n\tswitch (extension) {\n\t\tcase '.zip':\n\t\t\treturn ZipFilesystem.fromArrayBuffer(\n\t\t\t\tfs.readFileSync(blueprintPath).buffer as ArrayBuffer\n\t\t\t);\n\t\tcase '.json': {\n\t\t\tconst blueprintText = fs.readFileSync(blueprintPath, 'utf-8');\n\t\t\ttry {\n\t\t\t\tJSON.parse(blueprintText);\n\t\t\t} catch {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`Blueprint file at ${blueprintPath} is not a valid JSON file`\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst contextPath = path.dirname(blueprintPath);\n\t\t\tconst nodeJsFilesystem = new NodeJsFilesystem(contextPath);\n\t\t\treturn new OverlayFilesystem([\n\t\t\t\tnew InMemoryFilesystem({\n\t\t\t\t\t'blueprint.json': blueprintText,\n\t\t\t\t}),\n\t\t\t\t/**\n\t\t\t\t * Wrap the NodeJS filesystem to prevent access to local files\n\t\t\t\t * unless the user explicitly allowed it.\n\t\t\t\t */\n\t\t\t\t{\n\t\t\t\t\tread(path) {\n\t\t\t\t\t\tif (!blueprintMayReadAdjacentFiles) {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t`Error: Blueprint contained tried to read a local file at path \"${path}\" (via a resource of type \"bundled\"). ` +\n\t\t\t\t\t\t\t\t\t`Playground restricts access to local resources by default as a security measure. \\n\\n` +\n\t\t\t\t\t\t\t\t\t`You can allow this Blueprint to read files from the same parent directory by explicitly adding the ` +\n\t\t\t\t\t\t\t\t\t`--blueprint-may-read-adjacent-files option to your command.`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn nodeJsFilesystem.read(path);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t]);\n\t\t}\n\t\tdefault:\n\t\t\tthrow new Error(\n\t\t\t\t`Unsupported blueprint file extension: ${extension}. Only .zip and .json files are supported.`\n\t\t\t);\n\t}\n}\n","export function shouldRenderProgress(\n\twriteStream?: { isTTY?: boolean } | null\n): boolean {\n\tif (process.env['CI'] === 'true' || process.env['CI'] === '1') {\n\t\treturn false;\n\t}\n\tif (\n\t\tprocess.env['GITHUB_ACTIONS'] === 'true' ||\n\t\tprocess.env['GITHUB_ACTIONS'] === '1'\n\t) {\n\t\treturn false;\n\t}\n\tif ((process.env['TERM'] || '').toLowerCase() === 'dumb') {\n\t\treturn false;\n\t}\n\tif (writeStream) {\n\t\treturn Boolean(writeStream.isTTY);\n\t}\n\treturn process.stdout.isTTY;\n}\n","import type { RemoteAPI, SupportedPHPVersion } from '@php-wasm/universal';\nimport { consumeAPI } from '@php-wasm/universal';\nimport type {\n\tPlaygroundCliBlueprintV2Worker,\n\tSecondaryWorkerBootArgs,\n} from './worker-thread-v2';\nimport type { MessagePort as NodeMessagePort } from 'worker_threads';\nimport type { RunCLIArgs, SpawnedWorker, WorkerType } from '../run-cli';\nimport { shouldRenderProgress } from '../utils/progress';\n\n/**\n * Boots Playground CLI workers using Blueprint version 2.\n *\n * Progress tracking, downloads, steps, and all other features are\n * implemented in PHP and orchestrated by the worker thread.\n */\nexport class BlueprintsV2Handler {\n\tprivate phpVersion: SupportedPHPVersion;\n\tprivate lastProgressMessage = '';\n\n\tprivate siteUrl: string;\n\tprivate processIdSpaceLength: number;\n\tprivate args: RunCLIArgs;\n\n\tconstructor(\n\t\targs: RunCLIArgs,\n\t\toptions: {\n\t\t\tsiteUrl: string;\n\t\t\tprocessIdSpaceLength: number;\n\t\t}\n\t) {\n\t\tthis.args = args;\n\t\tthis.siteUrl = options.siteUrl;\n\t\tthis.processIdSpaceLength = options.processIdSpaceLength;\n\t\tthis.phpVersion = args.php as SupportedPHPVersion;\n\t}\n\n\tgetWorkerType(): WorkerType {\n\t\treturn 'v2';\n\t}\n\n\tasync bootAndSetUpInitialPlayground(\n\t\tphpPort: NodeMessagePort,\n\t\tfileLockManagerPort: NodeMessagePort,\n\t\tnativeInternalDirPath: string\n\t) {\n\t\tconst playground: RemoteAPI<PlaygroundCliBlueprintV2Worker> =\n\t\t\tconsumeAPI(phpPort);\n\n\t\tawait playground.useFileLockManager(fileLockManagerPort);\n\n\t\tconst workerBootArgs = {\n\t\t\t...this.args,\n\t\t\tphpVersion: this.phpVersion,\n\t\t\tsiteUrl: this.siteUrl,\n\t\t\tfirstProcessId: 1,\n\t\t\tprocessIdSpaceLength: this.processIdSpaceLength,\n\t\t\ttrace: this.args.debug || false,\n\t\t\tblueprint: this.args.blueprint!,\n\t\t\twithIntl: this.args.intl,\n\t\t\t// We do not enable Xdebug by default for the initial worker\n\t\t\t// because we do not imagine users expect to hit breakpoints\n\t\t\t// until Playground has fully booted.\n\t\t\t// TODO: Consider supporting Xdebug for the initial worker via a dedicated flag.\n\t\t\twithXdebug: false,\n\t\t\txdebug: undefined,\n\t\t\tnativeInternalDirPath,\n\t\t\tmountsBeforeWpInstall: this.args['mount-before-install'] || [],\n\t\t\tmountsAfterWpInstall: this.args.mount || [],\n\t\t};\n\n\t\tawait playground.bootAndSetUpInitialWorker(workerBootArgs);\n\t\treturn playground;\n\t}\n\n\tasync bootPlayground({\n\t\tworker,\n\t\tfileLockManagerPort,\n\t\tfirstProcessId,\n\t\tnativeInternalDirPath,\n\t}: {\n\t\tworker: SpawnedWorker;\n\t\tfileLockManagerPort: NodeMessagePort;\n\t\tfirstProcessId: number;\n\t\tnativeInternalDirPath: string;\n\t}) {\n\t\tconst playground: RemoteAPI<PlaygroundCliBlueprintV2Worker> =\n\t\t\tconsumeAPI(worker.phpPort);\n\n\t\tawait playground.useFileLockManager(fileLockManagerPort);\n\n\t\tconst workerBootArgs: SecondaryWorkerBootArgs = {\n\t\t\t...this.args,\n\t\t\tphpVersion: this.phpVersion,\n\t\t\tsiteUrl: this.siteUrl,\n\t\t\tfirstProcessId,\n\t\t\tprocessIdSpaceLength: this.processIdSpaceLength,\n\t\t\ttrace: this.args.debug || false,\n\t\t\twithIntl: this.args.intl,\n\t\t\twithXdebug: !!this.args.xdebug,\n\t\t\tnativeInternalDirPath,\n\t\t\tmountsBeforeWpInstall: this.args['mount-before-install'] || [],\n\t\t\tmountsAfterWpInstall: this.args.mount || [],\n\t\t};\n\n\t\tawait playground.bootWorker(workerBootArgs);\n\n\t\treturn playground;\n\t}\n\n\twriteProgressUpdate(\n\t\twriteStream: NodeJS.WriteStream,\n\t\tmessage: string,\n\t\tfinalUpdate: boolean\n\t) {\n\t\tif (!shouldRenderProgress(writeStream)) {\n\t\t\treturn;\n\t\t}\n\t\tif (message === this.lastProgressMessage) {\n\t\t\t// Avoid repeating the same message\n\t\t\treturn;\n\t\t}\n\t\tthis.lastProgressMessage = message;\n\n\t\tif (writeStream.isTTY) {\n\t\t\t// Overwrite previous progress updates in-place for a quieter UX.\n\t\t\twriteStream.cursorTo(0);\n\t\t\twriteStream.write(message);\n\t\t\twriteStream.clearLine(1);\n\n\t\t\tif (finalUpdate) {\n\t\t\t\twriteStream.write('\\n');\n\t\t\t}\n\t\t} else {\n\t\t\t// Fall back to writing one line per progress update\n\t\t\twriteStream.write(`${message}\\n`);\n\t\t}\n\t}\n}\n","import type { EmscriptenDownloadMonitor } from '@php-wasm/progress';\nimport fs from 'fs-extra';\nimport os from 'os';\nimport path, { basename } from 'path';\n\nexport const CACHE_FOLDER = path.join(os.homedir(), '.wordpress-playground');\n\nexport async function fetchSqliteIntegration(\n\tmonitor: EmscriptenDownloadMonitor\n) {\n\tconst sqliteZip = await cachedDownload(\n\t\t'https://github.com/WordPress/sqlite-database-integration/archive/refs/heads/develop.zip',\n\t\t'sqlite.zip',\n\t\tmonitor\n\t);\n\treturn sqliteZip;\n}\n\n// @TODO: Support HTTP cache, invalidate the local file if the remote file has\n// changed\nexport async function cachedDownload(\n\tremoteUrl: string,\n\tcacheKey: string,\n\tmonitor: EmscriptenDownloadMonitor\n) {\n\tconst artifactPath = path.join(CACHE_FOLDER, cacheKey);\n\tif (!fs.existsSync(artifactPath)) {\n\t\tfs.ensureDirSync(CACHE_FOLDER);\n\t\tawait downloadTo(remoteUrl, artifactPath, monitor);\n\t}\n\treturn readAsFile(artifactPath);\n}\n\nasync function downloadTo(\n\tremoteUrl: string,\n\tlocalPath: string,\n\tmonitor: EmscriptenDownloadMonitor\n) {\n\tconst response = await monitor.monitorFetch(fetch(remoteUrl));\n\tconst reader = response.body!.getReader();\n\tconst tmpPath = `${localPath}.partial`;\n\tconst writer = fs.createWriteStream(tmpPath);\n\twhile (true) {\n\t\tconst { done, value } = await reader.read();\n\t\tif (value) {\n\t\t\twriter.write(value);\n\t\t}\n\t\tif (done) {\n\t\t\tbreak;\n\t\t}\n\t}\n\twriter.close();\n\tif (!writer.closed) {\n\t\tawait new Promise((resolve, reject) => {\n\t\t\twriter.on('finish', () => {\n\t\t\t\tfs.renameSync(tmpPath, localPath);\n\t\t\t\tresolve(null);\n\t\t\t});\n\t\t\twriter.on('error', (err: any) => {\n\t\t\t\tfs.removeSync(tmpPath);\n\t\t\t\treject(err);\n\t\t\t});\n\t\t});\n\t}\n}\n\nexport function readAsFile(path: string, fileName?: string): File {\n\treturn new File([fs.readFileSync(path)], fileName ?? basename(path));\n}\n","import { logger } from '@php-wasm/logger';\nimport { EmscriptenDownloadMonitor, ProgressTracker } from '@php-wasm/progress';\nimport { consumeAPI } from '@php-wasm/universal';\nimport type { BlueprintV1Declaration } from '@wp-playground/blueprints';\nimport {\n\tcompileBlueprintV1,\n\tisBlueprintBundle,\n\tresolveRuntimeConfiguration,\n} from '@wp-playground/blueprints';\nimport { RecommendedPHPVersion, zipDirectory } from '@wp-playground/common';\nimport fs from 'fs';\nimport path from 'path';\nimport { resolveWordPressRelease } from '@wp-playground/wordpress';\nimport {\n\tCACHE_FOLDER,\n\tcachedDownload,\n\tfetchSqliteIntegration,\n\treadAsFile,\n} from './download';\nimport type { PlaygroundCliBlueprintV1Worker } from './worker-thread-v1';\nimport type { MessagePort as NodeMessagePort } from 'worker_threads';\nimport {\n\tLogVerbosity,\n\ttype RunCLIArgs,\n\ttype SpawnedWorker,\n\ttype WorkerType,\n} from '../run-cli';\nimport { shouldRenderProgress } from '../utils/progress';\n\n/**\n * Boots Playground CLI workers using Blueprint version 1.\n *\n * Progress tracking, downloads, steps, and all other features are\n * implemented in TypeScript and orchestrated by this class.\n */\nexport class BlueprintsV1Handler {\n\tprivate lastProgressMessage = '';\n\n\tprivate siteUrl: string;\n\tprivate processIdSpaceLength: number;\n\tprivate args: RunCLIArgs;\n\n\tconstructor(\n\t\targs: RunCLIArgs,\n\t\toptions: {\n\t\t\tsiteUrl: string;\n\t\t\tprocessIdSpaceLength: number;\n\t\t}\n\t) {\n\t\tthis.args = args;\n\t\tthis.siteUrl = options.siteUrl;\n\t\tthis.processIdSpaceLength = options.processIdSpaceLength;\n\t}\n\n\tgetWorkerType(): WorkerType {\n\t\treturn 'v1';\n\t}\n\n\tasync bootAndSetUpInitialPlayground(\n\t\tphpPort: NodeMessagePort,\n\t\tfileLockManagerPort: NodeMessagePort,\n\t\tnativeInternalDirPath: string\n\t) {\n\t\tlet wpDetails: any = undefined;\n\t\tlet wordPressZip: any = undefined;\n\t\tlet preinstalledWpContentPath: string | undefined = undefined;\n\t\t// @TODO: Rename to FetchProgressMonitor. There's nothing Emscripten\n\t\t// about that class anymore.\n\t\tconst monitor = new EmscriptenDownloadMonitor();\n\t\tif (this.args.wordpressInstallMode === 'download-and-install') {\n\t\t\tlet progressReached100 = false;\n\t\t\tmonitor.addEventListener('progress', ((\n\t\t\t\te: CustomEvent<ProgressEvent & { finished: boolean }>\n\t\t\t) => {\n\t\t\t\tif (progressReached100) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// @TODO Every progress bar will want percentages. The\n\t\t\t\t//       download monitor should just provide that.\n\t\t\t\tconst { loaded, total } = e.detail;\n\t\t\t\t// Use floor() so we don't report 100% until truly there.\n\t\t\t\tconst percentProgress = Math.floor(\n\t\t\t\t\tMath.min(100, (100 * loaded) / total)\n\t\t\t\t);\n\t\t\t\tprogressReached100 = percentProgress === 100;\n\n\t\t\t\tthis.writeProgressUpdate(\n\t\t\t\t\tprocess.stdout,\n\t\t\t\t\t`Downloading WordPress ${percentProgress}%...`,\n\t\t\t\t\tprogressReached100\n\t\t\t\t);\n\t\t\t}) as any);\n\n\t\t\twpDetails = await resolveWordPressRelease(this.args.wp);\n\t\t\tpreinstalledWpContentPath = path.join(\n\t\t\t\tCACHE_FOLDER,\n\t\t\t\t`prebuilt-wp-content-for-wp-${wpDetails.version}.zip`\n\t\t\t);\n\t\t\twordPressZip = fs.existsSync(preinstalledWpContentPath)\n\t\t\t\t? readAsFile(preinstalledWpContentPath)\n\t\t\t\t: await cachedDownload(\n\t\t\t\t\t\twpDetails.releaseUrl,\n\t\t\t\t\t\t`${wpDetails.version}.zip`,\n\t\t\t\t\t\tmonitor\n\t\t\t\t\t);\n\t\t\tlogger.log(\n\t\t\t\t`Resolved WordPress release URL: ${wpDetails?.releaseUrl}`\n\t\t\t);\n\t\t}\n\n\t\tlet sqliteIntegrationPluginZip;\n\t\tif (this.args.skipSqliteSetup) {\n\t\t\tlogger.log(`Skipping SQLite integration plugin setup...`);\n\t\t\tsqliteIntegrationPluginZip = undefined;\n\t\t} else {\n\t\t\tlogger.log(`Fetching SQLite integration plugin...`);\n\t\t\tsqliteIntegrationPluginZip = await fetchSqliteIntegration(monitor);\n\t\t}\n\n\t\tconst followSymlinks = this.args.followSymlinks === true;\n\t\tconst trace = this.args.experimentalTrace === true;\n\n\t\tconst mountsBeforeWpInstall = this.args['mount-before-install'] || [];\n\t\tconst mountsAfterWpInstall = this.args.mount || [];\n\n\t\tconst playground = consumeAPI<PlaygroundCliBlueprintV1Worker>(phpPort);\n\n\t\t// Comlink communication proxy\n\t\tawait playground.isConnected();\n\n\t\tlogger.log(`Booting WordPress...`);\n\n\t\tconst runtimeConfiguration = await resolveRuntimeConfiguration(\n\t\t\tthis.getEffectiveBlueprint()\n\t\t);\n\n\t\tawait playground.useFileLockManager(fileLockManagerPort);\n\t\tawait playground.bootAndSetUpInitialWorker({\n\t\t\tphpVersion: runtimeConfiguration.phpVersion,\n\t\t\twpVersion: runtimeConfiguration.wpVersion,\n\t\t\tsiteUrl: this.siteUrl,\n\t\t\tmountsBeforeWpInstall,\n\t\t\tmountsAfterWpInstall,\n\t\t\twordpressInstallMode:\n\t\t\t\tthis.args.wordpressInstallMode || 'download-and-install',\n\t\t\twordPressZip: wordPressZip && (await wordPressZip!.arrayBuffer()),\n\t\t\tsqliteIntegrationPluginZip:\n\t\t\t\tawait sqliteIntegrationPluginZip?.arrayBuffer(),\n\t\t\tfirstProcessId: 0,\n\t\t\tprocessIdSpaceLength: this.processIdSpaceLength,\n\t\t\tfollowSymlinks,\n\t\t\ttrace,\n\t\t\tinternalCookieStore: this.args.internalCookieStore,\n\t\t\twithIntl: this.args.intl,\n\t\t\t// We do not enable Xdebug by default for the initial worker\n\t\t\t// because we do not imagine users expect to hit breakpoints\n\t\t\t// until Playground has fully booted.\n\t\t\t// TODO: Consider supporting Xdebug for the initial worker via a dedicated flag.\n\t\t\twithXdebug: false,\n\t\t\tnativeInternalDirPath,\n\t\t});\n\n\t\tif (\n\t\t\tpreinstalledWpContentPath &&\n\t\t\t!this.args['mount-before-install'] &&\n\t\t\t!fs.existsSync(preinstalledWpContentPath)\n\t\t) {\n\t\t\tlogger.log(`Caching preinstalled WordPress for the next boot...`);\n\t\t\tfs.writeFileSync(\n\t\t\t\tpreinstalledWpContentPath,\n\t\t\t\t(await zipDirectory(playground, '/wordpress'))!\n\t\t\t);\n\t\t\tlogger.log(`Cached!`);\n\t\t}\n\n\t\treturn playground;\n\t}\n\n\tasync bootPlayground({\n\t\tworker,\n\t\tfileLockManagerPort,\n\t\tfirstProcessId,\n\t\tnativeInternalDirPath,\n\t}: {\n\t\tworker: SpawnedWorker;\n\t\tfileLockManagerPort: NodeMessagePort;\n\t\tfirstProcessId: number;\n\t\tnativeInternalDirPath: string;\n\t}) {\n\t\tconst playground = consumeAPI<PlaygroundCliBlueprintV1Worker>(\n\t\t\tworker.phpPort\n\t\t);\n\n\t\tawait playground.isConnected();\n\t\tconst runtimeConfiguration = await resolveRuntimeConfiguration(\n\t\t\tthis.getEffectiveBlueprint()\n\t\t);\n\t\tawait playground.useFileLockManager(fileLockManagerPort);\n\t\tawait playground.bootWorker({\n\t\t\tphpVersion: runtimeConfiguration.phpVersion,\n\t\t\tsiteUrl: this.siteUrl,\n\t\t\tmountsBeforeWpInstall: this.args['mount-before-install'] || [],\n\t\t\tmountsAfterWpInstall: this.args['mount'] || [],\n\t\t\tfirstProcessId,\n\t\t\tprocessIdSpaceLength: this.processIdSpaceLength,\n\t\t\tfollowSymlinks: this.args.followSymlinks === true,\n\t\t\ttrace: this.args.experimentalTrace === true,\n\t\t\t// @TODO: Move this to the request handler or else every worker\n\t\t\t//        will have a separate cookie store.\n\t\t\tinternalCookieStore: this.args.internalCookieStore,\n\t\t\twithIntl: this.args.intl,\n\t\t\twithXdebug: !!this.args.xdebug,\n\t\t\tnativeInternalDirPath,\n\t\t});\n\t\tawait playground.isReady();\n\t\treturn playground;\n\t}\n\n\tasync compileInputBlueprint(additionalBlueprintSteps: any[]) {\n\t\tconst blueprint = this.getEffectiveBlueprint();\n\n\t\tconst tracker = new ProgressTracker();\n\t\tlet lastCaption = '';\n\t\tlet progressReached100 = false;\n\t\ttracker.addEventListener('progress', (e: any) => {\n\t\t\tif (progressReached100) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tprogressReached100 = e.detail.progress === 100;\n\n\t\t\t// Use floor() so we don't report 100% until truly there.\n\t\t\tconst progressInteger = Math.floor(e.detail.progress);\n\t\t\tlastCaption =\n\t\t\t\te.detail.caption || lastCaption || 'Running the Blueprint';\n\t\t\tconst message = `${lastCaption.trim()} – ${progressInteger}%`;\n\t\t\tthis.writeProgressUpdate(\n\t\t\t\tprocess.stdout,\n\t\t\t\tmessage,\n\t\t\t\tprogressReached100\n\t\t\t);\n\t\t});\n\t\treturn await compileBlueprintV1(blueprint as BlueprintV1Declaration, {\n\t\t\tprogress: tracker,\n\t\t\tadditionalSteps: additionalBlueprintSteps,\n\t\t});\n\t}\n\n\tprivate getEffectiveBlueprint() {\n\t\tconst resolvedBlueprint = this.args.blueprint as BlueprintV1Declaration;\n\t\t/**\n\t\t * @TODO This looks similar to the resolveBlueprint() call in the website package:\n\t\t * \t     https://github.com/WordPress/wordpress-playground/blob/ce586059e5885d185376184fdd2f52335cca32b0/packages/playground/website/src/main.tsx#L41\n\t\t *\n\t\t * \t\t Also the Blueprint Builder tool does something similar.\n\t\t *       Perhaps all these cases could be handled by the same function?\n\t\t */\n\t\treturn isBlueprintBundle(resolvedBlueprint)\n\t\t\t? resolvedBlueprint\n\t\t\t: {\n\t\t\t\t\tlogin: this.args.login,\n\t\t\t\t\t...(resolvedBlueprint || {}),\n\t\t\t\t\tpreferredVersions: {\n\t\t\t\t\t\tphp:\n\t\t\t\t\t\t\tthis.args.php ??\n\t\t\t\t\t\t\tresolvedBlueprint?.preferredVersions?.php ??\n\t\t\t\t\t\t\tRecommendedPHPVersion,\n\t\t\t\t\t\twp:\n\t\t\t\t\t\t\tthis.args.wp ??\n\t\t\t\t\t\t\tresolvedBlueprint?.preferredVersions?.wp ??\n\t\t\t\t\t\t\t'latest',\n\t\t\t\t\t\t...(resolvedBlueprint?.preferredVersions || {}),\n\t\t\t\t\t},\n\t\t\t\t};\n\t}\n\n\twriteProgressUpdate(\n\t\twriteStream: NodeJS.WriteStream,\n\t\tmessage: string,\n\t\tfinalUpdate: boolean\n\t) {\n\t\tif (this.args.verbosity === LogVerbosity.Quiet.name) {\n\t\t\treturn;\n\t\t}\n\t\tif (!shouldRenderProgress(writeStream)) {\n\t\t\treturn;\n\t\t}\n\t\tif (message === this.lastProgressMessage) {\n\t\t\t// Avoid repeating the same message\n\t\t\treturn;\n\t\t}\n\t\tthis.lastProgressMessage = message;\n\n\t\tif (writeStream.isTTY) {\n\t\t\t// Overwrite previous progress updates in-place for a quieter UX.\n\t\t\twriteStream.cursorTo(0);\n\t\t\twriteStream.write(message);\n\t\t\twriteStream.clearLine(1);\n\n\t\t\tif (finalUpdate) {\n\t\t\t\twriteStream.write('\\n');\n\t\t\t}\n\t\t} else {\n\t\t\t// Fall back to writing one line per progress update\n\t\t\twriteStream.write(`${message}\\n`);\n\t\t}\n\t}\n}\n","import fs from 'fs';\nimport path from 'path';\nimport { logger } from '@php-wasm/logger';\nimport {\n\tdir as tmpDir,\n\tsetGracefulCleanup as tmpSetGracefulCleanup,\n} from 'tmp-promise';\n// NOTE: We use ps-man rather than more popular packages because there\n// is no native build required to install the package.\n// @ts-ignore -- There are no types for this package.\nimport ps from 'ps-man';\n\n/**\n * Create a temp dir for the Playground CLI.\n *\n * The temp dir is created in the system temp dir and is named\n * based on the Playground CLI binary name and the process ID.\n *\n * @param substrToIdentifyTempDirs The substring to identify the temp dir.\n * @param autoCleanup Whether to skip cleanup on process exit. Primarily used for unit testing.\n * @returns The path to the temp dir.\n */\nexport async function createPlaygroundCliTempDir(\n\tsubstrToIdentifyTempDirs: string,\n\t// Allow controlling auto-cleanup for test purposes.\n\tautoCleanup = true\n) {\n\tconst nodeBinaryName = path.basename(process.argv0);\n\n\t// We place the binary name before the playground-related fragment\n\t// so we can use the position of the fragment to parse the binary name.\n\t// Otherwise, we would have to parse the binary name from the full path.\n\tconst tempDirPrefix = `${nodeBinaryName}${substrToIdentifyTempDirs}${process.pid}-`;\n\n\tconst nativeDir = await tmpDir({\n\t\tprefix: tempDirPrefix,\n\t\t/*\n\t\t * Allow recursive cleanup on process exit.\n\t\t *\n\t\t * NOTE: I worried about whether this cleanup would follow symlinks\n\t\t * and delete target files instead of unlinking the symlink,\n\t\t * but this feature uses rimraf under the hood which respects symlinks:\n\t\t * https://github.com/raszi/node-tmp/blob/3d2fe387f3f91b13830b9182faa02c3231ea8258/lib/tmp.js#L318\n\t\t */\n\t\tunsafeCleanup: true,\n\t});\n\n\tif (autoCleanup) {\n\t\t// Request graceful cleanup on process exit.\n\t\ttmpSetGracefulCleanup();\n\t}\n\n\treturn nativeDir;\n}\n\n/**\n * Cleanup stale Playground temp dirs.\n *\n * A temp dir is considered stale if it is older than the specified age\n * and the associated process no longer exists.\n *\n * @param substrToIdentifyTempDirs The substring to identify the temp dir.\n * @param staleAgeInMillis The age in milliseconds after which a temp dir is considered stale.\n * @param tempRootDir The root directory of the temp dirs.\n */\nexport async function cleanupStalePlaygroundTempDirs(\n\tsubstrToIdentifyTempDirs: string,\n\tstaleAgeInMillis: number,\n\ttempRootDir: string\n) {\n\tconst stalePlaygroundTempDirs = await findStalePlaygroundTempDirs(\n\t\tsubstrToIdentifyTempDirs,\n\t\tstaleAgeInMillis,\n\t\ttempRootDir\n\t);\n\tconst promisesToRemove = stalePlaygroundTempDirs.map(\n\t\t(stalePlaygroundTempDir) =>\n\t\t\tnew Promise<void>((resolve) => {\n\t\t\t\t// TODO: Non-blocking: Consider how to avoid conflicts with another CLI doing cleanup.\n\t\t\t\tfs.rm(stalePlaygroundTempDir, { recursive: true }, (err) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t\t`Failed to delete stale Playground temp dir: ${stalePlaygroundTempDir}`,\n\t\t\t\t\t\t\terr\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlogger.info(\n\t\t\t\t\t\t\t`Deleted stale Playground temp dir: ${stalePlaygroundTempDir}`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tresolve();\n\t\t\t\t});\n\t\t\t})\n\t);\n\tawait Promise.all(promisesToRemove);\n}\n\nasync function findStalePlaygroundTempDirs(\n\tsubstrToIdentifyTempDirs: string,\n\tstaleAgeInMillis: number,\n\ttempRootDir: string\n) {\n\ttry {\n\t\tconst tempPaths = fs\n\t\t\t.readdirSync(tempRootDir)\n\t\t\t.map((dirName) => path.join(tempRootDir, dirName));\n\n\t\tconst stalePlaygroundTempDirs = [];\n\t\tfor (const tempPath of tempPaths) {\n\t\t\tconst appearsToBeStale = await appearsToBeStalePlaygroundTempDir(\n\t\t\t\tsubstrToIdentifyTempDirs,\n\t\t\t\tstaleAgeInMillis,\n\t\t\t\ttempPath\n\t\t\t);\n\t\t\tif (appearsToBeStale) {\n\t\t\t\tstalePlaygroundTempDirs.push(tempPath);\n\t\t\t}\n\t\t}\n\t\treturn stalePlaygroundTempDirs;\n\t} catch (e) {\n\t\tlogger.warn(`Failed to find stale Playground temp dirs: ${e}`);\n\t\t// Failing to find stale temp dirs should not prevent the CLI from starting.\n\t\treturn [];\n\t}\n}\n\nasync function appearsToBeStalePlaygroundTempDir(\n\tsubstrToIdentifyTempDirs: string,\n\tstaleAgeInMillis: number,\n\tabsolutePath: string\n) {\n\tconst lstat = fs.lstatSync(absolutePath);\n\tif (!lstat.isDirectory()) {\n\t\t// A non-directory cannot be a Playground temp dir.\n\t\treturn false;\n\t}\n\n\tconst dirName = path.basename(absolutePath);\n\tif (!dirName.includes(substrToIdentifyTempDirs)) {\n\t\t// This doesn't look like one of our temp dirs.\n\t\treturn false;\n\t}\n\n\tconst match = dirName.match(\n\t\tnew RegExp(`^(.+)${substrToIdentifyTempDirs}(\\\\d+)-`)\n\t);\n\tif (!match) {\n\t\t// We cannot parse the temp dir name,\n\t\t// so there is nothing more to try.\n\t\treturn false;\n\t}\n\n\tconst info = {\n\t\tabsolutePath,\n\t\texecutableName: match[1],\n\t\tpid: match[2],\n\t};\n\n\tif (await doesProcessExist(info.pid, info.executableName)) {\n\t\t// It looks like the temp dir's process is still running.\n\t\treturn false;\n\t}\n\n\tconst STALE_DATE = Date.now() - staleAgeInMillis;\n\tconst dirStat = fs.statSync(absolutePath);\n\tif (dirStat.mtime.getTime() < STALE_DATE) {\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nasync function doesProcessExist(pid: string, executableName: string) {\n\t// Define this type because there are no types for ps.list()\n\ttype ProcessInfo = {\n\t\tpid: string;\n\t\tcommand: string;\n\t};\n\t// Look for an existing process with the same PID and executable name.\n\tconst [existingProcess] = await new Promise<ProcessInfo[]>(\n\t\t(resolve, reject) => {\n\t\t\tps.list(\n\t\t\t\t{\n\t\t\t\t\tpid,\n\t\t\t\t\tname: executableName,\n\t\t\t\t\t// Remove path from executable name in the results.\n\t\t\t\t\tclean: true,\n\t\t\t\t},\n\t\t\t\t(err: any, processes: ProcessInfo[]) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresolve(processes);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t);\n\treturn (\n\t\t!!existingProcess &&\n\t\texistingProcess.pid === pid &&\n\t\texistingProcess.command === executableName\n\t);\n}\n","import { errorLogPath, logger, LogSeverity } from '@php-wasm/logger';\nimport type {\n\tPHPRequest,\n\tRemoteAPI,\n\tSupportedPHPVersion,\n\tUniversalPHP,\n} from '@php-wasm/universal';\nimport {\n\tPHPResponse,\n\texposeAPI,\n\texposeSyncAPI,\n\tprintDebugDetails,\n} from '@php-wasm/universal';\nimport type {\n\tBlueprintBundle,\n\tBlueprintV1Declaration,\n\tBlueprintV2Declaration,\n} from '@wp-playground/blueprints';\nimport { runBlueprintV1Steps } from '@wp-playground/blueprints';\nimport { RecommendedPHPVersion } from '@wp-playground/common';\nimport fs, { mkdirSync } from 'fs';\nimport type { Server } from 'http';\nimport { MessageChannel as NodeMessageChannel, Worker } from 'worker_threads';\n// @ts-ignore\nimport {\n\texpandAutoMounts,\n\tparseMountDirArguments,\n\tparseMountWithDelimiterArguments,\n} from './mounts';\nimport { startServer } from './start-server';\nimport type { PlaygroundCliBlueprintV1Worker } from './blueprints-v1/worker-thread-v1';\nimport type { PlaygroundCliBlueprintV2Worker } from './blueprints-v2/worker-thread-v2';\nimport { FileLockManagerForNode } from '@php-wasm/node';\nimport { LoadBalancer } from './load-balancer';\n/* eslint-disable no-console */\nimport { SupportedPHPVersions } from '@php-wasm/universal';\nimport { cpus } from 'os';\nimport { jspi } from 'wasm-feature-detect';\nimport type { MessagePort as NodeMessagePort } from 'worker_threads';\nimport yargs, { type Argv, type Options as YargsOptions } from 'yargs';\nimport { isValidWordPressSlug } from './is-valid-wordpress-slug';\nimport { resolveBlueprint } from './resolve-blueprint';\nimport { BlueprintsV2Handler } from './blueprints-v2/blueprints-v2-handler';\nimport { BlueprintsV1Handler } from './blueprints-v1/blueprints-v1-handler';\nimport { startBridge } from '@php-wasm/xdebug-bridge';\nimport path from 'path';\nimport os from 'os';\nimport {\n\tcleanupStalePlaygroundTempDirs,\n\tcreatePlaygroundCliTempDir,\n} from './temp-dir';\nimport { type WordPressInstallMode } from '@wp-playground/wordpress';\nimport {\n\ttype Mount,\n\taddXdebugIDEConfig,\n\tclearXdebugIDEConfig,\n\tcreateTempDirSymlink,\n\tremoveTempDirSymlink,\n} from '@php-wasm/cli-util';\n\n// Inlined worker URLs for static analysis by downstream bundlers\n// These are replaced at build time by the Vite plugin in vite.config.ts\ndeclare const __WORKER_V1_URL__: string;\ndeclare const __WORKER_V2_URL__: string;\n\nexport const LogVerbosity = {\n\tQuiet: { name: 'quiet', severity: LogSeverity.Fatal },\n\tNormal: { name: 'normal', severity: LogSeverity.Info },\n\tDebug: { name: 'debug', severity: LogSeverity.Debug },\n} as const;\n\ntype LogVerbosity = (typeof LogVerbosity)[keyof typeof LogVerbosity]['name'];\n\nexport type WorkerType = 'v1' | 'v2';\n\n/**\n * Parse the CLI args and run the appropriate command.\n *\n * @param argsToParse string[] The CLI args to parse.\n */\nexport async function parseOptionsAndRunCLI(argsToParse: string[]) {\n\ttry {\n\t\t/**\n\t\t * @TODO This looks similar to Query API args https://wordpress.github.io/wordpress-playground/developers/apis/query-api/\n\t\t *       Perhaps the two could be handled by the same code?\n\t\t */\n\t\tconst sharedOptions: Record<string, YargsOptions> = {\n\t\t\t'site-url': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Site URL to use for WordPress. Defaults to http://127.0.0.1:{port}',\n\t\t\t\ttype: 'string',\n\t\t\t},\n\t\t\tphp: {\n\t\t\t\tdescribe: 'PHP version to use.',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: RecommendedPHPVersion,\n\t\t\t\tchoices: SupportedPHPVersions,\n\t\t\t},\n\t\t\twp: {\n\t\t\t\tdescribe: 'WordPress version to use.',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: 'latest',\n\t\t\t},\n\t\t\t// @TODO: Support read-only mounts, e.g. via WORKERFS, a custom\n\t\t\t// ReadOnlyNODEFS, or by copying the files into MEMFS\n\t\t\tmount: {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Mount a directory to the PHP runtime (can be used multiple times). Format: /host/path:/vfs/path',\n\t\t\t\ttype: 'array',\n\t\t\t\tstring: true,\n\t\t\t\tcoerce: parseMountWithDelimiterArguments,\n\t\t\t},\n\t\t\t'mount-before-install': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Mount a directory to the PHP runtime before WordPress installation (can be used multiple times). Format: /host/path:/vfs/path',\n\t\t\t\ttype: 'array',\n\t\t\t\tstring: true,\n\t\t\t\tcoerce: parseMountWithDelimiterArguments,\n\t\t\t},\n\t\t\t'mount-dir': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Mount a directory to the PHP runtime (can be used multiple times). Format: \"/host/path\" \"/vfs/path\"',\n\t\t\t\ttype: 'array',\n\t\t\t\tnargs: 2,\n\t\t\t\tarray: true,\n\t\t\t\tcoerce: parseMountDirArguments,\n\t\t\t},\n\t\t\t'mount-dir-before-install': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Mount a directory before WordPress installation (can be used multiple times). Format: \"/host/path\" \"/vfs/path\"',\n\t\t\t\ttype: 'string',\n\t\t\t\tnargs: 2,\n\t\t\t\tarray: true,\n\t\t\t\tcoerce: parseMountDirArguments,\n\t\t\t},\n\t\t\tlogin: {\n\t\t\t\tdescribe: 'Should log the user in',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\tblueprint: {\n\t\t\t\tdescribe: 'Blueprint to execute.',\n\t\t\t\ttype: 'string',\n\t\t\t},\n\t\t\t'blueprint-may-read-adjacent-files': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Consent flag: Allow \"bundled\" resources in a local blueprint to read files in the same directory as the blueprint file.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\t'wordpress-install-mode': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Control how Playground prepares WordPress before booting.',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: 'download-and-install',\n\t\t\t\tchoices: [\n\t\t\t\t\t'download-and-install',\n\t\t\t\t\t'install-from-existing-files',\n\t\t\t\t\t'install-from-existing-files-if-needed',\n\t\t\t\t\t'do-not-attempt-installing',\n\t\t\t\t] as const,\n\t\t\t},\n\t\t\t'skip-wordpress-install': {\n\t\t\t\tdescribe: '[Deprecated] Use --wordpress-install-mode instead.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\thidden: true,\n\t\t\t},\n\t\t\t'skip-sqlite-setup': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Skip the SQLite integration plugin setup to allow the WordPress site to use MySQL.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\t// Hidden - Deprecated in favor of verbosity\n\t\t\tquiet: {\n\t\t\t\tdescribe: 'Do not output logs and progress messages.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t\thidden: true,\n\t\t\t},\n\t\t\tverbosity: {\n\t\t\t\tdescribe: 'Output logs and progress messages.',\n\t\t\t\ttype: 'string',\n\t\t\t\tchoices: Object.values(LogVerbosity).map(\n\t\t\t\t\t(verbosity) => verbosity.name\n\t\t\t\t),\n\t\t\t\tdefault: 'normal',\n\t\t\t},\n\t\t\tdebug: {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Print PHP error log content if an error occurs during Playground boot.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\t'auto-mount': {\n\t\t\t\tdescribe: `Automatically mount the specified directory. If no path is provided, mount the current working directory. You can mount a WordPress directory, a plugin directory, a theme directory, a wp-content directory, or any directory containing PHP and HTML files.`,\n\t\t\t\ttype: 'string',\n\t\t\t},\n\t\t\t'follow-symlinks': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Allow Playground to follow symlinks by automatically mounting symlinked directories and files encountered in mounted directories. \\nWarning: Following symlinks will expose files outside mounted directories to Playground and could be a security risk.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\t'experimental-trace': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Print detailed messages about system behavior to the console. Useful for troubleshooting.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t\t// Hide this option because we want to replace with a more general log-level flag.\n\t\t\t\thidden: true,\n\t\t\t},\n\t\t\t'internal-cookie-store': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Enable internal cookie handling. When enabled, Playground will manage cookies internally using ' +\n\t\t\t\t\t'an HttpCookieStore that persists cookies across requests. When disabled, cookies are handled ' +\n\t\t\t\t\t'externally (e.g., by a browser in Node.js environments).',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\tintl: {\n\t\t\t\tdescribe: 'Enable Intl.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: true,\n\t\t\t},\n\t\t\txdebug: {\n\t\t\t\tdescribe: 'Enable Xdebug.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t},\n\t\t\t'experimental-unsafe-ide-integration': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Enable experimental IDE development tools. This option edits IDE config files ' +\n\t\t\t\t\t'to set Xdebug path mappings and web server details. CAUTION: If there are bugs, ' +\n\t\t\t\t\t'this feature may break your IDE config files. Please consider backing up your IDE configs ' +\n\t\t\t\t\t'before using this feature.',\n\t\t\t\ttype: 'string',\n\t\t\t\t// The empty value means the option is enabled for all\n\t\t\t\t// supported IDEs and, if needed, will create the relevant\n\t\t\t\t// config file for each.\n\t\t\t\tchoices: ['', 'vscode', 'phpstorm'],\n\t\t\t\tcoerce: (value?: string) =>\n\t\t\t\t\tvalue === '' ? ['vscode', 'phpstorm'] : [value],\n\t\t\t},\n\t\t\t'experimental-blueprints-v2-runner': {\n\t\t\t\tdescribe: 'Use the experimental Blueprint V2 runner.',\n\t\t\t\ttype: 'boolean',\n\t\t\t\tdefault: false,\n\t\t\t\t// Remove the \"hidden\" flag once Blueprint V2 is fully supported\n\t\t\t\thidden: true,\n\t\t\t},\n\t\t\tmode: {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Blueprints v2 runner mode to use. This option is required when using the --experimental-blueprints-v2-runner flag with a blueprint.',\n\t\t\t\ttype: 'string',\n\t\t\t\tchoices: ['create-new-site', 'apply-to-existing-site'],\n\t\t\t\t// Remove the \"hidden\" flag once Blueprint V2 is fully supported\n\t\t\t\thidden: true,\n\t\t\t},\n\t\t};\n\n\t\tconst serverOnlyOptions: Record<string, YargsOptions> = {\n\t\t\tport: {\n\t\t\t\tdescribe: 'Port to listen on when serving.',\n\t\t\t\ttype: 'number',\n\t\t\t\tdefault: 9400,\n\t\t\t},\n\t\t\t'experimental-multi-worker': {\n\t\t\t\tdescribe:\n\t\t\t\t\t'Enable experimental multi-worker support which requires ' +\n\t\t\t\t\t'a /wordpress directory backed by a real filesystem. ' +\n\t\t\t\t\t'Pass a positive number to specify the number of workers to use. ' +\n\t\t\t\t\t'Otherwise, default to the number of CPUs minus 1.',\n\t\t\t\ttype: 'number',\n\t\t\t\tcoerce: (value?: number) => value ?? cpus().length - 1,\n\t\t\t},\n\t\t\t'experimental-devtools': {\n\t\t\t\tdescribe: 'Enable experimental browser development tools.',\n\t\t\t\ttype: 'boolean',\n\t\t\t},\n\t\t};\n\n\t\tconst buildSnapshotOnlyOptions: Record<string, YargsOptions> = {\n\t\t\toutfile: {\n\t\t\t\tdescribe: 'When building, write to this output file.',\n\t\t\t\ttype: 'string',\n\t\t\t\tdefault: 'wordpress.zip',\n\t\t\t},\n\t\t};\n\n\t\tconst yargsObject = yargs(argsToParse)\n\t\t\t.usage('Usage: wp-playground <command> [options]')\n\t\t\t.command(\n\t\t\t\t'server',\n\t\t\t\t'Start a local WordPress server',\n\t\t\t\t(yargsInstance: Argv) =>\n\t\t\t\t\tyargsInstance.options({\n\t\t\t\t\t\t...sharedOptions,\n\t\t\t\t\t\t...serverOnlyOptions,\n\t\t\t\t\t})\n\t\t\t)\n\t\t\t.command(\n\t\t\t\t'run-blueprint',\n\t\t\t\t'Execute a Blueprint without starting a server',\n\t\t\t\t(yargsInstance: Argv) =>\n\t\t\t\t\tyargsInstance.options({ ...sharedOptions })\n\t\t\t)\n\t\t\t.command(\n\t\t\t\t'build-snapshot',\n\t\t\t\t'Build a ZIP snapshot of a WordPress site based on a Blueprint',\n\t\t\t\t(yargsInstance: Argv) =>\n\t\t\t\t\tyargsInstance.options({\n\t\t\t\t\t\t...sharedOptions,\n\t\t\t\t\t\t...buildSnapshotOnlyOptions,\n\t\t\t\t\t})\n\t\t\t)\n\t\t\t.demandCommand(1, 'Please specify a command')\n\t\t\t.strictCommands()\n\t\t\t.conflicts(\n\t\t\t\t'experimental-unsafe-ide-integration',\n\t\t\t\t'experimental-devtools'\n\t\t\t)\n\t\t\t.showHelpOnFail(false)\n\t\t\t.fail((msg, err, yargsInstance) => {\n\t\t\t\tif (err) {\n\t\t\t\t\tthrow err;\n\t\t\t\t}\n\t\t\t\tif (msg && msg.includes('Please specify a command')) {\n\t\t\t\t\tyargsInstance.showHelp();\n\t\t\t\t\tconsole.error('\\n' + msg);\n\t\t\t\t\tprocess.exit(1);\n\t\t\t\t}\n\t\t\t\tconsole.error(msg);\n\t\t\t\tprocess.exit(1);\n\t\t\t})\n\t\t\t.strictOptions()\n\t\t\t.check(async (args) => {\n\t\t\t\tif (args['skip-wordpress-install'] === true) {\n\t\t\t\t\targs['wordpress-install-mode'] =\n\t\t\t\t\t\t'do-not-attempt-installing';\n\t\t\t\t\targs['wordpressInstallMode'] = 'do-not-attempt-installing';\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\targs['wp'] !== undefined &&\n\t\t\t\t\ttypeof args['wp'] === 'string' &&\n\t\t\t\t\t!isValidWordPressSlug(args['wp'])\n\t\t\t\t) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\t// Check if is valid URL\n\t\t\t\t\t\tnew URL(args['wp']);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'Unrecognized WordPress version. Please use \"latest\", a URL, or a numeric version such as \"6.2\", \"6.0.1\", \"6.2-beta1\", or \"6.2-RC1\"'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst siteUrlArg = args['site-url'];\n\t\t\t\tif (\n\t\t\t\t\ttypeof siteUrlArg === 'string' &&\n\t\t\t\t\tsiteUrlArg.trim() !== ''\n\t\t\t\t) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tnew URL(siteUrlArg);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t`Invalid site-url \"${siteUrlArg}\". Please provide a valid URL (e.g., http://localhost:8080 or https://example.com)`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (args['auto-mount']) {\n\t\t\t\t\tlet autoMountIsDir = false;\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst autoMountStats = fs.statSync(\n\t\t\t\t\t\t\targs['auto-mount'] as string\n\t\t\t\t\t\t);\n\t\t\t\t\t\tautoMountIsDir = autoMountStats.isDirectory();\n\t\t\t\t\t} catch {\n\t\t\t\t\t\tautoMountIsDir = false;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!autoMountIsDir) {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t`The specified --auto-mount path is not a directory: '${args['auto-mount']}'.`\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (args['experimental-multi-worker'] !== undefined) {\n\t\t\t\t\tconst cliCommand = args._[0] as string;\n\t\t\t\t\tif (cliCommand !== 'server') {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'The --experimental-multi-worker flag is only supported when running the server command.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\tif (\n\t\t\t\t\t\targs['experimental-multi-worker'] !== undefined &&\n\t\t\t\t\t\ttypeof args['experimental-multi-worker'] === 'number' &&\n\t\t\t\t\t\targs['experimental-multi-worker'] <= 1\n\t\t\t\t\t) {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'The --experimental-multi-worker flag must be a positive integer greater than 1.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (args['experimental-blueprints-v2-runner'] === true) {\n\t\t\t\t\tif (args['mode'] !== undefined) {\n\t\t\t\t\t\tif (args['wordpress-install-mode'] !== undefined) {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t'The --wordpress-install-mode option cannot be used with the --mode option. Use one or the other.'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif ('skip-sqlite-setup' in args) {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t'The --skipSqliteSetup option is not supported in Blueprint V2 mode.'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (args['auto-mount'] !== undefined) {\n\t\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t\t'The --mode option cannot be used with --auto-mount because --auto-mount automatically sets the mode.'\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Support the legacy v1 runner options\n\t\t\t\t\t\tif (\n\t\t\t\t\t\t\targs['wordpress-install-mode'] ===\n\t\t\t\t\t\t\t'do-not-attempt-installing'\n\t\t\t\t\t\t) {\n\t\t\t\t\t\t\targs['mode'] = 'apply-to-existing-site';\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\targs['mode'] = 'create-new-site';\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Support the legacy v1 runner options\n\t\t\t\t\tconst allow = (args['allow'] as string[]) || [];\n\n\t\t\t\t\tif (args['followSymlinks'] === true) {\n\t\t\t\t\t\tallow.push('follow-symlinks');\n\t\t\t\t\t}\n\n\t\t\t\t\tif (args['blueprint-may-read-adjacent-files'] === true) {\n\t\t\t\t\t\tallow.push('read-local-fs');\n\t\t\t\t\t}\n\n\t\t\t\t\targs['allow'] = allow;\n\t\t\t\t} else {\n\t\t\t\t\tif (args['mode'] !== undefined) {\n\t\t\t\t\t\tthrow new Error(\n\t\t\t\t\t\t\t'The --mode option requires the --experimentalBlueprintsV2Runner flag.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn true;\n\t\t\t});\n\n\t\tyargsObject.wrap(yargsObject.terminalWidth());\n\t\tconst args = await yargsObject.argv;\n\n\t\tconst command = args._[0] as string;\n\n\t\tif (!['run-blueprint', 'server', 'build-snapshot'].includes(command)) {\n\t\t\tyargsObject.showHelp();\n\t\t\tprocess.exit(1);\n\t\t}\n\n\t\tconst cliArgs = {\n\t\t\t...args,\n\t\t\tcommand,\n\t\t\tmount: [\n\t\t\t\t...((args['mount'] as Mount[]) || []),\n\t\t\t\t...((args['mount-dir'] as Mount[]) || []),\n\t\t\t],\n\t\t\t'mount-before-install': [\n\t\t\t\t...((args['mount-before-install'] as Mount[]) || []),\n\t\t\t\t...((args['mount-dir-before-install'] as Mount[]) || []),\n\t\t\t],\n\t\t} as RunCLIArgs;\n\n\t\tconst cliServer = await runCLI(cliArgs);\n\t\tif (cliServer === undefined) {\n\t\t\t// No server was started, so we are done with our work.\n\t\t\tprocess.exit(0);\n\t\t}\n\n\t\tconst cleanUpCliAndExit = (() => {\n\t\t\t// Remember we are already cleaning up to preclude the possibility\n\t\t\t// of multiple, conflicting cleanup attempts.\n\t\t\tlet promiseToCleanup: Promise<void>;\n\n\t\t\treturn async () => {\n\t\t\t\tif (promiseToCleanup !== undefined) {\n\t\t\t\t\tpromiseToCleanup = cliServer[Symbol.asyncDispose]();\n\t\t\t\t}\n\t\t\t\tawait promiseToCleanup;\n\t\t\t\tprocess.exit(0);\n\t\t\t};\n\t\t})();\n\n\t\t// Playground CLI server must be killed to exit. From the terminal,\n\t\t// this may occur via Ctrl+C which sends SIGINT. Let's handle both\n\t\t// SIGINT and SIGTERM (the default kill signal) to make sure we\n\t\t// clean up after ourselves even if this process is being killed.\n\t\t// NOTE: Windows does not support SIGTERM, but Node.js provides some emulation.\n\t\tprocess.on('SIGINT', cleanUpCliAndExit);\n\t\tprocess.on('SIGTERM', cleanUpCliAndExit);\n\t} catch (e) {\n\t\tif (!(e instanceof Error)) {\n\t\t\tthrow e;\n\t\t}\n\t\tconst debug = process.argv.includes('--debug');\n\t\tif (debug) {\n\t\t\tprintDebugDetails(e);\n\t\t} else {\n\t\t\tconst messageChain = [];\n\t\t\tlet currentError = e;\n\t\t\tdo {\n\t\t\t\tmessageChain.push(currentError.message);\n\t\t\t\tcurrentError = currentError.cause as Error;\n\t\t\t} while (currentError instanceof Error);\n\t\t\tconsole.error(\n\t\t\t\t'\\x1b[1m' + messageChain.join(' caused by: ') + '\\x1b[0m'\n\t\t\t);\n\t\t}\n\t\tprocess.exit(1);\n\t}\n}\n\nexport interface RunCLIArgs {\n\tblueprint?:\n\t\t| BlueprintV1Declaration\n\t\t| BlueprintV2Declaration\n\t\t| BlueprintBundle;\n\tcommand: 'server' | 'run-blueprint' | 'build-snapshot';\n\tdebug?: boolean;\n\tlogin?: boolean;\n\tmount?: Mount[];\n\t'mount-before-install'?: Mount[];\n\toutfile?: string;\n\tphp?: SupportedPHPVersion;\n\tport?: number;\n\t'site-url'?: string;\n\tquiet?: boolean;\n\tverbosity?: LogVerbosity;\n\twp?: string;\n\tautoMount?: string;\n\texperimentalMultiWorker?: number;\n\texperimentalTrace?: boolean;\n\tinternalCookieStore?: boolean;\n\t'additional-blueprint-steps'?: any[];\n\tintl?: boolean;\n\txdebug?: boolean | { ideKey?: string };\n\texperimentalUnsafeIdeIntegration?: string[];\n\texperimentalDevtools?: boolean;\n\t'experimental-blueprints-v2-runner'?: boolean;\n\twordpressInstallMode?: WordPressInstallMode;\n\n\t// --------- Blueprint V1 args -----------\n\tskipSqliteSetup?: boolean;\n\tfollowSymlinks?: boolean;\n\t'blueprint-may-read-adjacent-files'?: boolean;\n\n\t// --------- Blueprint V2 args -----------\n\tmode?: 'mount-only' | 'create-new-site' | 'apply-to-existing-site';\n\n\t// --------- Blueprint V2 args (not available via CLI yet) -----------\n\t'db-engine'?: 'sqlite' | 'mysql';\n\t'db-host'?: string;\n\t'db-user'?: string;\n\t'db-pass'?: string;\n\t'db-name'?: string;\n\t'db-path'?: string;\n\t'truncate-new-site-directory'?: boolean;\n\tallow?: string;\n}\n\ntype PlaygroundCliWorker =\n\t| PlaygroundCliBlueprintV1Worker\n\t| PlaygroundCliBlueprintV2Worker;\n\nexport const internalsKeyForTesting = Symbol('playground-cli-testing');\n\nexport interface RunCLIServer extends AsyncDisposable {\n\tplayground: RemoteAPI<PlaygroundCliWorker>;\n\tserver: Server;\n\tserverUrl: string;\n\n\t[Symbol.asyncDispose](): Promise<void>;\n\n\t// Provide some details and helpers for automated testing.\n\t[internalsKeyForTesting]: {\n\t\tworkerThreadCount: number;\n\t\tgetWorkerNumberFromProcessId(processId: number): number;\n\t};\n}\n\nconst bold = (text: string) =>\n\tprocess.stdout.isTTY ? '\\x1b[1m' + text + '\\x1b[0m' : text;\n\nconst dim = (text: string) =>\n\tprocess.stdout.isTTY ? `\\x1b[2m${text}\\x1b[0m` : text;\n\nconst italic = (text: string) =>\n\tprocess.stdout.isTTY ? `\\x1b[3m${text}\\x1b[0m` : text;\n\nconst highlight = (text: string) =>\n\tprocess.stdout.isTTY ? `\\x1b[33m${text}\\x1b[0m` : text;\n\n// These overloads are declared for convenience so runCLI() can return\n// different things depending on the CLI command without forcing the\n// callers (mostly automated tests) to check return values.\nexport async function runCLI(\n\targs: RunCLIArgs & { command: 'build-snapshot' | 'run-blueprint' }\n): Promise<void>;\nexport async function runCLI(\n\targs: RunCLIArgs & { command: 'server' }\n): Promise<RunCLIServer>;\nexport async function runCLI(args: RunCLIArgs): Promise<RunCLIServer | void>;\nexport async function runCLI(args: RunCLIArgs): Promise<RunCLIServer | void> {\n\tlet loadBalancer: LoadBalancer;\n\tlet playground: RemoteAPI<PlaygroundCliWorker>;\n\n\tconst playgroundsToCleanUp: Map<\n\t\tWorker,\n\t\tRemoteAPI<PlaygroundCliWorker>\n\t> = new Map();\n\n\t/**\n\t * Expand auto-mounts to include the necessary mounts and steps\n\t * when running in auto-mount mode.\n\t */\n\tif (args.autoMount !== undefined) {\n\t\tif (args.autoMount === '') {\n\t\t\t// No auto-mount path was provided, so use the current working directory.\n\t\t\t// Note: We default here instead of in the yargs declaration because\n\t\t\t// it allows us to test the default as part of the runCLI() unit tests.\n\t\t\targs = { ...args, autoMount: process.cwd() };\n\t\t}\n\t\targs = expandAutoMounts(args);\n\t}\n\n\tif (args.wordpressInstallMode === undefined) {\n\t\targs.wordpressInstallMode = 'download-and-install';\n\t}\n\n\t// Keeping 'quiet' option to preserve backward compatibility\n\tif (args.quiet) {\n\t\targs.verbosity = 'quiet';\n\t\tdelete args['quiet'];\n\t}\n\n\t// Promote \"debug\" flag to verbosity but keep args.debug around – the\n\t// program behavior may change in more ways than just logging verbosity\n\t// when debug mode is enabled, e.g. error objects may carry additional details.\n\tif (args.debug) {\n\t\targs.verbosity = 'debug';\n\t} else if (args.verbosity === 'debug') {\n\t\targs.debug = true;\n\t}\n\n\tif (args.verbosity) {\n\t\tconst severity = Object.values(LogVerbosity).find(\n\t\t\t(v) => v.name === args.verbosity\n\t\t)!.severity;\n\t\tlogger.setSeverityFilterLevel(severity);\n\t}\n\n\t// Enables Intl dynamic extension by default\n\tif (!args.intl) {\n\t\targs.intl = true;\n\t}\n\n\tconst selectedPort =\n\t\targs.command === 'server' ? ((args['port'] as number) ?? 9400) : 0;\n\n\t// Declare file lock manager outside scope of startServer\n\t// so we can look at it when debugging request handling.\n\tconst nativeFlockSync =\n\t\tos.platform() === 'win32'\n\t\t\t? // @TODO: Enable fs-ext here when it works with Windows.\n\t\t\t\tundefined\n\t\t\t: await import('fs-ext')\n\t\t\t\t\t.then((m) => m.flockSync)\n\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\tlogger.warn(\n\t\t\t\t\t\t\t'The fs-ext package is not installed. ' +\n\t\t\t\t\t\t\t\t'Internal file locking will not be integrated with ' +\n\t\t\t\t\t\t\t\t'host OS file locking.'\n\t\t\t\t\t\t);\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t});\n\tconst fileLockManager = new FileLockManagerForNode(nativeFlockSync);\n\n\tlet wordPressReady = false;\n\tlet isFirstRequest = true;\n\n\tlogger.log('Starting a PHP server...');\n\n\treturn startServer({\n\t\tport: selectedPort,\n\t\tonBind: async (server: Server, port: number) => {\n\t\t\tconst host = '127.0.0.1';\n\t\t\tconst serverUrl = `http://${host}:${port}`;\n\t\t\tconst siteUrl = args['site-url'] || serverUrl;\n\n\t\t\tconst targetWorkerCount =\n\t\t\t\targs.command === 'server'\n\t\t\t\t\t? (args.experimentalMultiWorker ?? 1)\n\t\t\t\t\t: 1;\n\t\t\tconst totalWorkersToSpawn =\n\t\t\t\targs.command === 'server'\n\t\t\t\t\t? // Account for the initial worker which is discarded by the server after setup.\n\t\t\t\t\t\ttargetWorkerCount + 1\n\t\t\t\t\t: targetWorkerCount;\n\n\t\t\t// Process IDs appear to be defined as `int` in Emscripten:\n\t\t\t// https://github.com/emscripten-core/emscripten/blob/95d2bf9c5c27b88ab7de6eba2d8e61ea1af977ac/system/lib/libc/musl/arch/emscripten/bits/alltypes.h#L290\n\t\t\t// and those are typically 32 bits wide in both 32-bit and 64-bit systems.\n\t\t\t// Apparently, this is a signed type, so we cannot use the leftmost bit.\n\t\t\tconst maxValueForSigned32BitInteger = 2 ** (32 - 1) - 1;\n\t\t\tconst maxProcessIdValue = maxValueForSigned32BitInteger;\n\t\t\tconst processIdSpaceLength = Math.floor(\n\t\t\t\tmaxProcessIdValue / totalWorkersToSpawn\n\t\t\t);\n\n\t\t\t/*\n\t\t\t * Use a real temp dir as a target for the following Playground paths\n\t\t\t * so that multiple worker threads can share the same files.\n\t\t\t *  - /internal\n\t\t\t *  - /tmp\n\t\t\t *  - /wordpress\n\t\t\t *\n\t\t\t * Sharing the same files leads to faster boot times and uses less memory\n\t\t\t * because we don't have to create or maintain multiple copies of the same files.\n\t\t\t */\n\t\t\tconst tempDirNameDelimiter = '-playground-cli-site-';\n\t\t\tconst nativeDir =\n\t\t\t\tawait createPlaygroundCliTempDir(tempDirNameDelimiter);\n\t\t\tlogger.debug(`Native temp dir for VFS root: ${nativeDir.path}`);\n\n\t\t\tconst IDEConfigName = 'WP Playground CLI - Listen for Xdebug';\n\n\t\t\t// Always clean up any existing Playground files symlink in the project root.\n\t\t\tconst symlinkName = '.playground-xdebug-root';\n\t\t\tconst symlinkPath = path.join(process.cwd(), symlinkName);\n\n\t\t\tawait removeTempDirSymlink(symlinkPath);\n\n\t\t\t// Then, if xdebug, and experimental IDE are enabled,\n\t\t\t// recreate the symlink pointing to the temporary\n\t\t\t// directory and add the new IDE config.\n\t\t\tif (args.xdebug && args.experimentalUnsafeIdeIntegration) {\n\t\t\t\tawait createTempDirSymlink(\n\t\t\t\t\tnativeDir.path,\n\t\t\t\t\tsymlinkPath,\n\t\t\t\t\tprocess.platform\n\t\t\t\t);\n\n\t\t\t\tconst symlinkMount: Mount = {\n\t\t\t\t\thostPath: path.join('.', path.sep, symlinkName),\n\t\t\t\t\tvfsPath: '/',\n\t\t\t\t};\n\n\t\t\t\ttry {\n\t\t\t\t\t// NOTE: Both the 'clear' and 'add' operations can throw errors.\n\t\t\t\t\tawait clearXdebugIDEConfig(IDEConfigName, process.cwd());\n\n\t\t\t\t\tconst xdebugOptions =\n\t\t\t\t\t\ttypeof args.xdebug === 'object'\n\t\t\t\t\t\t\t? args.xdebug\n\t\t\t\t\t\t\t: undefined;\n\t\t\t\t\tconst modifiedConfig = await addXdebugIDEConfig({\n\t\t\t\t\t\tname: IDEConfigName,\n\t\t\t\t\t\thost: host,\n\t\t\t\t\t\tport: port,\n\t\t\t\t\t\tides: args.experimentalUnsafeIdeIntegration!,\n\t\t\t\t\t\tcwd: process.cwd(),\n\t\t\t\t\t\tmounts: [\n\t\t\t\t\t\t\tsymlinkMount,\n\t\t\t\t\t\t\t...(args['mount-before-install'] || []),\n\t\t\t\t\t\t\t...(args.mount || []),\n\t\t\t\t\t\t],\n\t\t\t\t\t\tideKey: xdebugOptions?.ideKey,\n\t\t\t\t\t});\n\n\t\t\t\t\t// Display IDE-specific instructions\n\t\t\t\t\tconst ides = args.experimentalUnsafeIdeIntegration;\n\t\t\t\t\tconst hasVSCode = ides.includes('vscode');\n\t\t\t\t\tconst hasPhpStorm = ides.includes('phpstorm');\n\t\t\t\t\tconst configFiles = Object.values(modifiedConfig);\n\n\t\t\t\t\tconsole.log('');\n\n\t\t\t\t\tif (configFiles.length > 0) {\n\t\t\t\t\t\tconsole.log(bold(`Xdebug configured successfully`));\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\thighlight(`Updated IDE config: `) +\n\t\t\t\t\t\t\t\tconfigFiles.join(' ')\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\thighlight('Playground source root: ') +\n\t\t\t\t\t\t\t\t`.playground-xdebug-root` +\n\t\t\t\t\t\t\t\titalic(\n\t\t\t\t\t\t\t\t\tdim(\n\t\t\t\t\t\t\t\t\t\t` – you can set breakpoints and preview Playground's VFS structure in there.`\n\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(bold(`Xdebug configuration failed.`));\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'No IDE-specific project settings directory was found in the current working directory.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log('');\n\n\t\t\t\t\tif (hasVSCode && modifiedConfig['vscode']) {\n\t\t\t\t\t\tconsole.log(bold('VS Code / Cursor instructions:'));\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  1. Ensure you have installed an IDE extension for PHP Debugging'\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t`     (The ${bold('PHP Debug')} extension by ${bold(\n\t\t\t\t\t\t\t\t'Xdebug'\n\t\t\t\t\t\t\t)} has been a solid option)`\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  2. Open the Run and Debug panel on the left sidebar'\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t`  3. Select \"${italic(\n\t\t\t\t\t\t\t\tIDEConfigName\n\t\t\t\t\t\t\t)}\" from the dropdown`\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log('  3. Click \"start debugging\"');\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  5. Set a breakpoint. For example, in .playground-xdebug-root/wordpress/index.php'\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  6. Visit Playground in your browser to hit the breakpoint'\n\t\t\t\t\t\t);\n\t\t\t\t\t\tif (hasPhpStorm) {\n\t\t\t\t\t\t\tconsole.log('');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (hasPhpStorm && modifiedConfig['phpstorm']) {\n\t\t\t\t\t\tconsole.log(bold('PhpStorm instructions:'));\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t`  1. Choose \"${italic(\n\t\t\t\t\t\t\t\tIDEConfigName\n\t\t\t\t\t\t\t)}\" debug configuration in the toolbar`\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log('  2. Click the debug button (bug icon)`');\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  3. Set a breakpoint. For example, in .playground-xdebug-root/wordpress/index.php'\n\t\t\t\t\t\t);\n\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t'  4. Visit Playground in your browser to hit the breakpoint'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log('');\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthrow new Error('Could not configure Xdebug', {\n\t\t\t\t\t\tcause: error,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// We do not know the system temp dir,\n\t\t\t// but we can try to infer from the location of the current temp dir.\n\t\t\tconst tempDirRoot = path.dirname(nativeDir.path);\n\n\t\t\tconst twoDaysInMillis = 2 * 24 * 60 * 60 * 1000;\n\t\t\tconst tempDirStaleAgeInMillis = twoDaysInMillis;\n\n\t\t\t// NOTE: This is an async operation, but we do not care to block on it.\n\t\t\t// Let's let the cleanup happen as the main thread has time.\n\t\t\tcleanupStalePlaygroundTempDirs(\n\t\t\t\ttempDirNameDelimiter,\n\t\t\t\ttempDirStaleAgeInMillis,\n\t\t\t\ttempDirRoot\n\t\t\t);\n\n\t\t\t// NOTE: We do not add mount declarations for /internal here\n\t\t\t// because it will be mounted as part of php-wasm init.\n\t\t\tconst nativeInternalDirPath = path.join(nativeDir.path, 'internal');\n\t\t\tmkdirSync(nativeInternalDirPath);\n\n\t\t\tconst userProvidableNativeSubdirs = [\n\t\t\t\t'wordpress',\n\t\t\t\t// Note: These dirs are from Emscripten's \"default dirs\" list:\n\t\t\t\t// https://github.com/emscripten-core/emscripten/blob/f431ec220e472e1f8d3db6b52fe23fb377facf30/src/lib/libfs.js#L1400-L1402\n\t\t\t\t//\n\t\t\t\t// Any Playground process with multiple workers may assume\n\t\t\t\t// these are part of a shared filesystem, so let's recognize\n\t\t\t\t// them explicitly here.\n\t\t\t\t'tmp',\n\t\t\t\t'home',\n\t\t\t];\n\n\t\t\tfor (const subdirName of userProvidableNativeSubdirs) {\n\t\t\t\tconst isMountingSubdirName = (mount: Mount) =>\n\t\t\t\t\tmount.vfsPath === `/${subdirName}`;\n\t\t\t\tconst thisSubdirHasAMount =\n\t\t\t\t\targs['mount-before-install']?.some(isMountingSubdirName) ||\n\t\t\t\t\targs['mount']?.some(isMountingSubdirName);\n\t\t\t\tif (!thisSubdirHasAMount) {\n\t\t\t\t\t// The user hasn't requested mounting a different native dir for this path,\n\t\t\t\t\t// so let's create a mount from within our native temp dir.\n\t\t\t\t\tconst nativeSubdirPath = path.join(\n\t\t\t\t\t\tnativeDir.path,\n\t\t\t\t\t\tsubdirName\n\t\t\t\t\t);\n\t\t\t\t\tmkdirSync(nativeSubdirPath);\n\n\t\t\t\t\tif (args['mount-before-install'] === undefined) {\n\t\t\t\t\t\targs['mount-before-install'] = [];\n\t\t\t\t\t}\n\n\t\t\t\t\t// Make the real mount first so any further subdirs are mounted into it.\n\t\t\t\t\targs['mount-before-install'].unshift({\n\t\t\t\t\t\tvfsPath: `/${subdirName}`,\n\t\t\t\t\t\thostPath: nativeSubdirPath,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (args['mount-before-install']) {\n\t\t\t\tfor (const mount of args['mount-before-install']) {\n\t\t\t\t\tlogger.debug(\n\t\t\t\t\t\t`Mount before WP install: ${mount.vfsPath} -> ${mount.hostPath}`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (args['mount']) {\n\t\t\t\tfor (const mount of args['mount']) {\n\t\t\t\t\tlogger.debug(\n\t\t\t\t\t\t`Mount after WP install: ${mount.vfsPath} -> ${mount.hostPath}`\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet handler: BlueprintsV1Handler | BlueprintsV2Handler;\n\t\t\tif (args['experimental-blueprints-v2-runner']) {\n\t\t\t\thandler = new BlueprintsV2Handler(args, {\n\t\t\t\t\tsiteUrl,\n\t\t\t\t\tprocessIdSpaceLength,\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\thandler = new BlueprintsV1Handler(args, {\n\t\t\t\t\tsiteUrl,\n\t\t\t\t\tprocessIdSpaceLength,\n\t\t\t\t});\n\n\t\t\t\tif (typeof args.blueprint === 'string') {\n\t\t\t\t\targs.blueprint = await resolveBlueprint({\n\t\t\t\t\t\tsourceString: args.blueprint,\n\t\t\t\t\t\tblueprintMayReadAdjacentFiles:\n\t\t\t\t\t\t\targs['blueprint-may-read-adjacent-files'] === true,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Remember whether we are already disposing so we can avoid:\n\t\t\t// - we can avoid multiple, conflicting dispose attempts\n\t\t\t// - logging that a worker exited while the CLI itself is exiting\n\t\t\tlet disposing = false;\n\t\t\tconst disposeCLI = async function disposeCLI() {\n\t\t\t\tif (disposing) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tdisposing = true;\n\t\t\t\tawait Promise.all(\n\t\t\t\t\t[...playgroundsToCleanUp].map(\n\t\t\t\t\t\tasync ([worker, playground]) => {\n\t\t\t\t\t\t\tawait playground.dispose();\n\t\t\t\t\t\t\tawait worker.terminate();\n\t\t\t\t\t\t}\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tif (server) {\n\t\t\t\t\tawait new Promise((resolve) => server.close(resolve));\n\t\t\t\t}\n\t\t\t\tawait nativeDir.cleanup();\n\t\t\t};\n\n\t\t\t// Kick off worker threads now to save time later.\n\t\t\t// There is no need to wait for other async processes to complete.\n\t\t\tconst promisedWorkers = spawnWorkerThreads(\n\t\t\t\ttotalWorkersToSpawn,\n\t\t\t\thandler.getWorkerType(),\n\t\t\t\t({ exitCode, workerIndex }) => {\n\t\t\t\t\t// We are already disposing, so worker exit is expected\n\t\t\t\t\t// and does not need to be logged.\n\t\t\t\t\tif (disposing) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (exitCode !== 0) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tlogger.error(\n\t\t\t\t\t\t`Worker ${workerIndex} exited with code ${exitCode}\\n`\n\t\t\t\t\t);\n\t\t\t\t\t// @TODO: Should we respawn the worker if it exited with an error and the CLI is not shutting down?\n\t\t\t\t}\n\t\t\t);\n\n\t\t\tlogger.log(`Starting up workers`);\n\n\t\t\ttry {\n\t\t\t\tconst workers = await promisedWorkers;\n\n\t\t\t\tconst fileLockManagerPort =\n\t\t\t\t\tawait exposeFileLockManager(fileLockManager);\n\n\t\t\t\t// NOTE: Using a free-standing block to isolate initial boot vars\n\t\t\t\t// while keeping the logic inline.\n\t\t\t\t{\n\t\t\t\t\t// Boot the primary worker using the handler\n\t\t\t\t\tconst initialWorker = workers.shift()!;\n\t\t\t\t\tconst initialPlayground =\n\t\t\t\t\t\tawait handler.bootAndSetUpInitialPlayground(\n\t\t\t\t\t\t\tinitialWorker.phpPort,\n\t\t\t\t\t\t\tfileLockManagerPort,\n\t\t\t\t\t\t\tnativeInternalDirPath\n\t\t\t\t\t\t);\n\t\t\t\t\tplaygroundsToCleanUp.set(\n\t\t\t\t\t\tinitialWorker.worker,\n\t\t\t\t\t\tinitialPlayground\n\t\t\t\t\t);\n\n\t\t\t\t\tawait initialPlayground.isReady();\n\t\t\t\t\twordPressReady = true;\n\t\t\t\t\tlogger.log(`Booted!`);\n\n\t\t\t\t\tloadBalancer = new LoadBalancer(initialPlayground);\n\n\t\t\t\t\tif (!args['experimental-blueprints-v2-runner']) {\n\t\t\t\t\t\tconst compiledBlueprint = await (\n\t\t\t\t\t\t\thandler as BlueprintsV1Handler\n\t\t\t\t\t\t).compileInputBlueprint(\n\t\t\t\t\t\t\targs['additional-blueprint-steps'] || []\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\tif (compiledBlueprint) {\n\t\t\t\t\t\t\tlogger.log(`Running the Blueprint...`);\n\t\t\t\t\t\t\tawait runBlueprintV1Steps(\n\t\t\t\t\t\t\t\tcompiledBlueprint,\n\t\t\t\t\t\t\t\tinitialPlayground as UniversalPHP\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tlogger.log(`Finished running the blueprint`);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (args.command === 'build-snapshot') {\n\t\t\t\t\t\tawait zipSite(playground, args.outfile as string);\n\t\t\t\t\t\tlogger.log(`WordPress exported to ${args.outfile}`);\n\t\t\t\t\t\tawait disposeCLI();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t} else if (args.command === 'run-blueprint') {\n\t\t\t\t\t\tlogger.log(`Blueprint executed`);\n\t\t\t\t\t\tawait disposeCLI();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// We discard the initial Playground worker because it can\n\t\t\t\t\t// be configured differently than post-boot workers.\n\t\t\t\t\t// For example, we do not enable Xdebug by default for the initial worker.\n\t\t\t\t\tawait loadBalancer.removeWorker(initialPlayground);\n\t\t\t\t\tawait initialPlayground.dispose();\n\t\t\t\t\tawait initialWorker.worker.terminate();\n\t\t\t\t\tplaygroundsToCleanUp.delete(initialWorker.worker);\n\t\t\t\t}\n\n\t\t\t\tlogger.log(`Preparing workers...`);\n\n\t\t\t\t// Boot additional workers using the handler\n\t\t\t\tconst initialWorkerProcessIdSpace = processIdSpaceLength;\n\t\t\t\t// Just take the first Playground instance to be returned to the caller.\n\t\t\t\t[playground] = await Promise.all(\n\t\t\t\t\tworkers.map(async (worker, index) => {\n\t\t\t\t\t\tconst firstProcessId =\n\t\t\t\t\t\t\tinitialWorkerProcessIdSpace +\n\t\t\t\t\t\t\tindex * processIdSpaceLength;\n\n\t\t\t\t\t\tconst fileLockManagerPort =\n\t\t\t\t\t\t\tawait exposeFileLockManager(fileLockManager);\n\n\t\t\t\t\t\tconst additionalPlayground =\n\t\t\t\t\t\t\tawait handler.bootPlayground({\n\t\t\t\t\t\t\t\tworker,\n\t\t\t\t\t\t\t\tfileLockManagerPort,\n\t\t\t\t\t\t\t\tfirstProcessId,\n\t\t\t\t\t\t\t\tnativeInternalDirPath,\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\tplaygroundsToCleanUp.set(\n\t\t\t\t\t\t\tworker.worker,\n\t\t\t\t\t\t\tadditionalPlayground\n\t\t\t\t\t\t);\n\t\t\t\t\t\tloadBalancer.addWorker(additionalPlayground);\n\n\t\t\t\t\t\treturn additionalPlayground;\n\t\t\t\t\t})\n\t\t\t\t);\n\n\t\t\t\tlogger.log(\n\t\t\t\t\t`WordPress is running on ${serverUrl} with ${targetWorkerCount} worker(s)`\n\t\t\t\t);\n\n\t\t\t\tif (args.xdebug && args.experimentalDevtools) {\n\t\t\t\t\tconst bridge = await startBridge({\n\t\t\t\t\t\tphpInstance: playground,\n\t\t\t\t\t\tphpRoot: '/wordpress',\n\t\t\t\t\t});\n\n\t\t\t\t\tbridge.start();\n\t\t\t\t}\n\n\t\t\t\treturn {\n\t\t\t\t\tplayground,\n\t\t\t\t\tserver,\n\t\t\t\t\tserverUrl,\n\t\t\t\t\t[Symbol.asyncDispose]: disposeCLI,\n\t\t\t\t\t[internalsKeyForTesting]: {\n\t\t\t\t\t\tworkerThreadCount: targetWorkerCount,\n\t\t\t\t\t\tgetWorkerNumberFromProcessId: (processId: number) => {\n\t\t\t\t\t\t\treturn Math.floor(processId / processIdSpaceLength);\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t} catch (error) {\n\t\t\t\tif (!args.debug) {\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t\tlet phpLogs = '';\n\t\t\t\tif (await playground?.fileExists(errorLogPath)) {\n\t\t\t\t\tphpLogs = await playground.readFileAsText(errorLogPath);\n\t\t\t\t}\n\t\t\t\tawait disposeCLI();\n\t\t\t\tthrow new Error(phpLogs, { cause: error });\n\t\t\t}\n\t\t},\n\t\tasync handleRequest(request: PHPRequest) {\n\t\t\tif (!wordPressReady) {\n\t\t\t\treturn PHPResponse.forHttpCode(\n\t\t\t\t\t502,\n\t\t\t\t\t'WordPress is not ready yet'\n\t\t\t\t);\n\t\t\t}\n\t\t\t// Clear the playground_auto_login_already_happened cookie on the first request.\n\t\t\t// Otherwise the first Playground CLI server started on the machine will set it,\n\t\t\t// all the subsequent runs will get the stale cookie, and the auto-login will\n\t\t\t// assume they don't have to auto-login again.\n\t\t\tif (isFirstRequest) {\n\t\t\t\tisFirstRequest = false;\n\t\t\t\tconst headers: Record<string, string[]> = {\n\t\t\t\t\t'Content-Type': ['text/plain'],\n\t\t\t\t\t'Content-Length': ['0'],\n\t\t\t\t\tLocation: [request.url],\n\t\t\t\t};\n\t\t\t\tif (\n\t\t\t\t\trequest.headers?.['cookie']?.includes(\n\t\t\t\t\t\t'playground_auto_login_already_happened'\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\theaders['Set-Cookie'] = [\n\t\t\t\t\t\t'playground_auto_login_already_happened=1; Max-Age=0; Expires=Thu, 01 Jan 1970 00:00:00 GMT; Path=/',\n\t\t\t\t\t];\n\t\t\t\t}\n\t\t\t\treturn new PHPResponse(302, headers, new Uint8Array());\n\t\t\t}\n\t\t\treturn await loadBalancer.handleRequest(request);\n\t\t},\n\t});\n}\n\nexport type SpawnedWorker = {\n\tworker: Worker;\n\tphpPort: NodeMessagePort;\n};\n\nasync function spawnWorkerThreads(\n\tcount: number,\n\tworkerType: WorkerType,\n\tonWorkerExit: (options: { exitCode: number; workerIndex: number }) => void\n): Promise<SpawnedWorker[]> {\n\tconst promises = [];\n\tfor (let i = 0; i < count; i++) {\n\t\tconst onExit: (code: number) => void = (code: number) => {\n\t\t\tonWorkerExit({\n\t\t\t\texitCode: code,\n\t\t\t\tworkerIndex: i,\n\t\t\t});\n\t\t};\n\t\tconst worker = spawnWorkerThread(workerType, { onExit });\n\t\tpromises.push(worker);\n\t}\n\treturn Promise.all(promises);\n}\n\n/**\n * A statically analyzable function that spawns a worker thread of a given type.\n *\n * **Important:** This function builds to code that has the worker URL hardcoded\n * inline, e.g. `new Worker(new URL('./worker-thread-v1.js', import.meta.url))`.\n * This allows the downstream consumers to statically analyze the code, recognize\n * it uses workers, create new entrypoints, and rewrite the new Worker() calls.\n *\n * @param workerType\n * @returns\n */\nexport function spawnWorkerThread(\n\tworkerType: 'v1' | 'v2',\n\t{ onExit }: { onExit?: (code: number) => void } = {}\n) {\n\t/**\n\t * When running the CLI from source via `node cli.ts`, the Vite-provided\n\t * __WORKER_V1_URL__ and __WORKER_V2_URL__ are undefined. Let's set them to\n\t * the correct paths.\n\t */\n\tif (typeof __WORKER_V1_URL__ === 'undefined') {\n\t\t// @ts-expect-error\n\t\tglobalThis['__WORKER_V1_URL__'] = './blueprints-v1/worker-thread-v1.ts';\n\t}\n\tif (typeof __WORKER_V2_URL__ === 'undefined') {\n\t\t// @ts-expect-error\n\t\tglobalThis['__WORKER_V2_URL__'] = './blueprints-v2/worker-thread-v2.ts';\n\t}\n\tlet worker: Worker;\n\tif (workerType === 'v1') {\n\t\tworker = new Worker(new URL(__WORKER_V1_URL__, import.meta.url));\n\t} else {\n\t\tworker = new Worker(new URL(__WORKER_V2_URL__, import.meta.url));\n\t}\n\n\treturn new Promise<SpawnedWorker>((resolve, reject) => {\n\t\tworker.once('message', function (message: any) {\n\t\t\t// Let the worker confirm it has initialized.\n\t\t\t// We could use the 'online' event to detect start of JS execution,\n\t\t\t// but that would miss initialization errors.\n\t\t\tif (message.command === 'worker-script-initialized') {\n\t\t\t\tresolve({ worker, phpPort: message.phpPort });\n\t\t\t}\n\t\t});\n\t\tworker.once('error', function (e: Error) {\n\t\t\tconsole.error(e);\n\t\t\tconst error = new Error(\n\t\t\t\t`Worker failed to load worker. ${\n\t\t\t\t\te.message ? `Original error: ${e.message}` : ''\n\t\t\t\t}`\n\t\t\t);\n\t\t\treject(error);\n\t\t});\n\t\tlet spawned = false;\n\t\tworker.once('spawn', () => {\n\t\t\tspawned = true;\n\t\t});\n\t\tworker.once('exit', (code) => {\n\t\t\tif (!spawned) {\n\t\t\t\treject(new Error(`Worker exited before spawning: ${code}`));\n\t\t\t}\n\t\t\tonExit?.(code);\n\t\t});\n\t});\n}\n\n/**\n * Expose the file lock manager API on a MessagePort and return it.\n *\n * @see comlink-sync.ts\n * @see phpwasm-emscripten-library-file-locking-for-node.js\n */\nasync function exposeFileLockManager(fileLockManager: FileLockManagerForNode) {\n\tconst { port1, port2 } = new NodeMessageChannel();\n\tif (await jspi()) {\n\t\t/**\n\t\t * When JSPI is available, the worker thread expects an asynchronous API.\n\t\t *\n\t\t * @see worker-thread.ts\n\t\t * @see comlink-sync.ts\n\t\t * @see phpwasm-emscripten-library-file-locking-for-node.js\n\t\t */\n\t\texposeAPI(fileLockManager, null, port1);\n\t} else {\n\t\t/**\n\t\t * When JSPI is not available, the worker thread expects a synchronous API.\n\t\t *\n\t\t * @see worker-thread.ts\n\t\t * @see comlink-sync.ts\n\t\t * @see phpwasm-emscripten-library-file-locking-for-node.js\n\t\t */\n\t\tawait exposeSyncAPI(fileLockManager, port1);\n\t}\n\treturn port2;\n}\n\nasync function zipSite(\n\tplayground: RemoteAPI<PlaygroundCliWorker>,\n\toutfile: string\n) {\n\tawait playground.run({\n\t\tcode: `<?php\n\t\t$zip = new ZipArchive();\n\t\tif(false === $zip->open('/tmp/build.zip', ZipArchive::CREATE | ZipArchive::OVERWRITE)) {\n\t\t\tthrow new Exception('Failed to create ZIP');\n\t\t}\n\t\t$files = new RecursiveIteratorIterator(\n\t\t\tnew RecursiveDirectoryIterator('/wordpress')\n\t\t);\n\t\tforeach ($files as $file) {\n\t\t\techo $file . PHP_EOL;\n\t\t\tif (!$file->isFile()) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t$zip->addFile($file->getPathname(), $file->getPathname());\n\t\t}\n\t\t$zip->close();\n\n\t`,\n\t});\n\tconst zip = await playground.readFileAsBuffer('/tmp/build.zip');\n\tfs.writeFileSync(outfile, zip);\n}\n"],"names":["parseMountWithDelimiterArguments","mounts","parsedMounts","mount","mountParts","hostPath","vfsPath","existsSync","parseMountDirArguments","i","source","path","mountResources","php","createNodeFsMountHandler","ACTIVATE_FIRST_THEME_STEP","expandAutoMounts","args","mountBeforeInstall","newArgs","isPluginFilename","pluginName","basename","isThemeDirectory","themeName","containsWpContentDirectories","files","fs","file","containsFullWordPressInstallation","styleCssContent","join","pluginNameRegex","fileContent","startServer","options","app","express","server","resolve","reject","address","req","res","phpResponse","parseHeaders","bufferRequestBody","error","logger","PHPResponse","key","port","body","chunk","requestHeaders","LoadBalancer","initialWorker","worker","workerIndex","workerLoad","removedWorker","request","smallestWorkerLoad","promiseForResponse","isValidWordPressSlug","version","resolveBlueprint","sourceString","blueprintMayReadAdjacentFiles","resolveRemoteBlueprint","blueprintPath","stat","extension","ZipFilesystem","blueprintText","contextPath","nodeJsFilesystem","NodeJsFilesystem","OverlayFilesystem","InMemoryFilesystem","shouldRenderProgress","writeStream","BlueprintsV2Handler","phpPort","fileLockManagerPort","nativeInternalDirPath","playground","consumeAPI","workerBootArgs","firstProcessId","message","finalUpdate","CACHE_FOLDER","os","fetchSqliteIntegration","monitor","cachedDownload","remoteUrl","cacheKey","artifactPath","downloadTo","readAsFile","localPath","reader","tmpPath","writer","done","value","err","fileName","BlueprintsV1Handler","wpDetails","wordPressZip","preinstalledWpContentPath","EmscriptenDownloadMonitor","progressReached100","e","loaded","total","percentProgress","resolveWordPressRelease","sqliteIntegrationPluginZip","followSymlinks","trace","mountsBeforeWpInstall","mountsAfterWpInstall","runtimeConfiguration","resolveRuntimeConfiguration","zipDirectory","additionalBlueprintSteps","blueprint","tracker","ProgressTracker","lastCaption","progressInteger","compileBlueprintV1","resolvedBlueprint","isBlueprintBundle","RecommendedPHPVersion","LogVerbosity","createPlaygroundCliTempDir","substrToIdentifyTempDirs","autoCleanup","tempDirPrefix","nativeDir","tmpDir","tmpSetGracefulCleanup","cleanupStalePlaygroundTempDirs","staleAgeInMillis","tempRootDir","promisesToRemove","findStalePlaygroundTempDirs","stalePlaygroundTempDir","tempPaths","dirName","stalePlaygroundTempDirs","tempPath","appearsToBeStalePlaygroundTempDir","absolutePath","match","info","doesProcessExist","STALE_DATE","pid","executableName","existingProcess","ps","processes","LogSeverity","parseOptionsAndRunCLI","argsToParse","sharedOptions","SupportedPHPVersions","verbosity","serverOnlyOptions","cpus","buildSnapshotOnlyOptions","yargsObject","yargs","yargsInstance","msg","siteUrlArg","autoMountIsDir","allow","command","cliArgs","cliServer","runCLI","cleanUpCliAndExit","promiseToCleanup","printDebugDetails","messageChain","currentError","internalsKeyForTesting","bold","text","dim","italic","highlight","loadBalancer","playgroundsToCleanUp","severity","v","selectedPort","nativeFlockSync","m","fileLockManager","FileLockManagerForNode","wordPressReady","isFirstRequest","host","serverUrl","siteUrl","targetWorkerCount","totalWorkersToSpawn","maxProcessIdValue","processIdSpaceLength","tempDirNameDelimiter","IDEConfigName","symlinkName","symlinkPath","removeTempDirSymlink","createTempDirSymlink","symlinkMount","clearXdebugIDEConfig","xdebugOptions","modifiedConfig","addXdebugIDEConfig","ides","hasVSCode","hasPhpStorm","configFiles","tempDirRoot","tempDirStaleAgeInMillis","mkdirSync","userProvidableNativeSubdirs","subdirName","isMountingSubdirName","nativeSubdirPath","handler","disposing","disposeCLI","promisedWorkers","spawnWorkerThreads","exitCode","workers","exposeFileLockManager","initialPlayground","compiledBlueprint","runBlueprintV1Steps","zipSite","initialWorkerProcessIdSpace","index","additionalPlayground","startBridge","processId","phpLogs","errorLogPath","headers","count","workerType","onWorkerExit","promises","spawnWorkerThread","code","onExit","Worker","_documentCurrentScript","spawned","port1","port2","NodeMessageChannel","jspi","exposeAPI","exposeSyncAPI","outfile","zip"],"mappings":"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"}